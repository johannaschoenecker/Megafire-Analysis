---
title: "Megafire_additional_plots"
author: "Johanna Schoenecker"
format: html
editor: visual
---
##Packages

```{r Loading packages}
# -------------------------------------------------------------------
# Load required packages
# -------------------------------------------------------------------
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  tidyr, raster, rgdal, ggplot2, ggspatial, sp, sf, rgeos, reshape,
  patchwork, Rcpp, scales, dplyr, ggpubr, landscapemetrics, landscapetools,
  here, stringr, moments, reshape2, ggeasy, vctrs, mgcv, networkD3,
  ggridges, cowplot, factoextra, gdistance, fs, data.table, terra,
  gridExtra, grid, car, biscale, e1071
)

```

##Data loading and prep

```{r}
#Fire level datasets
fire_metrics_mega <- fread(paste0(here(),"/Data/SN_megafires_1985_2023.csv"), header=TRUE)

#Patch level datasets- rdnbr
patch_metrics_mega <- fread(paste0(here(),"/Data/SN_patch_metrics_mega_rdnbr_1985_2023.csv"))

megafire_IDs <- c(5529, 5718, 5721, 8026, 7808, 7747, 7996, 7961, 
                   7412, 7514, 7242, 9714, 9724, 9487, 8985, 9039, 
                   8747, 10495, 10498, 10504, 10094, 10273, 1819, 1772, 
                   2111, 2140, 1210, 1211, 1216, 1215, 1220, 1319, 
                   1315, 718, 911, 932, 869, 888, 945, 959, 504, 
                   3363, 3567, 3573, 3574, 3051, 3094, 3188, 2706, 
                   2147, 2531, 2415, 2618, 5207, 5309, 4277, 4285, 
                   4306, 4380, 4386, 4374, 4500, 3983, 3992)
```

# Vegetation histograms

# Proportion veg/severity


```{r}
# For individual fires
pixel_df <- fread(paste0(here(),"/Data/raster_df_mega_repeated_planting/3567.csv"), header=TRUE)  

pixels_only_veg <- subset(pixel_df, RF_pre_veg %in% c("1", "4", "5","7","8", "9")) 

pixels_only_veg$RF_pre_veg <- as.factor(pixels_only_veg$RF_pre_veg)

# Colors for cover types
colors_all <- c('1' = '#956733', '2' = '#a7b5a5', '3' = '#0940ca', '4' = '#d8bf58', '5' = '#6dcd2b', '6' = '#ffacc9', '7' = '#0e4f12', '8' = '#7b8d6a', '9' = '#e97451')

# -------------------------------------------------------------------------------------------------


# Plot prop veg type by severity 

print(unique(pixel_df$RF_pre_veg))

# Calculate the proportions of RF_pre_veg within each rdnbr_class
pixel_df_summary <- pixel_df %>%
  group_by(rdnbr_class, RF_pre_veg) %>%
  summarise(count = n()) %>%
  mutate(proportion = count / sum(count)) %>%
  ungroup()

pixel_df_summary$RF_pre_veg <- as.factor(pixel_df_summary$RF_pre_veg)  

# Create the stacked bar chart with custom colors
ggplot(pixel_df_summary, aes(x = rdnbr_class, y = proportion, fill = RF_pre_veg)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = colors_all) +
  labs(title = "",
       x = "Burn severity class [RdNBR]",
       y = "Proportion",
       fill = "RF_pre_veg") +
  theme_minimal()
```


# All megafires

```{r}
# Colors for cover types
colors_all <- c('1' = '#956733', '2' = '#a7b5a5', '3' = '#0940ca', '4' = '#d8bf58', '5' = '#6dcd2b', '6' = '#ffacc9', '7' = '#0e4f12', '8' = '#7b8d6a', '9' = '#e97451')

# Create empty dataframe

veg_sev_counts_master <- data.frame(
  rdnbr_class = integer(),
  RF_pre_veg = factor(),
  count=integer(),
  proportion = numeric(),
  OBJECTID = integer()
)

# -------------------------------------------------------------------------------------------------

for (num in megafire_IDs){
  
pixel_filename <- paste0(here(),"/Data/raster_df_mega_repeated_planting/",num,".csv")
pixel_df <- fread(pixel_filename, header=TRUE)  


# Calculate the proportions of RF_pre_veg within each rdnbr_class
pixel_df_summary <- pixel_df %>%
  group_by(rdnbr_class, RF_pre_veg) %>%
  summarise(count = n()) %>%
  mutate(proportion = count / sum(count)) %>%
  ungroup()

pixel_df_summary$RF_pre_veg <- as.factor(pixel_df_summary$RF_pre_veg)  
pixel_df_summary$OBJECTID <-num

veg_sev_counts_master <- rbind(veg_sev_counts_master, pixel_df_summary)}





# Calculate the proportions of RF_pre_veg within each rdnbr_class
veg_sev_counts_summary <- veg_sev_counts_master %>%
  group_by(rdnbr_class, RF_pre_veg) %>%
  summarize(total_count = sum(count, na.rm = TRUE))%>%
  mutate(proportion = total_count / sum(total_count)) %>%
  ungroup()

veg_sev_counts_summary <- veg_sev_counts_summary %>%
  filter(rdnbr_class != -1)

# Create the stacked bar chart with custom colors, proportions
ggplot(veg_sev_counts_summary, aes(x = rdnbr_class, y = proportion, fill = RF_pre_veg)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = colors_all) +
  labs(title = "Stacked Bar Chart of RF_pre_veg Proportions by rdnbr_class",
       x = "RDNBR Class",
       y = "Proportion",
       fill = "RF_pre_veg") +
  theme_classic()

# Create the stacked bar chart with custom colors, absolute numbers
ggplot(veg_sev_counts_summary, aes(x = rdnbr_class, y = total_count, fill = RF_pre_veg, alpha=0.5)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = colors_all) +
  labs(title = "",
       x = "RDNBR Class",
       y = "Area",
       fill = "RF_pre_veg") +
  theme_bw()

# Only vegetation

veg_sev_counts_summary_vegOnly <- veg_sev_counts_summary %>%
  filter(RF_pre_veg %in% c("1", "4", "5","7","8","9"))

veg_sev_counts_summary_vegOnly$total_area_ha <- veg_sev_counts_summary_vegOnly$total_count*0.09

ggplot(veg_sev_counts_summary_vegOnly, aes(x = factor(rdnbr_class), y = total_area_ha, fill = RF_pre_veg)) +
  geom_bar(stat = "identity", position = "stack",alpha=1) +
scale_fill_manual(
    values = colors_all,
    name = "Pre-fire vegetation",
    labels = c("shrub","herbaceous","conifer", "sagebrush", "dense woodland", "oak woodland")
  ) +
  labs(
    title = "",
    x = "Burn severity (RdNBR)",
    y = "Area burned (ha)"
  ) +
  scale_x_discrete(
    labels = c('0' = 'unburned', '1' = 'low', '2' = 'moderate', '3' = 'high')
  ) +
  scale_y_continuous(labels = scales::comma) +  # Add thousands separators
  theme_classic() +
  theme(
    axis.title.x = element_text(margin = margin(t = 10),size=12, face='bold'),  # Add space on top of x-axis label
    axis.title.y = element_text(margin = margin(r = 10),size= 12, face='bold'),  # Add space to the right of y-axis label
    axis.text.x = element_text(angle = 0, hjust = 1,size=12),
    axis.text.y = element_text(size=12),# Angle x-axis labels to 45 degrees
    legend.position = c(0.01, 0.95),  # Move the legend inside the plot, top left
    legend.justification = c(0, 1),  # Adjust the alignment of the legend
    legend.title = element_text(size = 12), #, face = "bold"
    legend.text = element_text(size = 10),
    panel.grid = element_blank()  # Remove all gridlines
  )

```

#IGNORE Prop transitioned

```{r}
library(data.table)
library(fs)

# # Set path if using all fires, otherwise use below for only those with 20 years post-fire data
# csv_dir <- "C:/Users/jscho/Documents/Megafires-1985-2023-Data/raster_df_mega"
# 
# # List all CSV files
# csv_files <- dir(csv_dir, pattern = "\\.csv$", full.names = TRUE)

# Vector of fire IDs to include
fire_IDs <- c(10495,10498,10504,10273,10094,9714,9724,9487,8985,
              9039,8747,8026,7996,7961,7808,7747,7514,7412,7242)

# Set path
csv_dir <- "C:/Users/jscho/Documents/Megafires-1985-2023-Data/raster_df_mega_repeated_planting"

# List CSVs that match the fire IDs
csv_files <- dir(csv_dir, pattern = "\\.csv$", full.names = TRUE)
csv_files <- csv_files[basename(csv_files) %in% paste0(fire_IDs, ".csv")]


# Initialize list to store results
summary_list <- list()

# Loop through each file
for (file in csv_files) {
  # Extract OBJECTID from filename (remove directory and extension)
  object_id <- path_ext_remove(path_file(file))
  
  # Read CSV with fread
  dt <- fread(file)
  
  # Filter and summarize
  dt_filtered <- dt[RF_pre_veg == 7, .N, by = .(rdnbr_class, transitioned)]
  dt_filtered[, OBJECTID := object_id]
  
  # Append to list
  summary_list[[length(summary_list) + 1]] <- dt_filtered
}

# Combine all summaries
final_summary <- rbindlist(summary_list)

# Optional: reshape to wide format
final_summary_wide <- dcast(
  final_summary,
  OBJECTID + rdnbr_class ~ transitioned,
  value.var = "N",
  fill = 0
)

# Rename columns for clarity
setnames(final_summary_wide, c("0", "1"), c("transitioned_0", "transitioned_1"))

# View result
print(final_summary_wide)


all_fires_transitioned <- final_summary_wide

all_fires_transitioned <- all_fires_transitioned %>%
  group_by(rdnbr_class) %>%
  summarise(count_trans = sum(transitioned_1), count_no_trans = sum(transitioned_0))




library(ggplot2)
library(tidyr)
library(dplyr)


# Reshape to long format
df_long <- all_fires_transitioned %>%
  pivot_longer(cols = c(count_trans, count_no_trans),
               names_to = "transition_status",
               values_to = "count") %>%
 mutate(transition_status = dplyr::recode(transition_status,
                                         "count_trans" = "Transitioned",
                                         "count_no_trans" = "Not Transitioned"))



# Calculate total and percentage per rdnbr_class
df_long <- df_long %>%
  group_by(rdnbr_class) %>%
  mutate(total = sum(count),
         percent = 100 * count / total) %>%
  ungroup()


# Prepare labels again (no changes here)
labels_df <- df_long %>%
  group_by(rdnbr_class) %>%
  summarise(
    total = sum(count),
    percent_trans = 100 * count[transition_status == "Transitioned"] / total
  ) %>%
  mutate(
    label = paste0(round(percent_trans, 1), "%")
  )

# Define color palette (unchanged)
custom_colors <- c("Not Transitioned" = "#0e4f12", "Transitioned" = "#e67e22")

# Reorder factor explicitly before plotting
df_long$transition_status <- factor(df_long$transition_status, 
                                    levels = c("Not Transitioned", "Transitioned"))

df_long <- df_long %>%
  arrange(rdnbr_class, transition_status)


ggplot(df_long, aes(x = factor(rdnbr_class), y = count, fill = transition_status)) +
  geom_bar(stat = "identity") +
  geom_text(data = labels_df,
            aes(x = factor(rdnbr_class), y = total, label = label),
            vjust = -0.5, size = 3.5, inherit.aes = FALSE) +
  scale_fill_manual(values = custom_colors) +
  scale_x_discrete(labels = c("0" = "Unchanged", "1" = "Low", "2" = "Moderate", "3" = "High")) +
  labs(
    x = "Burn severity class",
    y = "Pixel count",
    fill = "Transition status",
    title = "Transitioned vs. Non-Transitioned Pixels by Burn Severity"
  ) +
  theme_classic()


df_long <- df_long %>%
  mutate(
    transition_status = factor(transition_status, levels = c("Not Transitioned", "Transitioned")),
    area_ha = count * 0.00009
  )

df_stacked <- df_long %>%
  arrange(rdnbr_class, transition_status) %>%
  group_by(rdnbr_class) %>%
  mutate(
    ymin = cumsum(lag(area_ha, default = 0)),
    ymax = ymin + area_ha
  )

labels_df <- df_long %>%
  group_by(rdnbr_class) %>%
  summarise(
    total_area = sum(area_ha),
    percent_trans = 100 * area_ha[transition_status == "Transitioned"] / total_area
  ) %>%
  mutate(
    label = paste0(round(percent_trans, 1), "%")
  )


ggplot(df_stacked) +
  geom_rect(aes(xmin = as.numeric(factor(rdnbr_class)) - 0.4,
                xmax = as.numeric(factor(rdnbr_class)) + 0.4,
                ymin = ymin,
                ymax = ymax,
                fill = transition_status)) +
  geom_text(data = labels_df,
            aes(x = as.numeric(factor(rdnbr_class)), y = total_area, label = label),
            vjust = -0.5, size = 3.5, inherit.aes = FALSE) +
  scale_fill_manual(values = custom_colors) +
  scale_x_continuous(breaks = 1:4, labels = c("Unchanged", "Low", "Moderate", "High")) +
  labs(
    x = "Burn severity class",
    y = "Area (1,000 x ha)",
    fill = "Post-fire transition status",
    title = ""
  ) +
  theme_classic()

```



# IGNORE Prop returned

```{r}
# Prop returned

library(data.table)
library(fs)

# Vector of fire IDs to include
fire_IDs <- c(10495,10498,10504,10273,10094,9714,9724,9487,8985,
              9039,8747,8026,7996,7961,7808,7747,7514,7412,7242)

# Set path
csv_dir <- "C:/Users/jscho/Documents/Megafires-1985-2023-Data/raster_df_mega"

# List CSVs that match the fire IDs
csv_files <- dir(csv_dir, pattern = "\\.csv$", full.names = TRUE)
csv_files <- csv_files[basename(csv_files) %in% paste0(fire_IDs, ".csv")]

# Initialize list to store summaries
summary_list <- list()

for (file in csv_files) {
  fire_id <- as.integer(gsub("\\.csv$", "", basename(file)))
  
  dt <- fread(file)
  
  # Only interested in conifer pre-fire pixels
  dt <- dt[RF_pre_veg == 7]
  
  dt <- dt[transitioned == 1]
  
  # Add recovery column
  dt[, returned_20yrs := fifelse(returned == 1 & yrs_to_return < 21, 1, 0)]
  
  # Summarize by rdnbr_class
  dt_summary <- dt[, .N, by = .(rdnbr_class, returned_20yrs)]
  dt_summary[, fire_id := fire_id]
  
  summary_list[[length(summary_list) + 1]] <- dt_summary
}

# Combine all
final_summary <- rbindlist(summary_list)

# Reshape wide
final_summary_wide <- dcast(
  final_summary,
  fire_id + rdnbr_class ~ returned_20yrs,
  value.var = "N",
  fill = 0
)

# Rename for clarity
setnames(final_summary_wide, old = c("0", "1"), new = c("not_returned", "returned"))

# Aggregate across fires
recovery_summary <- final_summary_wide %>%
  group_by(rdnbr_class) %>%
  summarise(
    count_returned = sum(returned),
    count_not_returned = sum(not_returned),
    .groups = "drop"
  )


# Prepare long format
df_long <- recovery_summary %>%
  pivot_longer(cols = c(count_returned, count_not_returned),
               names_to = "recovery_status",
               values_to = "count") %>%
 mutate(recovery_status = dplyr::recode(recovery_status,
                                "count_returned" = "Recovered ‚â§ 20 yrs",
                                "count_not_returned" = "Not Recovered"))


# Calculate area and percentages
df_long <- df_long %>%
  group_by(rdnbr_class) %>%
  mutate(
    total = sum(count),
    percent = 100 * count / total
  ) %>%
  ungroup()

df_long$area_ha <- df_long$count * 0.00009

# Calculate stacked bar coordinates
df_stacked <- df_long %>%
  arrange(rdnbr_class, recovery_status) %>%
  group_by(rdnbr_class) %>%
  mutate(
    ymin = cumsum(lag(area_ha, default = 0)),
    ymax = ymin + area_ha
  )

# Labels
labels_df <- df_long %>%
  group_by(rdnbr_class) %>%
  summarise(
    total_area = sum(area_ha),
    percent_recovered = 100 * area_ha[recovery_status == "Recovered ‚â§ 20 yrs"] / total_area
  ) %>%
  mutate(label = paste0(round(percent_recovered, 1), "%"))

# Plot
ggplot(df_stacked) +
  geom_rect(aes(xmin = as.numeric(factor(rdnbr_class)) - 0.4,
                xmax = as.numeric(factor(rdnbr_class)) + 0.4,
                ymin = ymin,
                ymax = ymax,
                fill = recovery_status)) +
  geom_text(data = labels_df,
            aes(x = as.numeric(factor(rdnbr_class)), y = total_area, label = label),
            vjust = -0.5, size = 3.5, inherit.aes = FALSE) +
  scale_fill_manual(values = c("Not Recovered" = "#d95f02", "Recovered ‚â§ 20 yrs" = "#1b9e77")) +
  scale_x_continuous(breaks = 1:4, labels = c("Unchanged", "Low", "Moderate", "High")) +
  labs(
    x = "Burn severity class",
    y = "Area (1,000 x ha)",
    fill = "Recovery within 20 years",
    title = ""
  ) +
  theme_classic()


```


#Individual burn severity map

```{r}
# Burn severity map

fire_outline <- st_read(paste0(here(),"/Data/Shapefiles/Megafires_shp_individual/2012/39327.shp"))

mega_rast_class <- rast("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/3310_SN_rdnbr_classified_individual_mega/39327.tif")

# Convert raster to data frame for ggplot
raster_df <- as.data.frame(mega_rast_class, xy = TRUE)


# Rename the raster value column (assuming single-layer raster)
colnames(raster_df)[3] <- "value"  # Renaming the value column
# Replace all -1 with 0 in the 'value' column of raster_df
raster_df <- raster_df %>%
  mutate(value = ifelse(value == -1, 0, value))

# Plot the map with shapefile and raster
map_rdnbr <- ggplot() +
  # Add shapefile (Layer 1)
  geom_sf(data = fire_outline, aes(fill = "Layer 1"), color = "black", alpha = 0.5) +  
  scale_fill_manual(
    values = c("Layer 1" = "lightgrey"),
    name = "",  # Legend title
    labels = c("KNP Complex fire")  # Custom labels
  ) +
  # Add raster layer
  geom_raster(data = raster_df, aes(x = x, y = y, fill = as.factor(value))) +
  scale_fill_manual(
    values = c("0" = "lightgrey", "1" = "#F6BE00", "2" = '#21918c', "3" = "#440154"),
    name = "Burn severity (RdNBR)",  # Custom legend title
    labels = c("unburned", "low", "moderate", "high")  # Custom labels
  ) + 
  theme_bw() +
  labs(
    title = "",
    subtitle = ""
  ) +
  theme(
    legend.position = c(0.15, 0.17),  # Position the legend
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  )+
     annotation_north_arrow(location = "br", which_north = "true", 
                         pad_x = unit(0.4, "in"), pad_y = unit(0.19, "in"),
                         style = north_arrow_fancy_orienteering) + 
  annotation_scale(location = "bl", width_hint = 0.5, style = "bar") 



# Map ohne alles

# Plot the map with shapefile and raster
map_rdnbr <- ggplot() +
  # Add shapefile (Layer 1)
  geom_sf(data = fire_outline, aes(fill = "Layer 1"), color = "black", alpha = 0.5) +  
  scale_fill_manual(
    values = c("Layer 1" = "lightgrey"),
    name = "",  # Legend title
    labels = c("KNP Complex fire")  # Custom labels
  ) +
  # Add raster layer
  geom_raster(data = raster_df, aes(x = x, y = y, fill = as.factor(value))) +
  scale_fill_manual(
    values = c("0" = "lightgrey", "1" = "#F6BE00", "2" = '#21918c', "3" = "#440154"),
    name = "Burn severity (RdNBR)",  # Custom legend title
    labels = c("unburned", "low", "moderate", "high")  # Custom labels
  ) + 
  theme_classic() +
  labs(
    title = "",
    subtitle = ""
  )



```


```{r}
#Pre-/post-fire vegetation maps

veg_rast_1pre <- rast("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/veg_annual_individual/22057/2006_22057.tif")
veg_rast_1post <- rast("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/veg_annual_individual/22057/2008_22057.tif")

# Convert raster to data frame for ggplot
raster_df <- as.data.frame(veg_rast_1pre, xy = TRUE)

# Rename the raster value column (assuming single-layer raster)
colnames(raster_df)[3] <- "value"  # Renaming the value column

ggplot() + 
  geom_sf(data = fire_outline, aes(fill = "Layer 1"), color = "black", alpha = 0.5) +  
  scale_fill_manual(
    values = c("Layer 1" = "lightgrey"),
    name = "",  # Legend title
    labels = c("KNP Complex fire")  # Custom labels
  ) +
  geom_raster(data = raster_df, aes(x = x, y = y, fill = as.factor(value))) + 
  scale_fill_manual(
    values = c('1' = '#956733', '2' = '#a7b5a5', '3' = '#0940ca', '4' = '#d8bf58', '5' = '#6dcd2b', '6' = '#ffacc9', '7' = '#0e4f12', '8' = '#7b8d6a', '9' = '#e97451'),
    name = "Vegetation type",  # Custom legend title
    labels = c("Shrub", "Rock", "Water", "Open/grassland", "Herbaceous","Barren soil","Coniferous")  # Custom labels
  ) + 
  coord_sf() +  # Use coord_sf() for spatial data
  theme_minimal() + 
  theme(
    panel.grid = element_blank(),  # Remove gridlines
    axis.title = element_blank(),  # Remove axis titles
    axis.text = element_blank(),   # Remove axis text
    axis.ticks = element_blank(),  # Remove axis ticks
    legend.position = "right",     # Place legend on the right
    legend.title = element_text(size = 12, face = "bold"),  # Customize legend title
    legend.text = element_text(size = 10),  # Customize legend text
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")  # Customize plot title
  ) +
  #ggtitle("KNP Complex Fire pre-fire vegetation types") +
  annotation_scale(location = "bl", width_hint = 0.5, style="bar")  # Add a scalebar at the bottom left




# Post-fire vegetation

# Convert raster to data frame for ggplot
raster_df <- as.data.frame(veg_rast_1post, xy = TRUE)

# Rename the raster value column (assuming single-layer raster)
colnames(raster_df)[3] <- "value"  # Renaming the value column


ggplot() + 
  geom_sf(data = fire_outline, aes(fill = "Layer 1"), color = "black", alpha = 0.5) +  
  scale_fill_manual(
    values = c("Layer 1" = "lightgrey"),
    name = "",  # Legend title
    labels = c("KNP Complex fire")  # Custom labels
  ) +
  geom_raster(data = raster_df, aes(x = x, y = y, fill = as.factor(value))) + 
  scale_fill_manual(
    values = c('1' = '#956733', '2' = '#a7b5a5', '3' = '#0940ca', '4' = '#d8bf58', '5' = '#6dcd2b', '6' = '#ffacc9', '7' = '#0e4f12', '8' = '#7b8d6a', '9' = '#e97451'),
    name = "Vegetation type",  # Custom legend title
    labels = c("Shrub", "Rock", "Water", "Open/grassland", "Herbaceous","Barren soil","Coniferous")  # Custom labels
  ) + 
  coord_sf() +  # Use coord_sf() for spatial data
  theme_minimal() + 
  theme(
    panel.grid = element_blank(),  # Remove gridlines
    axis.title = element_blank(),  # Remove axis titles
    axis.text = element_blank(),   # Remove axis text
    axis.ticks = element_blank(),  # Remove axis ticks
    legend.position = "right",     # Place legend on the right
    legend.title = element_text(size = 12, face = "bold"),  # Customize legend title
    legend.text = element_text(size = 10),  # Customize legend text
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")  # Customize plot title
  ) +
  #ggtitle("KNP Complex Fire pre-fire vegetation types") +
  annotation_scale(location = "bl", width_hint = 0.5, style="bar")  # Add a scalebar at the bottom left




```

# Recovery predictions

```{r}
### old model ###
####### For all megafires after 2002

# Load recovery predictions made with RF model

new_data_with_predictions <- fread("C:/Users/jscho/Documents/Megafires-1985-2023/all_predictions.csv")

new_data_with_predictions <- new_data_with_predictions %>%
  filter(fire_year > 2001)

# Group by fire_year and predicted_class, then summarize the counts
class_counts <- new_data_with_predictions %>%
  group_by(fire_year, predicted_class) %>%
  summarise(count = n(), .groups = "drop")

class_counts$area <- class_counts$count * 0.09


####### Read in earlier megafire files as well
# Directory containing the CSV files

directory <- "C:/Users/jscho/Documents/Megafires-1985-2023-Data/raster_df_mega_repeated_planting"

# Vector of fire IDs
fire_IDs <- c(10495,10498,10504,10273,10094,9714,9724,9487,8985,
              9039,8747,8026,7996,7961,7808,7747,7514,7412,7242)

# Get a list of all CSV files in the directory
csv_files <- list.files(directory, pattern = "\\.csv$", full.names = TRUE)

# Filter files that contain any of the megafire IDs in their filename
filtered_files <- csv_files[sapply(csv_files, function(file) {
  fire_id <- as.numeric(str_extract(basename(file), "\\d+")) # Extract numeric ID from filename
  fire_id %in% fire_IDs
})]

# Read and bind the filtered files into one dataframe
data_pre2002 <- bind_rows(lapply(filtered_files, fread))

# Filter data based on conditions
data_pre2002 <- data_pre2002 %>%
  filter(RF_pre_veg == 7) %>%
  filter(transitioned == 1) %>%
  filter(rdnbr_class == 3) %>%
  filter(tree_planting == 0) 

# Calculate additional columns
data_pre2002$years_since_fire <- data_pre2002$fire_year - data_pre2002$previous_fire_year
data_pre2002$returned[!is.na(data_pre2002$yrs_to_return) & data_pre2002$yrs_to_return > 20] <- 0

# Replace NA values in years_since_fire with 100
data_pre2002 <- data_pre2002 %>%
  mutate(years_since_fire = ifelse(is.na(years_since_fire), 100, years_since_fire))


# Group by fire_year and predicted_class, then summarize the counts
class_counts_predicted <- new_data_with_predictions %>%
  group_by(fire_year, predicted_class) %>%
  summarise(count = n(), .groups = "drop")

class_counts_predicted$type <- 'predicted'


class_counts_measured <- data_pre2002 %>%
  group_by(fire_year,returned)%>%
  summarise(count = n(), .groups = 'drop')

class_counts_measured$type <- 'measured'

class_counts_predicted <- setNames(class_counts_predicted, c("fire_year", "returned","count","type"))
class_counts_measured <- setNames(class_counts_measured, c("fire_year", "returned","count","type"))
class_counts_predicted$returned <- as.numeric(class_counts_predicted$returned)

class_counts <- rbind(class_counts_measured,class_counts_predicted)

class_counts$area <- class_counts$count * 0.09


bars_recovered <- ggplot(class_counts, aes(x = fire_year, y = area, fill = factor(returned), alpha = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("darkgrey", "darkgreen")) +  # Manually set the colors
  scale_alpha_manual(values = c(1, 0.5)) +       # Full opacity for one, semi-transparent for another
  labs(title = "",
       x = "Fire year",
       y = "Area (ha)",
       fill = "Predicted class",
       alpha = "Type") +
  scale_y_continuous(labels = comma) +   # ‚Üê Add this line for thousand separators
  xlim(c(1987,2019))+
  ylim(c(0,25000))+
  theme_pubr()




# With cumulative area curves

library(dplyr)
library(ggplot2)
library(scales)
library(ggpubr)

# Step 1: Compute cumulative sums by returned class and fire year
cumulative_area <- class_counts %>%
  group_by(returned, fire_year) %>%
  summarise(area = sum(area), .groups = "drop") %>%
  arrange(returned, fire_year) %>%
  group_by(returned) %>%
  mutate(cum_area = cumsum(area))

# Step 2: Create the original bar chart
bars_recovered <- ggplot(class_counts, aes(x = fire_year, y = area, fill = factor(returned), alpha = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  
  # Step 3: Add cumulative line
  geom_line(data = cumulative_area, 
            aes(x = fire_year, y = cum_area, color = factor(returned), group = returned),
            size = 1.2, inherit.aes = FALSE) +
  
  # Aesthetic settings
  scale_fill_manual(values = c("0" = "darkgrey", "1" = "darkgreen"),
                    labels = c("Not Recovered", "Recovered"),
                    name = "Returned") +
  scale_color_manual(values = c("0" = "darkgrey", "1" = "darkgreen"), guide = "none") +
  scale_alpha_manual(values = c("measured" = 1, "predicted" = 0.5)) +
  scale_y_continuous(labels = comma) +
  labs(
    x = "Fire Year",
    y = "Area (ha)",
    title = "",
    alpha = "Type",
    fill = "Returned"
  ) +
  theme_bw()


bars_recovered <- ggplot(class_counts, aes(x = fire_year, y = area, fill = factor(returned), alpha = type)) +
  geom_bar(stat = "identity", position = "dodge") +

  # Add cumulative line
  geom_line(data = cumulative_area, 
            aes(x = fire_year, y = cum_area, color = factor(returned), group = returned),
            size = 1.2, inherit.aes = FALSE) +

  # Manual color and alpha settings
  scale_fill_manual(values = c("0" = "darkgrey", "1" = "darkgreen"),
                    labels = c("Not Recovered", "Recovered"),
                    name = "Returned") +
  scale_color_manual(values = c("0" = "darkgrey", "1" = "darkgreen"), guide = "none") +
  scale_alpha_manual(values = c("measured" = 1, "predicted" = 0.5)) +

  # Scale y-axis by 1000 and remove scientific notation
  scale_y_continuous(
    labels = function(x) format(x / 1000, big.mark = ","),
    name = "Area (x1000 ha)"
  ) +

  # Axis titles and theme customization
  labs(
    x = "Fire year",
    title = "",
    alpha = "Type",
    fill = "Returned"
  ) +
  theme_bw() +  # start with minimal theme to remove gridlines
  theme(
    panel.grid = element_blank(),  # remove all gridlines
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 16, face = "bold"),
    legend.position = "none"  # üëà removes the legend
  )

# Step 4: Show the plot
print(bars_recovered)



  class_counts_prop <- class_counts %>%
    group_by(fire_year)%>%
    summarise(total_area = sum(area))

  merged_data <- class_counts %>%
    inner_join(class_counts_prop, by = "fire_year")

  merged_data_0 <- merged_data %>%
    filter(returned==0)

  merged_data_0$prop <- merged_data_0$area/merged_data_0$total_area


  ggplot(merged_data_0, aes(x = fire_year, y = prop)) +
    geom_point(size = 3, alpha = 0.8, color = "black") +  # Scatter plot
    geom_smooth(method = "lm", color = "black", se = TRUE) +  # Linear trendline
    labs(
      title = "Prop. severely burned conifer not recov/ pred. to recov w/in 20 yrs",
      x = "Fire year",
      y = "Proportion not recovered"
    ) +
    theme_classic() +  # Clean theme
    theme(
      text = element_text(size = 12),
      axis.text.x = element_text(hjust = 1)  # Rotate x-axis labels if needed
    )


  # Fit the linear model
  linear_model <- lm(prop ~ fire_year, data = merged_data_0)

  # Summary of the model
  summary(linear_model)


  
# Plot absolute area not recovered/ predicted to not recover over time
  
  class_counts_noreturn <- class_counts %>%
    filter(returned == 0)
  
    ggplot(class_counts_noreturn, aes(x = fire_year, y = count)) +
    geom_point(size = 3, alpha = 0.8, color = "black") +  # Scatter plot
    geom_smooth(method = "lm", color = "black", se = TRUE) +  # Linear trendline
    labs(
      title = "",
      x = "Fire year",
      y = "Proportion not recovered"
    ) +
      ylim(c(0, 700000))+
    theme_classic() +  # Clean theme
    theme(
      text = element_text(size = 12),
      axis.text.x = element_text(hjust = 1)  # Rotate x-axis labels if needed
    )
  
  # Fit the linear model
  linear_model <- lm(count ~ fire_year, data = class_counts_noreturn)

  # Summary of the model
  summary(linear_model)
  

class_counts_noreturn <- class_counts %>%
  filter(returned == 0)

ggplot(class_counts_noreturn, aes(x = fire_year, y = count)) +
  geom_point(size = 3, alpha = 0.8, color = "black") +  # Scatter plot
  geom_smooth(method = "gam", formula = y ~ s(x), color = "black", se = TRUE) +  # ‚Üê GAM here
  labs(
    title = "",
    x = "Fire year",
    y = "Area not recovered"
  ) +
  ylim(c(0, 150000)) +
  theme_classic() +
  theme(
    text = element_text(size = 12),
    axis.text.x = element_text(hjust = 1)
  )

gam_model <- gam(count ~ s(fire_year), data = class_counts_noreturn)
summary(gam_model)



#### Decadal sums of area at risk of transitioning:

class_counts_noreturn_dec1 <- class_counts_noreturn %>%
  filter(fire_year >= 1985, fire_year <= 1994)

class_counts_noreturn_dec2 <- class_counts_noreturn %>%
  filter(fire_year >= 1995, fire_year <= 2004)

class_counts_noreturn_dec3 <- class_counts_noreturn %>%
  filter(fire_year >= 2005, fire_year <= 2014)

class_counts_noreturn_dec4 <- class_counts_noreturn %>%
  filter(fire_year >= 2015, fire_year <= 2024)

sum_noreturn_dec1 <- sum(class_counts_noreturn_dec1$area)
#11025.63
sum_noreturn_dec2 <- sum(class_counts_noreturn_dec2$area)
#7710.48
sum_noreturn_dec3 <- sum(class_counts_noreturn_dec3$area)
#36284.13
sum_noreturn_dec4 <- sum(class_counts_noreturn_dec4$area)
#226533.96



# Pivot to a wider format

library(dplyr)
library(tidyr)

# Recode returned column for clearer labels
class_counts_wide <- class_counts %>%
  mutate(returned = ifelse(returned == 1, "recovered", "transitioned")) %>%
  dplyr::select(fire_year, type, returned, area) %>%
  pivot_wider(
    names_from = returned,
    values_from = area
  )

# View the resulting wide-format table
print(class_counts_wide)

fwrite(class_counts_wide, "C:/Users/jscho/Documents/Megafires-1985-2023-Data/counts_area_transitioned_annual_predicted.csv")



trans <- sum(class_counts_wide$transitioned, na.rm = TRUE)
rec <- sum(class_counts_wide$recovered, na.rm = TRUE)
total <- trans+rec

trans/total
```


## Transitioned area in individual fires

```{r}
library(dplyr)
library(data.table)
library(stringr)
library(ggplot2)
library(scales)
library(ggpubr)

# Load recovery predictions (post-2001)
new_data_with_predictions <- fread("C:/Users/jscho/Documents/Megafires-1985-2023/all_predictions.csv") %>%
  filter(fire_year > 2001)

# Group by OBJECTID and predicted class
class_counts_predicted <- new_data_with_predictions %>%
  group_by(OBJECTID, predicted_class) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(type = "predicted")

# Load earlier megafire data
directory <- "C:/Users/jscho/Documents/Megafires-1985-2023-Data/raster_df_mega"
fire_IDs <- c(10495,10498,10504,10273,10094,9714,9724,9487,8985,
              9039,8747,8026,7996,7961,7808,7747,7514,7412,7242)

csv_files <- list.files(directory, pattern = "\\.csv$", full.names = TRUE)
filtered_files <- csv_files[sapply(csv_files, function(file) {
  fire_id <- as.numeric(str_extract(basename(file), "\\d+"))
  fire_id %in% fire_IDs
})]

# Read and bind the raster-level fire data
data_pre2002 <- bind_rows(lapply(filtered_files, fread)) %>%
  filter(RF_pre_veg == 7, transitioned == 1, rdnbr_class == 3) %>%
  mutate(
    years_since_fire = ifelse(is.na(fire_year - previous_fire_year), 100, fire_year - previous_fire_year),
    returned = ifelse(!is.na(yrs_to_return) & yrs_to_return > 20, 0, returned)
  )

# Group by OBJECTID and returned for measured class
class_counts_measured <- data_pre2002 %>%
  group_by(OBJECTID, returned) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(type = "measured")

# Standardize and bind both datasets
class_counts_predicted <- setNames(class_counts_predicted, c("OBJECTID", "returned", "count", "type"))
class_counts_predicted$returned <- as.numeric(class_counts_predicted$returned)

class_counts <- bind_rows(class_counts_measured, class_counts_predicted) %>%
  mutate(area = count * 0.09)

# Load fire name data
# Assumes fire_metrics_mega has columns: OBJECTID and FIRE_NAME
fire_metrics_mega <- fread("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/Megafire_paper/SN_megafires_1985_2023.csv", header=TRUE)

# Merge fire names
class_counts_named <- class_counts %>%
  left_join(fire_metrics_mega %>% dplyr::select(OBJECTID, FIRE_NAME, YEAR_), by = "OBJECTID") %>%
  filter(!is.na(FIRE_NAME))

class_counts_named <- class_counts_named %>%
  mutate(FIRE_NAME = factor(FIRE_NAME, levels = unique(FIRE_NAME[order(YEAR_)])))


# Final plot by FIRE_NAME
bars_by_fire_name <- ggplot(class_counts_named, aes(x = FIRE_NAME, y = area, fill = factor(returned), alpha = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("darkgrey", "darkgreen")) +
  scale_alpha_manual(values = c(1, 0.5)) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "",
    x = "Fire name",
    y = "Area (ha)",
    fill = "Predicted class",
    alpha = "Type"
  ) +
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Show plot
print(bars_by_fire_name)











# Scatterplot version of this graph

library(ggplot2)
library(scales)

# Compute cumulative area by returned class
cumulative_area <- class_counts_named %>%
  group_by(returned, YEAR_) %>%
  summarise(area = sum(area), .groups = "drop") %>%
  arrange(returned, YEAR_) %>%
  group_by(returned) %>%
  mutate(cum_area = cumsum(area))




scatter_by_fire_year <- ggplot(class_counts_named, aes(x = YEAR_, y = area)) +
  geom_point(aes(color = factor(returned), alpha = type),
             size = 2, position = position_jitter(width = 0.4, height = 0)) +
  geom_line(data = cumulative_area, aes(x = YEAR_, y = cum_area, color = factor(returned)),
            size = 1.2, inherit.aes = FALSE) +  # Add cumulative lines
  scale_color_manual(
    values = c("0" = "darkgrey", "1" = "darkgreen"),
    labels = c("Not Recovered", "Recovered"),
    name = "Returned"
  ) +
  scale_alpha_manual(
    values = c("measured" = 1, "predicted" = 0.5),
    name = "Type"
  ) +
  scale_y_continuous(labels = comma) +
  labs(
    x = "Fire Year",
    y = "Area (ha)",
    title = ""
  ) +
  theme_pubr() +
  theme(
    legend.position = "right",
    axis.text = element_text(face = "bold"),
    axis.title = element_text(face = "bold")
  )



# Show the updated plot
print(scatter_by_fire_year)



```


## Fig. X: Patches over time

```{r}

patch_metrics_mega <- patch_metrics_mega %>%
  mutate(n_bins = cut(n,
                      breaks = c(1, 100, 1000,10000,1500000),
                      labels = c("small","medium","large","very_large"),
                      include.lowest = TRUE))

# Custom RdNBR color palette
rdnbr_colors <- c("0" = "lightgrey", "1" = "#F6BE00", "2" = "#21918c", "3" = "#440154")

# Count for very_large patches by fire_year and rdnbr_class
very_large_counts <- patch_metrics_mega %>%
  filter(n_bins == "very_large") %>%
  count(fire_year, rdnbr_class)

large_patches_timeseries <- ggplot(very_large_counts, aes(x = fire_year, y = n, color = factor(rdnbr_class))) +
  geom_point(size = 3, alpha = 0.9) +
  geom_smooth(method = "gam", se = TRUE) +
  scale_color_manual(values = rdnbr_colors) +
  labs(
    title = "",
    x = "Fire year",
    y = "Count",
    color = "RdNBR class"
  ) +
  theme_classic()+
  theme(legend.position = "none")

```