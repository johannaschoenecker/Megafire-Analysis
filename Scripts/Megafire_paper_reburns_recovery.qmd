---
title: "Megafires Recovery"
format: html
editor: visual
---

Code by Johanna Schönecker

Edited 14th July 2025

This quarto document contains code to load and pre-process pixel-, fire- and patch-level data for megafires in the Sierra Nevada ecoregion which burned between 1985 and 2023 and analyse recovery using the metrics of NDVI and vegetation type classification recovery.

Different sections contain code to produce figures.

```{r}
library(tidyr)
library(raster)
library(rgdal)
library(ggplot2)
library(sp)
library(sf)
library(rgeos)
library(reshape)
library(gridExtra)
library(patchwork)
library(Rcpp)
library(scales)
library(dplyr)
library(ggpubr)
library(landscapemetrics)
library(landscapetools)
library(here)
library(stringr)
library(moments)
library(reshape2)
library(ggeasy)
library(vctrs)
library(mgcv)
library(networkD3)
library(ggridges)
library(cowplot)
library(factoextra)
library(gdistance)
library(fs)
library(data.table)
library(terra)
```

# Preliminary

```{r}
megafire_IDs <- c(5529, 5718, 5721, 8026, 7808, 7747, 7996, 7961, 
                   7412, 7514, 7242, 9714, 9724, 9487, 8985, 9039, 
                   8747, 10495, 10498, 10504, 10094, 10273, 1819, 1772, 
                   2111, 2140, 1210, 1211, 1216, 1215, 1220, 1319, 
                   1315, 718, 911, 932, 869, 888, 945, 959, 504, 
                   3363, 3567, 3573, 3574, 3051, 3094, 3188, 2706, 
                   2147, 2531, 2415, 2618, 5207, 5309, 4277, 4285, 
                   4306, 4380, 4386, 4374, 4500, 3983, 3992)

yrs_ids <- fread("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/Megafire_paper/yrs_ids.csv")

OBJECTIDs <- yrs_ids$OBJECTID
yrs <- yrs_ids$year

SN_fires_attr_mega <- read.csv("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/Megafire_paper/SN_megafires_1985_2023.csv", header=TRUE)
```

# Load Datasets

```{r}
############ Fire level ############


fire_metrics_mega <- fread("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/Megafire_paper/SN_megafires_1985_2023.csv", header=TRUE)


############ Patch level (rdnbr) ############
patch_metrics_mega <- read.csv("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/dataframes/Megafire_paper/SN_patch_metrics_mega_rdnbr_1985_2023.csv", header=TRUE)


```



# How much conifer forest transitioned

```{r}

library(data.table)
library(dplyr)
library(stringr)

# Set directory
directory <- "C:/Users/jscho/Documents/Megafires-1985-2023-Data/raster_df_mega_repeated_planting"

# List all csv files
csv_files <- list.files(directory, pattern = "\\.csv$", full.names = TRUE)

# Initialize an empty list to collect results
results_list <- list()

# Loop through each CSV
for (file in csv_files) {
  
  # Read the CSV using fread (MUCH faster)
  df <- fread(file, select = c("rdnbr_class", "RF_pre_veg", "transitioned"))
  
  # Filter for rdnbr_class == 3 and RF_pre_veg == 7
  filtered_df <- df %>%
    filter(rdnbr_class == 3, RF_pre_veg == 7)
  
  # Count where transitioned == 1
  transitioned_count <- sum(filtered_df$transitioned == 1, na.rm = TRUE)
  
  # Extract filename without extension
  filename_no_ext <- str_remove(basename(file), "\\.csv$")
  
  # Store results
  results_list[[filename_no_ext]] <- data.frame(
    Filename = filename_no_ext,
    Transitioned_Count = transitioned_count
  )
}

# Combine into one dataframe
final_results <- bind_rows(results_list)

final_results$transitioned_ha <- final_results$Transitioned_Count*0.09

total_con_HS_trans <- sum(final_results$transitioned_ha)

# Result: >516,000 ha of coniferous forest burned at high severity in megafires from 1985 to 2023 and transitioned to a different vegetation type
```


# Read in dfs for fires with 20 years post-fire

```{r}
############ Fires with at least 20 years post-fire vegetation data ###########

# IDs of fires 1985-2002
fire_IDs <- c(10495,10498,10504,10273,10094,9714,9724,9487,8985,
              9039,8747,8026,7996,7961,7808,7747,7514,7412,7242)


# Directory containing the megafire pixel dataframes
directory <- "C:/Users/jscho/Documents/Megafires-1985-2023-Data/raster_df_mega_repeated_planting"

# Get a list of all CSV files in the directory
csv_files <- list.files(directory, pattern = "\\.csv$", full.names = TRUE)

# Filter files whose filenames contain an ID from fire_IDs
filtered_files <- csv_files[sapply(csv_files, function(x) {
  any(fire_IDs %in% as.numeric(gsub("\\D", "", basename(x)))) # Extract numeric ID and check match
})]

# Initialize an empty list to store dataframes
df_list <- list()

# Read and store each matching dataframe
for (file in filtered_files) {
  df <- fread(file)
  df_list[[file]] <- df
}

# Combine all dataframes into one
pixel_df_mega20 <- bind_rows(df_list)

# Only coniferous pixels
pixel_df_mega20_con <- pixel_df_mega20 %>%
  filter(RF_pre_veg==7)

# Only coniferous pixels that burned at high severity
pixel_df_mega20_conHS <- pixel_df_mega20_con %>%
  filter(rdnbr_class==3)

pixel_df_mega20_conHS_trans <- pixel_df_mega20_conHS %>%
  filter(transitioned == 1)

# Area of high sev coniferous forest transitioned to different veg class post-fire:
count_trans <- nrow(pixel_df_mega20_conHS_trans)
area_trans <- count_trans*0.09

pixel_df_mega20_conHS_trans_noreturn <- pixel_df_mega20_conHS_trans %>%
  filter(returned == 0)

pixel_df_mega20_conHS_trans_returnlonger20yrs <- pixel_df_mega20_conHS_trans %>%
  filter(yrs_to_return >19)

count_noreturn <- count(pixel_df_mega20_conHS_trans_noreturn)
count_longer20yrs <- count(pixel_df_mega20_conHS_trans_returnlonger20yrs)

total_count_noreturn <- count_noreturn + count_longer20yrs
total_area_noreturn <- total_count_noreturn*0.09

prop_noreturn <- total_area_noreturn/area_trans

```

# Recovery: NDVI

```{r}
library(terra)
library(dplyr)

# ------------------------------------------------------------------------------

# Function to process a single fire's NDVI recovery (updated)
process_fire <- function(fire_id, fire_year) {
  
  # ----- Step 1: Define raster file paths -----
  burn_severity_path <- paste0(
    "C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Megafire_paper/RdNBR_classified/",
    fire_id, ".tif"
  )
  ndvi_path <- paste0(
    "C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Megafire_paper/NDVI_individual/",
    fire_id, "_NDVI.tif"
  )
  veg_class_path <- paste0(
    "C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Megafire_paper/veg_annual_individual/",
    fire_id, "/", fire_year - 1, "_Mega_", fire_id, ".tif"
  )
  
  plantings_path <- "C:/Users/jscho/Documents/Megafires-1985-2023-Data/Rasters/tree_planting_year"
  # ----- Step 2: Load rasters -----
  burn_severity <- rast(burn_severity_path)
  ndvi_stack <- rast(ndvi_path)
  veg_class <- rast(veg_class_path)
  plantings <- rast()
  repeated <- rast()
  
  # ----- Step 3: Align vegetation raster to burn severity raster -----
  veg_class <- veg_class |>
    crop(burn_severity) |>
    resample(burn_severity, method = "near")
  
  # ----- Step 4: Create masks -----
  high_severity <- burn_severity == 3          # High-severity burn
  coniferous <- veg_class == 7                # Coniferous vegetation
  no_plantings <- 
  mask <- high_severity & coniferous           # Combined mask
  
  # ----- Step 5: Align mask to NDVI stack -----
  mask <- mask |>
    crop(ext(ndvi_stack)) |>
    resample(ndvi_stack, method = "near")
  
  # ----- Step 6: Apply mask to NDVI stack -----
  masked_ndvi_stack <- mask(ndvi_stack, mask, updatevalue = NA)
  
  # ----- Step 7: Define NDVI year bands -----
  ndvi_years <- 1984:(1984 + nlyr(ndvi_stack) - 1)
  fire_band <- which(ndvi_years == fire_year)
  selected_bands <- c((fire_band - 3):fire_band, (fire_band + 1):(fire_band + 20))
  selected_bands <- selected_bands[selected_bands > 0 & selected_bands <= nlyr(ndvi_stack)]
  
  # ----- Step 8: Calculate pre-fire baseline -----
  pre_fire_bands <- (fire_band - 3):(fire_band - 1)
  pre_fire_values <- values(masked_ndvi_stack[[pre_fire_bands]])
  
  # Calculate per-pixel pre-fire NDVI mean
  if (is.matrix(pre_fire_values)) {
    pre_fire_mean_ndvi <- rowMeans(pre_fire_values, na.rm = TRUE)
  } else {
    pre_fire_mean_ndvi <- as.numeric(pre_fire_values)
  }
  
  # ----- Step 9: Calculate metrics for selected years -----
  ndvi_stats <- lapply(selected_bands, function(band) {
    ndvi_values <- values(masked_ndvi_stack[[band]])
    
    # Mean and standard deviation of NDVI
    mean_ndvi <- mean(ndvi_values, na.rm = TRUE)
    sd_ndvi <- sd(ndvi_values, na.rm = TRUE)
    
    # Proportion of pixels where NDVI >= pre-fire mean NDVI
    recovery_flags <- ndvi_values >= pre_fire_mean_ndvi
    proportion_recovered <- mean(recovery_flags, na.rm = TRUE)
    
    data.frame(
      Year = ndvi_years[band],
      Mean_NDVI = mean_ndvi,
      SD_NDVI = sd_ndvi,
      Proportion_Recovered = proportion_recovered
    )
  })
  
  # ----- Step 10: Combine yearly results -----
  ndvi_stats <- do.call(rbind, ndvi_stats)
  ndvi_stats$Fire_ID <- fire_id
  ndvi_stats$Fire_Year <- fire_year
  
  return(ndvi_stats)
}

# ------------------------------------------------------------------------------

# Process all fires
all_NDVI_data <- do.call(rbind, lapply(seq_along(fire_IDs), function(idx) {
  fire_id <- fire_IDs[idx]
  fire_year <- yrs_ids$year[yrs_ids$OBJECTID == fire_id]
  
  if (!is.na(fire_year)) {
    cat("Processing Fire ID:", fire_id, "for Year:", fire_year, "\n")
    process_fire(fire_id, fire_year)
  } else {
    cat("Skipping Fire ID:", fire_id, "- Year not found.\n")
    NULL
  }
}))

```


# Recovery: veg classification NEW

```{r}
library(dplyr)
library(tidyr)

# Assuming your data looks like:
# Columns: fire_id, x, y, RF_post0_veg, RF_post1_veg, ..., RF_post20_veg

pixel_df_mega20_conHS_trans_reb_plant <- pixel_df_mega20_conHS_trans %>%
  filter(tree_planting == 0) %>%
  filter(reburn_20yrs == 0)

# Pivot longer to get one row per pixel-year
long_df <- pixel_df_mega20_conHS_trans_reb_plant %>%
  pivot_longer(
    cols = starts_with("RF_post"),
    names_to = "rel_year",
    names_pattern = "RF_post(\\d+)_veg",
    values_to = "veg_class"
  ) %>%
  mutate(
    rel_year = as.integer(rel_year)  # Make year numeric
  )

# Summarize: proportion of conifer (veg_class == 7) pixels per fire and relative year
all_veg_data <- long_df %>%
  group_by(OBJECTID, rel_year) %>%
  summarise(
    total_pixels = n(),
    conifer_pixels = sum(veg_class == 7, na.rm = TRUE),
    proportion_conifer = conifer_pixels / total_pixels,
    .groups = "drop"
  )

```



```{r}
# # Load required libraries
# library(terra)
# library(dplyr)
# 
# # ------------------------------------------------------------------------------
# 
# # Function to process a single fire's vegetation classification
# process_veg_class <- function(fire_id, fire_year, burn_severity_path, veg_folder_path) {
#   
#   # ----- Step 1: Load burn severity raster -----
#   burn_severity <- rast(burn_severity_path)
#   
#   # Create mask for high-severity burns (value = 3)
#   high_severity <- burn_severity == 3
#   
#   # ----- Step 2: Load pre-fire vegetation raster -----
#   pre_fire_path <- paste0(veg_folder_path, "/", fire_year - 1, "_Mega_", fire_id, ".tif")
#   
#   if (!file.exists(pre_fire_path)) {
#     cat("Pre-fire vegetation raster not found for Fire ID:", fire_id, "\n")
#     return(NULL)
#   }
#   
#   pre_fire_veg_class <- rast(pre_fire_path) |>
#     crop(burn_severity) |>
#     resample(burn_severity, method = "near")
#   
#   # ----- Step 3: Create combined mask (high severity *and* coniferous) -----
#   coniferous <- pre_fire_veg_class == 7
#   base_mask <- high_severity & coniferous
#   
#   # Skip if no valid pixels
#   if (global(base_mask, fun = "sum", na.rm = TRUE)[,1] == 0) {
#     cat("No valid high-severity coniferous pixels for Fire ID:", fire_id, "\n")
#     return(NULL)
#   }
#   
#   # ----- Step 4: Initialize output container -----
#   veg_proportions <- list()
#   
#   # ----- Step 5: Loop over years (-3 prefire to +20 postfire) -----
#   years <- (fire_year - 3):(fire_year + 20)
#   
#   for (year in years) {
#     veg_path <- paste0(veg_folder_path, "/", year, "_Mega_", fire_id, ".tif")
#     
#     if (!file.exists(veg_path)) {
#       cat("File not found for year:", year, "\n")
#       next
#     }
#     
#     veg_class <- rast(veg_path) |>
#       crop(burn_severity) |>
#       resample(burn_severity, method = "near")
#     
#     # Apply the conifer/high-severity mask
#     valid_pixels <- veg_class[base_mask]
#     total_pixels <- length(valid_pixels)
#     veg_pixels <- sum(valid_pixels == 7, na.rm = TRUE)  # Count coniferous pixels
#     
#     # Calculate proportion of coniferous pixels
#     proportion <- ifelse(total_pixels > 0, veg_pixels / total_pixels, NA)
#     
#     # Save results for the year
#     veg_proportions[[as.character(year)]] <- data.frame(
#       Fire_ID = fire_id,
#       Fire_Year = fire_year,
#       Year = year,
#       Proportion = proportion
#     )
#   }
#   
#   # ----- Step 6: Combine and return the yearly results -----
#   return(do.call(rbind, veg_proportions))
# }
# 
# # ------------------------------------------------------------------------------
# 
# # Process all fires
# all_veg_data <- do.call(rbind, lapply(seq_along(fire_IDs), function(idx) {
#   
#   fire_id <- fire_IDs[idx]
#   fire_year <- yrs_ids$year[yrs_ids$OBJECTID == fire_id]
#   
#   if (length(fire_year) == 0 || is.na(fire_year)) {
#     cat("Skipping Fire ID:", fire_id, "- Year not found.\n")
#     return(NULL)
#   }
#   
#   cat("Processing Fire ID:", fire_id, "for Year:", fire_year, "\n")
#   
#   burn_severity_path <- paste0(
#     "C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Megafire_paper/RdNBR_classified/",
#     fire_id, ".tif"
#   )
#   
#   veg_folder_path <- paste0(
#     "C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Megafire_paper/veg_annual_individual/",
#     fire_id
#   )
#   
#   process_veg_class(fire_id, fire_year, burn_severity_path, veg_folder_path)
# }))
# 

```

# INCLUDING reburns and planting- rel. recovery boxes NDVI recovery rel. conifer vs. non-conifer
```{r}
library(data.table)
library(terra)
library(fs)
library(dplyr)
library(tidyr)


# Paths
csv_path <- "C:/Users/jscho/Documents/Megafires-1985-2023-Data/raster_df_mega_repeated_planting"
ndvi_base <- "C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Megafire_paper/NDVI_individual"

# IDs of fires 1985-2002
fire_IDs <- c(10495,10498,10504,10273,10094,9714,9724,9487,8985,
              9039,8747,8026,7996,7961,7808,7747,7514,7412,7242)

# Output list
results_list <- list()

for (fire_id in fire_IDs) {
  
  # Paths
  csv_file <- file.path(csv_path, paste0(fire_id, ".csv"))
  ndvi_path <- file.path(ndvi_base, paste0(fire_id, "_NDVI.tif"))
  
  # Check file existence
  if (!file_exists(csv_file) || !file_exists(ndvi_path)) {
    warning(paste("Missing file for fire ID:", fire_id))
    next
  }
  
  # Read and filter data
  df <- fread(csv_file)
  df_filtered <- df[rdnbr_class == 3 & RF_pre_veg == 7 & reburn_20yrs == 0 & tree_planting == 0]
  
  # Skip if empty
  if (nrow(df_filtered) == 0) next
  
  # Select x, y, and RF_postX_veg columns
  rf_post_cols <- grep("^RF_post[0-9]+_veg$", names(df_filtered), value = TRUE)
  df_filtered <- df_filtered[, c("x", "y", rf_post_cols, "transitioned", "returned", "fire_year", "yrs_to_return", "dist_unburned"), with = FALSE]
  
  # Extract NDVI
  ndvi_rast <- rast(ndvi_path)
  points <- vect(df_filtered[, .(x, y)], geom = c("x", "y"), crs = crs(ndvi_rast))
  ndvi_values <- extract(ndvi_rast, points)[, -1]  # Remove ID column
  
  # Combine results
  combined <- cbind(fire_id = fire_id, df_filtered, ndvi_values)
  results_list[[fire_id]] <- combined
}

# Merge all results
final_result <- rbindlist(results_list, fill = TRUE)

# View or save
print(final_result)
# fwrite(final_result, "NDVI_RF_post_veg_extracted.csv")




library(dplyr)
library(tidyr)
library(ggplot2)

# Your processed dataframe
# Assumes final_result is already loaded and contains NDVI and metadata

# Filter to fires of interest
fire_IDs <- c(10495,10498,10504,10273,10094,9714,9724,9487,8985,
              9039,8747,8026,7996,7961,7808,7747,7514,7412,7242)

# Filter and prep data
ndvi_by_rel_year_list <- list()

for (fid in fire_IDs) {
  df_fire <- final_result %>% filter(fire_id == fid)

  # Flag 20-year return
  df_fire <- df_fire %>%
    mutate(returned_20yrs = if_else(returned == 1 & yrs_to_return < 21, 1, 0))

  # Get fire year
  fire_year <- unique(df_fire$fire_year)
  if (length(fire_year) != 1) next

  # Pivot NDVI columns to long format
  ndvi_long <- df_fire %>%
    pivot_longer(cols = matches("^\\d+_NDVI_\\d{4}$"),
                 names_to = "ndvi_year",
                 values_to = "ndvi") %>%
    separate(ndvi_year, into = c("band_index", "year"), sep = "_NDVI_", convert = TRUE) %>%
    mutate(rel_year = year - fire_year)

  # Calculate pre-fire NDVI mean (years -3, -2, -1)
  pre_fire_means <- ndvi_long %>%
    filter(rel_year %in% c(-3, -2, -1)) %>%
    group_by(x, y) %>%
    summarise(pre_fire_ndvi = mean(ndvi, na.rm = TRUE), .groups = "drop")

  # Merge and compute delta
  ndvi_long <- ndvi_long %>%
    left_join(pre_fire_means, by = c("x", "y")) %>%
    mutate(ndvi_diff = ndvi - pre_fire_ndvi,
           returned_20yrs = df_fire$returned_20yrs[match(paste(x, y), paste(df_fire$x, df_fire$y))])

  ndvi_by_rel_year_list[[as.character(fid)]] <- ndvi_long
}

# Combine all fires
ndvi_combined <- bind_rows(ndvi_by_rel_year_list) %>%
  filter(returned_20yrs %in% c(0, 1)) %>%
  mutate(returned_20yrs = factor(returned_20yrs, labels = c("not returned", "returned"))) %>%
  filter(rel_year >= -3, rel_year < 21)

# Final plot
box_ret_no <- ggplot(ndvi_combined, aes(x = factor(rel_year), y = ndvi_diff, fill = returned_20yrs)) +
  geom_boxplot(
    position = position_dodge(width = 0.6),
    width = 0.5,
    alpha = 1,
    outlier.size = 0.5,
    lwd = 0.2
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey40") +
  scale_fill_manual(values = c("not returned" = "darkgrey", "returned" = "#0e4f12")) +
  labs(
    x = "Relative year",
    y = "ΔNDVI (post - pre)",
    fill = "20-year return to conifer"
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.title = element_text(size = 13)
  )

# Show plot
print(box_ret_no)


```

# all_ndvi_data
```{r}

```


# INCLUDING reburns and plantings- time series
```{r}
# Plot NDVI proportions and conifer proportions in the same plot
library(dplyr)
library(ggplot2)

# Summarize ndvi_combined: get mean NDVI by Fire_ID and relative year
all_NDVI_data <- ndvi_combined %>%
  group_by(fire_id, rel_year) %>%
  summarise(Proportion_Recovered = mean(ndvi_diff, na.rm = TRUE), .groups = "drop") %>%
  rename(Fire_ID = fire_id, Relative_Year = rel_year) %>%
  mutate(Type = "NDVI")


# Rename OBJECTID to Fire_ID
all_veg_data <- all_veg_data %>%
  rename(Fire_ID = OBJECTID) %>%
  mutate(Type = "Conifer class")

# Proceed as before
all_NDVI_data <- all_NDVI_data %>%
  mutate(Type = "NDVI")

all_NDVI_data$Proportion_Recovery_Mean <- all_NDVI_data$Proportion_Recovered
all_veg_data$Proportion_Recovery_Mean <- all_veg_data$proportion_conifer

all_veg_data$Relative_Year <- all_veg_data$rel_year
all_NDVI_data$Relative_Year <- all_NDVI_data$Relative_Year

# Combine the two datasets
combined_data <- bind_rows(
  all_NDVI_data %>% dplyr::select(Fire_ID, Relative_Year, Proportion_Recovery_Mean, Type),
  all_veg_data %>% dplyr::select(Fire_ID, Relative_Year, Proportion_Recovery_Mean, Type)
)



# Ensure Fire_ID is a factor for discrete coloring
combined_data$Fire_ID <- as.factor(combined_data$Fire_ID)


# Merge fire name and year information from SN_fires_attr_mega
library(stringr)

# Ensure consistent types for Fire_ID
combined_data <- combined_data %>%
  mutate(Fire_ID = as.integer(as.character(Fire_ID)))  # Convert Fire_ID to integer


# Merge fire name and year information from SN_fires_attr_mega
combined_data <- combined_data %>%
  left_join(
    SN_fires_attr_mega %>%
      dplyr::select(OBJECTID, FIRE_NAME, YEAR_) %>%
      dplyr::rename(Fire_ID = OBJECTID, Fire_Year = YEAR_),
    by = "Fire_ID"
  )

# Add formatted facet labels
combined_data <- combined_data %>%
  mutate(
    Facet_Label = str_to_title(FIRE_NAME),  # Convert to title case
    Facet_Label = paste(Facet_Label, " (", Fire_Year, ")", sep = "")  # Add space before year
  )

combined_data <- combined_data %>%
  filter(Relative_Year < 21)

# Define light green and dark green colors
color_palette <- c("NDVI" = "lightgreen", "Conifer class" = "darkgreen")

plot_combined_faceted_smooth <- ggplot(combined_data %>% filter(Relative_Year > 0), 
                                       aes(x = Relative_Year, y = Proportion_Recovery_Mean, 
                                           group = Type, color = Type)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "grey50") +
  geom_line() +
  geom_smooth(
    method = "gam",
    formula = y ~ s(x, bs = "cs"),
    se = TRUE,
    aes(fill = Type),
    alpha = 0.2
  ) +
  labs(
    title = "",
    x = "Years post-fire",
    y = "Proportion recovered",
    color = "Vegetation metric",
    fill = "Vegetation metric"
  ) +
  scale_color_manual(values = color_palette) +
  scale_fill_manual(values = color_palette) +
  scale_y_continuous(limits = c(0, 1.2)) +
  scale_x_continuous(breaks = c(1, 5, 10, 15, 20)) +  # <-- set x breaks manually
  facet_wrap(~ Facet_Label, scales = "fixed", ncol = 5) +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    strip.text = element_text(face = "bold", size = 10),
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 10)
  )


# Print the plot
print(plot_combined_faceted_smooth)
```



# Recovery: comparison NDVI vs. conifer

```{r}
# Plot NDVI proportions and conifer proportions in the same plot
library(dplyr)
library(ggplot2)

# Add a column to distinguish NDVI and vegetation proportions
all_NDVI_data <- all_NDVI_data %>%
  mutate(Type = "NDVI")
all_veg_data <- all_veg_data %>%
  mutate(Type = "Conifer class")

all_NDVI_data$Proportion_Recovery_Mean <- all_NDVI_data$Proportion_Recovered
all_veg_data$Proportion_Recovery_Mean <- all_veg_data$Proportion

all_veg_data$Relative_Year <- all_veg_data$Year - all_veg_data$Fire_Year
all_NDVI_data$Relative_Year <- all_NDVI_data$Year - all_NDVI_data$Fire_Year

# Combine the two datasets
combined_data <- bind_rows(
  all_NDVI_data %>% dplyr::select(Fire_ID, Relative_Year, Proportion_Recovery_Mean, Type),
  all_veg_data %>% dplyr::select(Fire_ID, Relative_Year, Proportion_Recovery_Mean, Type)
)

# Ensure Fire_ID is a factor for discrete coloring
combined_data$Fire_ID <- as.factor(combined_data$Fire_ID)


# Merge fire name and year information from SN_fires_attr_mega
library(stringr)

# Ensure consistent types for Fire_ID
combined_data <- combined_data %>%
  mutate(Fire_ID = as.integer(as.character(Fire_ID)))  # Convert Fire_ID to integer


# Merge fire name and year information from SN_fires_attr_mega
combined_data <- combined_data %>%
  left_join(
    SN_fires_attr_mega %>%
      dplyr::select(OBJECTID, FIRE_NAME, YEAR_) %>%
      dplyr::rename(Fire_ID = OBJECTID, Fire_Year = YEAR_),
    by = "Fire_ID"
  )

# Add formatted facet labels
combined_data <- combined_data %>%
  mutate(
    Facet_Label = str_to_title(FIRE_NAME),  # Convert to title case
    Facet_Label = paste(Facet_Label, " (", Fire_Year, ")", sep = "")  # Add space before year
  )

# Define light green and dark green colors
color_palette <- c("NDVI" = "lightgreen", "Conifer class" = "darkgreen")

plot_combined_faceted_smooth <- ggplot(combined_data %>% filter(Relative_Year > 0), 
                                       aes(x = Relative_Year, y = Proportion_Recovery_Mean, 
                                           group = Type, color = Type)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "grey50") +
  geom_line() +
  geom_smooth(
    method = "gam",
    formula = y ~ s(x, bs = "cs"),
    se = TRUE,
    aes(fill = Type),
    alpha = 0.2
  ) +
  labs(
    title = "",
    x = "Years post-fire",
    y = "Proportion recovered",
    color = "Vegetation metric",
    fill = "Vegetation metric"
  ) +
  scale_color_manual(values = color_palette) +
  scale_fill_manual(values = color_palette) +
  scale_y_continuous(limits = c(0, 1.2)) +
  scale_x_continuous(breaks = c(1, 5, 10, 15, 20)) +  # <-- set x breaks manually
  facet_wrap(~ Facet_Label, scales = "fixed", ncol = 5) +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    strip.text = element_text(face = "bold", size = 10),
    axis.title = element_text(face = "bold", size = 14),
    axis.text = element_text(size = 10)
  )


# Print the plot
print(plot_combined_faceted_smooth)
```


