---
title: "6 Megafires_clean"
format: html
editor: visual
---

Code by Johanna Sch√∂necker

Edited 12th February 2025

This quarto document contains code to load and pre-process pixel-, fire- and patch-level data for megafires in the Sierra Nevada ecoregion which burned between 1985 and 2023.

Different sections contain code to produce figures.

##Packages

```{r Loading packages}
library(tidyr)
library(raster)
library(rgdal)
library(ggplot2)
library(sp)
library(sf)
library(rgeos)
library(reshape)
library(gridExtra)
library(patchwork)
library(Rcpp)
library(scales)
library(dplyr)
library(ggpubr)
library(landscapemetrics)
library(landscapetools)
library(here)
library(stringr)
library(moments)
library(reshape2)
library(ggeasy)
library(vctrs)
library(mgcv)
library(networkD3)
library(ggridges)
library(cowplot)
library(factoextra)
library(gdistance)
library(fs)
library(data.table)
library(terra)

```

##Dataprep

```{r}
#Fire level datasets
fire_metrics_mega <- fread("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/Megafire_paper/SN_megafires_1985_2023.csv", header=TRUE)

megafire_IDs <- c(5529, 5718, 5721, 8026, 7808, 7747, 7996, 7961, 
                   7412, 7514, 7242, 9714, 9724, 9487, 8985, 9039, 
                   8747, 10495, 10498, 10504, 10094, 10273, 1819, 1772, 
                   2111, 2140, 1210, 1211, 1216, 1215, 1220, 1319, 
                   1315, 718, 911, 932, 869, 888, 945, 959, 504, 
                   3363, 3567, 3573, 3574, 3051, 3094, 3188, 2706, 
                   2147, 2531, 2415, 2618, 5207, 5309, 4277, 4285, 
                   4306, 4380, 4386, 4374, 4500, 3983, 3992)
```

```{r}

#Patch level datasets- rdnbr
patch_metrics_mega <- fread("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/Megafire_paper/SN_patch_metrics_mega_rdnbr_1985_2023.csv")


```

#General megafire anaylsis

```{r megafire number in year ~ total burned area}

# Find out area burned annually in normal & megafires

SN_fires_attr_all <- read.csv("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/Megafire_paper/SN_all_fires_1985_2023.csv", header=TRUE)

SN_fires_attr_mega <- read.csv("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/Megafire_paper/SN_megafires_1985_2023.csv", header=TRUE)

# Summarize the SN_fires_attr_all dataframe
area_burned_all_annual <- SN_fires_attr_all %>%
  group_by(YEAR_) %>%
  summarise(total_burned_area = sum(Shape_Area, na.rm = TRUE))

# Summarize the SN_fires_attr_mega dataframe
area_burned_mega_annual <- SN_fires_attr_mega %>%
  group_by(YEAR_) %>%
  summarise(mega_area = sum(Shape_Area, na.rm = TRUE))

# Perform a left join to combine the dataframes
area_burned_combined <- area_burned_all_annual %>%
  left_join(area_burned_mega_annual, by = "YEAR_")

# Replace NA values in mega_area with 0
area_burned_combined <- area_burned_combined %>%
  mutate(mega_area = ifelse(is.na(mega_area), 0, mega_area))

area_burned_combined$small_area <- area_burned_combined$total_burned_area - area_burned_combined$mega_area

mega_counts_area <- data.frame(
  year = c(1985, 1986, 1987, 1988, 1989, 1990, 1991, 1992, 1993, 1994, 1995,
           1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006,
           2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017,
           2018, 2019, 2020,2021,2022,2023),
  count_mega = c(0, 0, 4, 1, 0, 2, 0, 1, 0, 2, 0, 1, 0, 0, 3, 2, 1, 2, 0, 0,
                 0, 0, 2, 3, 0, 0, 1, 6, 2, 3, 2, 2, 4, 4, 1, 7,7,1,0),
  area_burned = area_burned_combined$total_burned_area
)

mega_counts_area$area_burned_ha <- mega_counts_area$area_burned * 0.0001

# Assuming mega_counts_area already has count_mega and area_burned_ha
# Fit the linear model
model <- lm(area_burned_ha ~ count_mega, data = mega_counts_area)

# Calculate predictions and confidence intervals
mega_counts_area$predictions <- predict(model, newdata = mega_counts_area, type = "response")
confidence_data <- predict(model, newdata = mega_counts_area, interval = "confidence", level = 0.95)

# Add confidence intervals to your dataframe
mega_counts_area$lower_bound = confidence_data[, "lwr"]
mega_counts_area$upper_bound = confidence_data[, "upr"]

# Convert the dataframe from wide to long format
area_burned_long <- area_burned_combined %>%
  dplyr::select(-total_burned_area) %>%  # Remove the second column
  pivot_longer(cols = c(mega_area, small_area), 
               names_to = "size_class", 
               values_to = "area") %>%
  mutate(size_class = ifelse(size_class == "mega_area", "mega", "small"))


# Creating the ggplot
plot_31 <- ggplot(mega_counts_area, aes(x = count_mega, y = area_burned_ha)) +
  geom_point(aes(color = "Data"), alpha = 1.0, size=3.5) +  # Plotting the data points
  geom_line(aes(y = predictions, color = "Fitted"), size = 1) +  # Regression line
  geom_ribbon(aes(ymin = lower_bound, ymax = upper_bound), fill = "darkgrey", alpha = 0.3) +  # Confidence intervals
  scale_color_manual(values = c("Data" = "black", "Fitted" = "black")) +
  labs(x = "Number of megafires in a fire year",
       y = "Area burned [ha]") +
  theme_bw()+
  theme(legend.position = "none")+
  theme(
    panel.grid.major = element_blank(),  # ‚úÖ Removes major gridlines
    panel.grid.minor = element_blank(),  # ‚úÖ Removes minor gridlines
    axis.title.y = element_text(color = "#3a3b3c",face= 'bold' ),
    axis.title.x = element_text(color = "#3a3b3c",face= 'bold' ))

# Calculate R-squared
rsq <- summary(model)$r.squared
# Adding R-squared text to the plot using annotate
plot_31 <- plot_31 + annotate("text", x = max(mega_counts_area$count_mega), y = min(mega_counts_area$area_burned_ha), label = paste("R =", round(rsq, 4)), hjust = 1, vjust = -1, color = "black", size=8)

# Display the plot
print(plot_31)


# Megafires vs. small fires

# Pivoting mega_area and small_area into long format
area_burned_long <- area_burned_combined %>%
  pivot_longer(cols = c(mega_area, small_area),  # Columns to pivot
               names_to = "type",  # New column for category (mega or small)
               values_to = "area")  # New column for area values

area_burned_long$area_ha <- area_burned_long$area/10000


plot_23_1 <- ggplot() + 
  # üîπ Bar plot: Area burned per year
  geom_bar(data = area_burned_long, 
           aes(x = YEAR_, y = area_ha, fill = type), 
           stat = 'identity') +  # ‚úÖ Fill mapped correctly
  
  # üîπ Points: Number of megafires per year (rescaled to match primary axis)
  geom_point(data = mega_counts_area, 
             aes(x = year, y = count_mega * 100000),  # ‚úÖ Rescale for better visibility
             size = 3, color = "black", alpha=1.0) + 

  # üîπ Poisson regression smooth line
  geom_smooth(data = mega_counts_area, 
              aes(x = year, y = count_mega * 100000),  # ‚úÖ Rescale to align with primary y-axis
              method = "glm", method.args = list(family = "poisson"), 
              se = TRUE, color="black")+

  # üîπ X-axis scaling
  scale_x_continuous(name = "Fire year", limits=c(1984, 2023))+

  # üîπ Y-axis scaling (Primary: Area burned, Secondary: Number of megafires)
  scale_y_continuous(name = "Area burned [ha]", limits = c(0, 700000),
                     sec.axis = sec_axis(~./100000, name = "Number of megafires")) + 

  # üîπ Custom colors for fire size
  scale_fill_manual(values = c('small_area' = '#E17327', 'mega_area' = '#932191')) + 

  # üîπ Theme customization (Removing Gridlines)
  theme_bw() +
  theme(
    panel.grid.major = element_blank(),  # ‚úÖ Removes major gridlines
    panel.grid.minor = element_blank(),  # ‚úÖ Removes minor gridlines
    axis.title.y = element_text(color = "black", face= 'bold'),
    axis.title.y.right = element_text(color = "black", face = 'bold'),
    axis.title.x = element_text(color = "black", face= 'bold'),
    legend.position = "none"
  ) +
  labs(fill = "Fire Size")

# Print the plot
print(plot_23_1)

# Load required package
library(cowplot)

# Arrange the two plots vertically
combined_plot <- plot_grid(plot_23_1, plot_31, 
                           ncol = 1,  # 1 column (stacked vertically)
                           align = "v",  # Align plots vertically
                           labels = c("b", "c"),  # Add labels
                           label_size = 16)  # Label size

# Display the combined plot
print(combined_plot)




```

```{r Map of megafires vs smaller fires}
# Load required libraries
library(ggplot2)
library(sf)
library(raster)
library(dplyr)
library(ggspatial)

# Read shapefiles
states_shp <- st_read("C:/Users/jscho/Downloads/cb_2018_us_state_500k/cb_2018_us_state_500k.shp") %>%
  filter(NAME %in% c("Oregon", "California", "Nevada"))  # Filter states

SN_outline <- st_read("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Megafire_paper/SN_subregions_dissolved.shp")
SN_all_fires <- st_read("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Megafire_paper/SN_all_1985_2023.shp")
SN_megafires <- st_read("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Megafire_paper/SN_mega_1985_2023.shp")

# Read the elevation raster
elev_raster <- raster("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/elevation.tif")

# Convert the raster to a dataframe for ggplot
elev_df <- as.data.frame(rasterToPoints(elev_raster))  # Convert raster to points
colnames(elev_df) <- c("x", "y", "elevation")  # Rename columns

# Create the map
megafire_map <- ggplot() +
  
  # Base layer: Elevation raster in greyscale
  geom_raster(data = elev_df, aes(x = x, y = y, fill = elevation)) +
  scale_fill_gradient(low = "grey90", high = "grey20") +  # Greyscale gradient
  
  # States boundaries in light grey
  geom_sf(data = states_shp, fill = NA, color = 'lightgrey', size = 1) +
  
  # Sierra Nevada outline in dark grey
  geom_sf(data = SN_outline, fill = NA, color = 'darkgrey', size = 1) +
  
  # All fires (1985-2023) in orange
  geom_sf(data = SN_all_fires, fill = "#E17327", color = "#E17327", alpha = 0.8) +
  
  # Megafires (1985-2023) in purple
  geom_sf(data = SN_megafires, fill = "#932191", color = '#932191', alpha = 0.8) +
  
  # Add a north arrow and scale bar
  annotation_scale(location = "br", width_hint = 0.2) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         style = north_arrow_fancy_orienteering()) +
  
  # Remove gridlines & background
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) +
  
  # Add title and caption
  labs(title = "Megafires and All Fires in the Sierra Nevada (1985-2023)",
       subtitle = "Orange: All Fires | Purple: Megafires")

# Display the map
print(megafire_map)

```

```{r megafire number in year ~ total burned area, for SN L4 Ecoregion only}

# Find out area burned annually in normal & megafires

SN_fires_attr_all <- read.csv("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/Megafire_paper/SN_L4_ecoregion_all_1985_2023.csv", header=TRUE)

SN_fires_attr_mega <- read.csv("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/Megafire_paper/SN_L4_ecoregion_mega_1985_2023.csv", header=TRUE)

# Summarize the SN_fires_attr_all dataframe
area_burned_all_annual <- SN_fires_attr_all %>%
  group_by(YEAR_) %>%
  summarise(total_burned_area = sum(Shape_Area, na.rm = TRUE))

# Summarize the SN_fires_attr_mega dataframe
area_burned_mega_annual <- SN_fires_attr_mega %>%
  group_by(YEAR_) %>%
  summarise(mega_area = sum(Shape_Area, na.rm = TRUE))

# Perform a left join to combine the dataframes
area_burned_combined <- area_burned_all_annual %>%
  left_join(area_burned_mega_annual, by = "YEAR_")

# Replace NA values in mega_area with 0
area_burned_combined <- area_burned_combined %>%
  mutate(mega_area = ifelse(is.na(mega_area), 0, mega_area))

area_burned_combined$small_area <- area_burned_combined$total_burned_area - area_burned_combined$mega_area

mega_counts_area <- data.frame(
  year = c(1985, 1986, 1987, 1988, 1989, 1990, 1991, 1992, 1993, 1994, 1995,
           1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006,
           2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017,
           2018, 2019, 2020,2021,2022,2023),
  count_mega = c(0, 0, 4, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 2, 0, 2, 0, 0,
                 0, 0, 2, 3, 0, 0, 1, 1, 2, 1, 2, 2, 2, 3, 1, 6,7,1,0),
  area_burned = area_burned_combined$total_burned_area
)

mega_counts_area$area_burned_ha <- mega_counts_area$area_burned * 0.0001

# Assuming mega_counts_area already has count_mega and area_burned_ha
# Fit the linear model
model <- lm(area_burned_ha ~ count_mega, data = mega_counts_area)

# Calculate predictions and confidence intervals
mega_counts_area$predictions <- predict(model, newdata = mega_counts_area, type = "response")
confidence_data <- predict(model, newdata = mega_counts_area, interval = "confidence", level = 0.95)

# Add confidence intervals to your dataframe
mega_counts_area$lower_bound = confidence_data[, "lwr"]
mega_counts_area$upper_bound = confidence_data[, "upr"]

# Convert the dataframe from wide to long format
area_burned_long <- area_burned_combined %>%
  dplyr::select(-total_burned_area) %>%  # Remove the second column
  pivot_longer(cols = c(mega_area, small_area), 
               names_to = "size_class", 
               values_to = "area") %>%
  mutate(size_class = ifelse(size_class == "mega_area", "mega", "small"))


# Creating the ggplot
plot_31 <- ggplot(mega_counts_area, aes(x = count_mega, y = area_burned_ha)) +
  geom_point(aes(color = "Data"), alpha = 1.0, size=3.5) +  # Plotting the data points
  geom_line(aes(y = predictions, color = "Fitted"), size = 1) +  # Regression line
  geom_ribbon(aes(ymin = lower_bound, ymax = upper_bound), fill = "darkgrey", alpha = 0.3) +  # Confidence intervals
  scale_color_manual(values = c("Data" = "black", "Fitted" = "black")) +
  labs(x = "Number of megafires in a fire year",
       y = "Area burned [ha]") +
  theme_bw()+
  theme(legend.position = "none")+
  theme(
    panel.grid.major = element_blank(),  # ‚úÖ Removes major gridlines
    panel.grid.minor = element_blank(),  # ‚úÖ Removes minor gridlines
    axis.title.y = element_text(color = "#3a3b3c",face= 'bold' ),
    axis.title.x = element_text(color = "#3a3b3c",face= 'bold' ))

# Calculate R-squared
rsq <- summary(model)$r.squared
# Adding R-squared text to the plot using annotate
plot_31 <- plot_31 + annotate("text", x = max(mega_counts_area$count_mega), y = min(mega_counts_area$area_burned_ha), label = paste("R =", round(rsq, 4)), hjust = 1, vjust = -1, color = "black", size=8)

# Display the plot
print(plot_31)


# Megafires vs. small fires

# Pivoting mega_area and small_area into long format
area_burned_long <- area_burned_combined %>%
  pivot_longer(cols = c(mega_area, small_area),  # Columns to pivot
               names_to = "type",  # New column for category (mega or small)
               values_to = "area")  # New column for area values

area_burned_long$area_ha <- area_burned_long$area/10000


plot_23_1 <- ggplot() + 
  # üîπ Bar plot: Area burned per year
  geom_bar(data = area_burned_long, 
           aes(x = YEAR_, y = area_ha, fill = type), 
           stat = 'identity') +  # ‚úÖ Fill mapped correctly
  
  # üîπ Points: Number of megafires per year (rescaled to match primary axis)
  geom_point(data = mega_counts_area, 
             aes(x = year, y = count_mega * 100000),  # ‚úÖ Rescale for better visibility
             size = 3, color = "#f8765c", alpha=1.0) + 

  # üîπ Poisson regression smooth line
  geom_smooth(data = mega_counts_area, 
              aes(x = year, y = count_mega * 100000),  # ‚úÖ Rescale to align with primary y-axis
              method = "glm", method.args = list(family = "poisson"), 
              se = TRUE, color="#f8765c")+

  # üîπ X-axis scaling
  scale_x_continuous(name = "Fire Year", limits=c(1984, 2023))+

  # üîπ Y-axis scaling (Primary: Area burned, Secondary: Number of megafires)
  scale_y_continuous(name = "Area burned [ha]", limits = c(0, 700000),
                     sec.axis = sec_axis(~./100000, name = "Number of Megafires")) + 

  # üîπ Custom colors for fire size
  scale_fill_manual(values = c('small_area' = 'grey', 'mega_area' = 'black')) + 

  # üîπ Theme customization (Removing Gridlines)
  theme_bw() +
  theme(
    panel.grid.major = element_blank(),  # ‚úÖ Removes major gridlines
    panel.grid.minor = element_blank(),  # ‚úÖ Removes minor gridlines
    axis.title.y = element_text(color = "black", face= 'bold'),
    axis.title.y.right = element_text(color = "#f8765c", face = 'bold'),
    axis.title.x = element_text(color = "black", face= 'bold'),
    legend.position = "none"
  ) +
  labs(fill = "Fire Size")

# Print the plot
print(plot_23_1)


```

```{r}
# Faceted histograms of vegetation type burned by elevation, faceted by burn severity

#Fire ID and year- sort for all fires
fire_year <- 2020
fire_id <- 1216

# Histograms of burned vegetation by elevation/ burn severity
elev_rast <- rast("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/elevation.tif")

veg_rast_1pre <- paste0("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Megafire_paper/veg_annual_individual/",fire_id,"/",fire_year-1,"_Mega_",fire_id,".tif")

burn_severity_rast <- paste0("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Megafire_paper/RdNBR_classified/",fire_id,".tif")

# Ensure the rasters have the same extent and resolution
#veg_rast_1pre <- resample(veg_rast_1pre, elev_rast, method = "near")
#burn_severity_rast <- resample(KNP_rdnbr_rast_class, elev_rast, method = "near")

# Stack the rasters to extract values (vegetation, elevation, and burn severity)
stacked_rasters <- c(veg_rast_1pre, elev_rast, burn_severity_rast)

# Convert the stacked raster values to a data frame
raster_values <- as.data.frame(stacked_rasters, xy = TRUE, na.rm = TRUE)

# Rename columns for easier use
colnames(raster_values) <- c("x", "y", "vegetation_class", "elevation", "burn_severity")


#raster_values <- raster_values %>%
#  mutate(burn_severity = ifelse(burn_severity == -1, 0, burn_severity))

raster_values <- raster_values %>%
  mutate(burn_severity = factor(burn_severity, levels = c(0,1,2,3)))

raster_values <- raster_values %>%
  mutate(vegetation_class = factor(vegetation_class, levels = c(7,1,2,3,4,5,6,8,9)))

raster_values <- raster_values %>%
  mutate(severity = case_when(
    burn_severity == 0 ~ "unburned",
    burn_severity == 1 ~ "low",
    burn_severity == 2 ~ "moderate",
    burn_severity == 3 ~ "high",
    TRUE ~ NA_character_  # Default case for any unexpected values
  ))

raster_values <- raster_values %>%
  mutate(severity = factor(severity, levels = c('unburned','low','moderate','high')))

raster_values_veg_only <- raster_values %>%
  filter(vegetation_class %in% c(1, 4, 5, 7,8,9))


plot_101_1 <- ggplot(raster_values, aes(x = elevation, fill = as.factor(vegetation_class))) +
  geom_histogram(binwidth = 50, color = "black", alpha = 0.6, position = "identity") +
  scale_fill_manual(
    name = "Vegetation type",
    values = c('1' = '#956733','4' = '#d8bf58', '5' = '#6dcd2b', '7' = '#0e4f12'),
    labels = c("Coniferous","Shrub", "Open/grassland", "Herbaceous")
  ) +
  facet_wrap(~ severity) +  # Faceting by burn severity
  labs(title = "",
       x = "Elevation (m)", y = "Count") +
  theme_bw() +
  
  # Customizing the font size and style for various elements
  theme(
    axis.title = element_text(size = 14, face = "bold"),  # Increase axis titles font size and make bold
    legend.title = element_text(size = 12, face = "bold"),  # Increase legend title font size and make bold
    legend.text = element_text(size = 10),  # Increase legend text size
    strip.text = element_text(size = 12, face = "bold"),  # Increase facet title size and make bold
    axis.text = element_text(size = 10)  # Adjust axis text size
  )

# Print the plot
plot_101_1



vegetation_class_counts <- raster_values %>%
  count(vegetation_class)

vegetation_class_counts$area_ha <- vegetation_class_counts$n*0.09

vegetation_class_counts$prop_area <- vegetation_class_counts$area_ha/sum(vegetation_class_counts$area_ha)
```

```{r}
# Required libraries
library(terra)
library(dplyr)
library(ggplot2)

# Paths to elevation raster and attributes dataframe
elev_rast <- rast("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/elevation.tif")


# Initialize an empty dataframe to hold all data
all_raster_values <- data.frame()

# Loop through each fire and collect data
for (fire_id in megafire_IDs) {
  # Get fire year
  fire_year <- SN_fires_attr_mega %>%
    filter(OBJECTID == fire_id) %>%
    pull(YEAR_)
  
  if (length(fire_year) == 0) {
    cat("Fire year not found for Fire ID:", fire_id, "\n")
    next
  }
  
  # Paths to rasters
  veg_rast_1pre <- rast(paste0("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/veg_annual_individual/", fire_id, "/", fire_year - 1, "_", fire_id, ".tif"))
  burn_severity_rast <- rast(paste0("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/3310_SN_rdnbr_classified_individual_mega/", fire_id, ".tif"))
  
  # Resample rasters
  veg_rast_1pre <- resample(veg_rast_1pre, elev_rast, method = "near")
  burn_severity_rast <- resample(burn_severity_rast, elev_rast, method = "near")
  
  # Stack rasters
  stacked_rasters <- c(veg_rast_1pre, elev_rast, burn_severity_rast)
  
  # Extract values into a dataframe
  raster_values <- as.data.frame(stacked_rasters, xy = TRUE, na.rm = TRUE)
  colnames(raster_values) <- c("x", "y", "vegetation_class", "elevation", "burn_severity")
  
  # Add fire-specific data
  raster_values$Fire_ID <- fire_id
  raster_values$Fire_Year <- fire_year
  
  # Append to the main dataframe
  all_raster_values <- bind_rows(all_raster_values, raster_values)
}

# Process the combined data
all_raster_values <- all_raster_values %>%
  mutate(
    burn_severity = ifelse(burn_severity == -1, 0, burn_severity),
    burn_severity = factor(burn_severity, levels = c(0, 1, 2, 3)),
    vegetation_class = factor(vegetation_class, levels = c(7, 1, 2, 3, 4, 5, 6)),
    severity = case_when(
      burn_severity == 0 ~ "unburned",
      burn_severity == 1 ~ "low",
      burn_severity == 2 ~ "moderate",
      burn_severity == 3 ~ "high",
      TRUE ~ NA_character_
    ),
    severity = factor(severity, levels = c('unburned', 'low', 'moderate', 'high'))
  ) %>%
  filter(vegetation_class %in% c(1, 4, 5, 7))  # Filter for specific vegetation classes

# Generate the combined plot
combined_plot <- ggplot(all_raster_values, aes(x = elevation, fill = as.factor(vegetation_class))) +
  geom_histogram(binwidth = 50, color = "black", alpha = 0.6, position = "identity") +
  scale_fill_manual(
    name = "Vegetation type",
    values = c('1' = '#956733', '4' = '#d8bf58', '5' = '#6dcd2b', '7' = '#0e4f12'),
    labels = c("Coniferous", "Shrub", "Open/grassland", "Herbaceous")
  ) +
  facet_wrap(~ severity, scales = "free_y") +
  labs(
    title = "Vegetation and Elevation Distribution Across Fires",
    x = "Elevation (m)", 
    y = "Count"
  ) +
  theme_bw() +
  theme(
    axis.title = element_text(size = 14, face = "bold"),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10),
    strip.text = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10)
  )

# Print the plot
print(combined_plot)


```

```{r}
#Patch sizes
# Binning 'n' and preparing the dataset
patch_metrics_mega <- patch_metrics_mega %>%
  mutate(n_bins = cut(n,
                      breaks = c(1, 100, 1000,10000,1500000),
                      labels = c("small","medium","large","very large"),
                      include.lowest = TRUE))

# patch_metrics_mega <- patch_metrics_mega %>%
#   mutate(n_bins = cut(n,
#                       breaks = c(1, 444, 1110,4555,44444, 1500000),
#                       labels = c("0.09-40","41-100","101-410","411-4000",">4001"),
#                       include.lowest = TRUE))

# classes: 0-40ha, 40-100ha, 100-410ha, 4000

patch_metrics_mega_sev <- patch_metrics_mega %>%
  filter(rdnbr_class == 3)

patch_metrics_mega_sev_con <- patch_metrics_mega_sev %>%
  filter(mode_veg == 7)

# Aggregate data
# Aggregate data with cumulative percentages calculated correctly
agg_data <- patch_metrics_mega %>%
  group_by(n_bins) %>%
  summarise(
    num_observations = n(),         # Number of observations in each group
    cumulative_area = sum(n) * 0.09 # Convert area to hectares
  ) %>%
  mutate(
    n_bins = factor(n_bins, levels = c("small","medium","large","very large")),
    cumulative_sum = cumsum(cumulative_area),                      # Cumulative sum of areas
    cumulative_percentage = (cumulative_sum / sum(cumulative_area)) * 100 # Cumulative percentage
  )

# Precompute scaling factors
max_num_observations <- max(agg_data$num_observations)
max_cumulative_area <- max(agg_data$cumulative_area)

# Create the plot
plot_32_0 <- ggplot(data = agg_data, aes(x = n_bins)) +
  # Bar plot for the number of observations
  geom_bar(aes(y = num_observations), stat = "identity", fill = "grey", alpha = 0.7) +
  # Add count numbers on top of the bars
  geom_text(aes(y = num_observations, label = scales::comma(num_observations)),
            vjust = -0.5, size = 3.5, color = "black") +
  # Points plot for the cumulative area
  geom_point(aes(y = cumulative_area / max_cumulative_area * max_num_observations), color = "blue", size = 3) +
  geom_line(aes(y = cumulative_area / max_cumulative_area * max_num_observations, group = 1), color = "blue", linetype = "dashed") +
  # Add cumulative percentages as text labels
  geom_text(aes(
    y = cumulative_area / max_cumulative_area * max_num_observations,
    label = paste0(round(cumulative_percentage, 1), "%")
  ),
  vjust = -0.5, color = "blue", size = 3.5) +
  # Secondary y-axis
  scale_y_continuous(
    name = "Number of patches",
    labels = scales::comma, # Add thousand separators to primary axis
    sec.axis = sec_axis(~ . / max_num_observations * max_cumulative_area,
                        name = "Cumulative area (ha)", labels = scales::comma) # Add thousand separators to secondary axis
  ) +
  labs(x = "Patch size (ha)", title = "") +
  theme_classic()



# Group by n_bins and rdnbr_class, then calculate the sum, mean, and standard deviation of column 'n'
summary_stats <- patch_metrics_mega %>%
  group_by(n_bins, rdnbr_class) %>%
  summarise(
    sum_n = sum(n, na.rm = TRUE),
    mean_n = mean(n, na.rm = TRUE),
    sd_n = sd(n, na.rm = TRUE)
  )

summary_stats$mean_ha <- summary_stats$mean_n * 0.09

summary_stats$sd_ha <- summary_stats$sd_n * 0.09

summary_stats$area_ha <- summary_stats$sum_n * 0.09

total_area_patch_size_class <- summary_stats %>%
  group_by(n_bins) %>%
  summarise(sum_area_ha = sum(area_ha, na.rm = TRUE))


# Calculating frequencies within each bin
frequency_data <- patch_metrics_mega %>%
  group_by(n_bins, rdnbr_class) %>%
  summarise(frequency = n(), .groups = 'drop') %>%
  group_by(n_bins) %>%
  mutate(total = sum(frequency),  # Summing frequencies within each bin
         rel_frequency = frequency / total)  # Calculating relative frequency per bin


frequency_data <- frequency_data %>%
  mutate(rdnbr_class = as.factor(rdnbr_class))

plot_32 <- ggplot(frequency_data, aes(x = n_bins, y = rel_frequency, fill = rdnbr_class)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7, alpha=0.6) +  # Stacked bar plot
  scale_fill_manual(values = c("-1" = "#D9DDDC", "0" = "#D9DDDC", "1" = "#F6BE00", "2" = '#21918c', "3" = "#440154"),
                    labels = c("enhanced regrowth", "unburned", "low", "moderate", "high")) +  # Custom colors with labels
  labs(x = "Patch size (ha)",
       y = "Relative frequency of each RdNBR class",
       fill = "RdNBR class")+
  theme(
    panel.grid = element_blank(),
    legend.position='right'
  )


# Calculate frequencies and sum of 'n' for each 'n_bins'
n_bins_summary <- patch_metrics_mega %>%
  group_by(n_bins) %>%
  summarise(
    frequency = n(),        # Counts the number of rows for each 'n_bins'
    sum_n = sum(n, na.rm = TRUE)  # Sums up the 'n' column values, ignoring NA
  ) %>%
  arrange(desc(frequency))  # Optional: arrange by frequency



n_bins_summary$prop_count <- n_bins_summary$frequency/(sum(n_bins_summary$frequency))
n_bins_summary$prop_area <- n_bins_summary$sum_n/(sum(n_bins_summary$sum_n))



# Ensure 'n_bins' is ordered correctly for your desired plot
n_bins_summary$n_bins <- factor(n_bins_summary$n_bins, levels = c("very large", "large", "medium", "small"))

# Plotting the data
plot_32_1 <- ggplot(n_bins_summary, aes(x = factor(1), y = prop_count, fill = n_bins)) +
  geom_bar(stat = "identity", position = "fill", width = 1) +  # Use 'fill' for proportional stacking
  scale_fill_manual(values = patch_size_colors) +  # Assign custom colors
  coord_flip() +  # Flips the bar to horizontal; x and y axes are swapped
  labs(title = "", x = NULL, y = "Proportion") +
  theme_classic() +
  theme(axis.text.y = element_blank(),  # Remove text along the y-axis
        axis.ticks.y = element_blank(),  # Remove ticks along the y-axis
        axis.title.y = element_blank(),  # Remove y-axis title
        legend.title = element_blank())  # Remove legend title


# Plotting the data
plot_32_2 <- ggplot(n_bins_summary, aes(x = factor(1), y = prop_area, fill = n_bins)) +
  geom_bar(stat = "identity", position = "fill", width = 1) +  # Use 'fill' for proportional stacking
  scale_fill_manual(values = patch_size_colors) +  # Assign custom colors
  coord_flip() +  # Flips the bar to horizontal; x and y axes are swapped
  labs(title = "", x = NULL, y = "Proportion") +
  theme_classic() +
  theme(axis.text.y = element_blank(),  # Remove text along the y-axis
        axis.ticks.y = element_blank(),  # Remove ticks along the y-axis
        axis.title.y = element_blank(),  # Remove y-axis title
        legend.title = element_blank())  # Remove legend title


# Recode rdnbr_class -1 and 0 to 0
patch_metrics_mega1 <- patch_metrics_mega %>%
  mutate(rdnbr_class = ifelse(rdnbr_class %in% c(-1, 0), 0, rdnbr_class))

# Calculating summary stats- proportions are relative to one fire
patch_metrics_mega_summary <- patch_metrics_mega1 %>%
  group_by(OBJECTID, n_bins, rdnbr_class) %>%
  summarise(count = n(), area = sum(n)) %>%
  ungroup() %>%
  group_by(OBJECTID) %>%
  mutate(proportion_patches = count / sum(count), 
         proportion_area = area / sum(area))

patch_metrics_mega_summary$area_ha <- patch_metrics_mega_summary$area * 0.09

plot_32_4 <- ggplot(patch_metrics_mega_summary, aes(x = n_bins, y = proportion_area, fill = factor(rdnbr_class))) +
  geom_boxplot(position = position_dodge(width = 0.75),alpha=0.6) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 3, color = "red", position = position_dodge(width = 0.75)) +
  scale_fill_manual(
    values = c("0" = "darkgrey", "1" = "#F6BE00", "2" = '#21918c', "3" = "#440154"),
    labels = c("unburned", "low severity", "moderate severity", "high severity")  # Custom legend labels
  ) +
  labs(
    title = "",
    x = "Patch size",
    y = "Proportion of total fire area",
    fill = "RdNBR class"
  ) 

# Absolute area instead of proportion
plot_32_5 <- ggplot(patch_metrics_mega_summary, aes(x = n_bins, y = area_ha, fill = factor(rdnbr_class))) +
  geom_boxplot(position = position_dodge(width = 0.75), alpha=0.6) +
  stat_summary(fun = mean, geom = "point", shape = 20, size = 3, color = "red", position = position_dodge(width = 0.75)) +
  coord_cartesian(ylim = c(0, 12000)) +  # Set custom y-axis limits
  scale_fill_manual(values = c("0" = "darkgrey", "1" = "#F6BE00", "2" = '#21918c', "3" = "#440154"))+
   scale_y_continuous(labels = scales::comma) + 
  labs(title = "",
       x = "Patch size",
       y = "Total area burned within fire (ha)",
       fill = "RDNBR Class") 

```

```{r}
# Which Level IV ecoregions are the megafires found in?

# Load required libraries
library(sf)
library(dplyr)

# Load the shapefiles
megafires <- st_read("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Basefiles/megafires_1985_2020_epsg3310.shp")
ca_eco <- st_read("C:/Users/jscho/Downloads/ca_eco_l4/ca_eco_l4.shp")

# Ensure the shapefiles have the same CRS (Coordinate Reference System)
ca_eco <- st_transform(ca_eco, st_crs(megafires))

# Perform a spatial intersection to extract attributes
megafires_with_eco <- st_intersection(megafires, ca_eco)

# View the resulting dataframe
print(megafires_with_eco)

# Save the result as a new shapefile
st_write(megafires_with_eco, "C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/Basefiles/megafires_with_eco.shp")

```

```{r}
# Same patch severity/size distributions, but for individual fire
#Patches severity/ size

num <- 30032

patch_metrics_mega_indiv <- patch_metrics_mega %>%
  filter(OBJECTID==num)

patch_metrics_mega_indiv_clean <- patch_metrics_mega_indiv %>%
  filter(n >2)

patch_metrics_mega_indiv <- patch_metrics_mega_indiv_clean

# Calculating frequencies within each bin
frequency_data <- patch_metrics_mega_indiv %>%
  group_by(n_bins, rdnbr_class) %>%
  summarise(frequency = n(), .groups = 'drop') %>%
  group_by(n_bins) %>%
  mutate(total = sum(frequency),  # Summing frequencies within each bin
         rel_frequency = frequency / total)  # Calculating relative frequency per bin


frequency_data <- frequency_data %>%
  mutate(rdnbr_class = as.factor(rdnbr_class))

plot_32_indiv <- ggplot(frequency_data, aes(x = n_bins, y = rel_frequency, fill = rdnbr_class)) +
  geom_bar(stat = "identity", position = "stack", width = 0.7) +  # Stacked bar plot
  scale_fill_manual(values = c("-1" = "#D9DDDC", "0" = "darkgrey", "1" = "#F6BE00", "2" = '#21918c', "3" = "#440154"),
                    labels = c("enhanced regrowth", "unburned", "low", "moderate", "high")) +  # Custom colors with labels
  labs(x = "Patch size",
       y = "Relative frequency of each RdNBR class",
       fill = "RdNBR class") +  # Adjust the fill legend title
  theme_classic() +
  theme(legend.position = "right",
        panel.grid.major = element_blank(),  
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(margin = margin(t=10), size=12, face='bold'))


# Calculate frequencies and sum of 'n' for each 'n_bins'
n_bins_summary <- patch_metrics_mega_indiv %>%
  group_by(n_bins) %>%
  summarise(
    frequency = n(),        # Counts the number of rows for each 'n_bins'
    sum_n = sum(n, na.rm = TRUE)  # Sums up the 'n' column values, ignoring NA
  ) %>%
  arrange(desc(frequency))  # Optional: arrange by frequency


n_bins_summary$prop_count <- n_bins_summary$frequency/(sum(n_bins_summary$frequency))
n_bins_summary$prop_area <- n_bins_summary$sum_n/(sum(n_bins_summary$sum_n))
# View the result
print(n_bins_summary)

# Ensure 'n_bins' is ordered correctly for your desired plot
n_bins_summary$n_bins <- factor(n_bins_summary$n_bins, levels = c("very large", "large", "medium", "small"))

# Plotting the data
plot_32_1_indiv <- ggplot(n_bins_summary, aes(x = factor(1), y = prop_count, fill = n_bins)) +
  geom_bar(stat = "identity", position = "fill", width = 1) +  # Use 'fill' for proportional stacking
  scale_fill_manual(values = patch_size_colors) +  # Assign custom colors
  coord_flip() +  # Flips the bar to horizontal; x and y axes are swapped
  labs(title = "", x = NULL, y = "proportion") +
  theme_classic() +
  theme(axis.text.y = element_blank(),  # Remove text along the y-axis
        axis.ticks.y = element_blank(),  # Remove ticks along the y-axis
        axis.title.y = element_blank(),  # Remove y-axis title
        legend.title = element_blank())  # Remove legend title


# Plotting the data
plot_32_2_indiv <- ggplot(n_bins_summary, aes(x = factor(1), y = prop_area, fill = n_bins)) +
  geom_bar(stat = "identity", position = "fill", width = 1) +  # Use 'fill' for proportional stacking
  scale_fill_manual(values = patch_size_colors) +  # Assign custom colors
  coord_flip() +  # Flips the bar to horizontal; x and y axes are swapped
  labs(title = "", x = NULL, y = "proportion") +
  theme_classic() +
  theme(axis.text.y = element_blank(),  # Remove text along the y-axis
        axis.ticks.y = element_blank(),  # Remove ticks along the y-axis
        axis.title.y = element_blank(),  # Remove y-axis title
        legend.title = element_blank())  # Remove legend title
```

##rdnbr Shapes

```{r}
# rdnbr shape vectors

bimodal <- c(21683,21684,32384,33025,35874,37023,37098,38341,39756, 42350, 40570)

normal <- c(21678,21679,21786,30032,37928,37959,37989,39674,39683,39762,40705,40882,41925,42387,42745,39327)

right_skewed <- c(22057,28976,33252,38120,39424,39763,41262,21791,22060,21688)

left_skewed <- c(33113,35032,35053,35312,35322,36180,36404,38018,38923,39335,39356, 39430,40325,41219,41627,41747,41837, 42055,42380)


```

#High sev Conifer

```{r}
# Declare the OBJECTID
num <- 37023
fire_year <- 2002

# File paths and other variables using the declared number
distance_highSev_toUnburned_path <- paste0("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/GIS/Megafires/distance_to_unburned_conifer/", num, "_dist.tif")




veg_folder <- paste0("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/GIS/Recovery/", num, "/")

# Load the raster
distance_highSev_toUnburned <- raster(distance_highSev_toUnburned_path)

# List all TIF files in the folder
veg_files <- list.files(veg_folder, pattern = "\\.tif$", full.names = TRUE)

# Stack the TIF files
veg_stack <- stack(veg_files)

# Extract all veg values
raster_points <- rasterToPoints(distance_highSev_toUnburned)
raster_coordinates <- as.data.frame(raster_points[, 1:2])
stack_values <- extract(veg_stack, raster_coordinates)

value_df <- as.data.frame(cbind(raster_points, stack_values))

value_df_con <- value_df %>%
  filter(X2001 == 7)

# Add distance_class column
value_df_trans_con <- value_df_trans_con %>%
  mutate(distance_class = case_when(
    !!sym(paste0("X", num, "_DUnburned")) >= 0 & !!sym(paste0("X", num, "_DUnburned")) < 100 ~ '0-100',
    !!sym(paste0("X", num, "_DUnburned")) >= 100 & !!sym(paste0("X", num, "_DUnburned")) < 200 ~ '100-200',
    !!sym(paste0("X", num, "_DUnburned")) >= 200 & !!sym(paste0("X", num, "_DUnburned")) < 300 ~ '200-300',
    !!sym(paste0("X", num, "_DUnburned")) >= 300 ~ '>300'
  ))

# Calculate the total counts for each distance_class
total_counts <- value_df_trans_con %>%
  group_by(distance_class) %>%
  summarize(total_count = n(), .groups = 'drop')

# Create an empty list to store the summary data frames
summary_list <- list()

# Loop over the range of columns from 3 to 30
for (i in 3:30) {
  column_name <- paste0("trans_returned_to_preFire_veg", i)
  summary_df <- value_df_trans_con %>%
    group_by(distance_class, !!sym(column_name)) %>%
    summarize(count = n(), .groups = 'drop') %>%
    left_join(total_counts, by = "distance_class") %>%
    mutate(proportion = count / total_count)
  
  summary_df <- summary_df %>%
    mutate(years = i)
  
  names(summary_df)[names(summary_df) == column_name] <- "trans_preFire"
  
  summary_list[[column_name]] <- summary_df
}

summary_df_combined <- do.call(rbind, summary_list)
```

#PCA environmental conditions

```{r}

# Data prep

fire_metrics_pixel_mega <- fread("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/SN_fire_metrics_rdnbr_1985_2020_epsg3310.csv", header=TRUE)

fire_metrics_pixel_mega <- fire_metrics_pixel_mega %>%
  dplyr::select(c(OBJECTID,mean_rdnbr,mean_tmean, mean_tmax, mean_tmin, mean_tdmean, mean_vpdmin,mean_vpdmax,mean_ppt,mean_elevation,mean_tmean_1pre,mean_tmax_1pre,mean_tmin_1pre,mean_tdmean_1pre,mean_vpdmin_1pre,mean_vpdmax_1pre, mean_ppt_1pre,count_RF_pre_veg1,count_RF_pre_veg2,count_RF_pre_veg3,count_RF_pre_veg4,count_RF_pre_veg5,count_RF_pre_veg6,count_RF_pre_veg7,perc_c3,perc_c2,perc_c1,perc_c0,burn_completeness,n_pixels_c0,n_pixels_c1,n_pixels_c2,n_pixels_c3, area_ha, mn_patch_size_0, mn_patch_size_3,mn_patch_size_2,mn_patch_size_1))
#,trans_post_fire




 # Combine vectors into one dataframe
rdnbr_shapes <- data.frame(
  OBJECTID = c(bimodal, normal, right_skewed, left_skewed),
  rdnbr_shape = c(rep("bimodal", length(bimodal)),
                  rep("normal", length(normal)),
                  rep("right_skewed", length(right_skewed)),
                  rep("left_skewed", length(left_skewed)))
)


# Merge the dataframes by the value of OBJECTID
rdnbr_shapes_merged_env <- merge(rdnbr_shapes, fire_metrics_pixel_mega, by = "OBJECTID")
#rdnbr_shapes_merged_env <- merge(rdnbr_shapes_merged_env,fire_metrics_mega, by = #"OBJECTID")

rdnbr_shapes_merged_env$perc_pre_veg_7 <- rdnbr_shapes_merged_env$count_RF_pre_veg7/(rdnbr_shapes_merged_env$count_RF_pre_veg1+rdnbr_shapes_merged_env$count_RF_pre_veg2+rdnbr_shapes_merged_env$count_RF_pre_veg3+rdnbr_shapes_merged_env$count_RF_pre_veg4+rdnbr_shapes_merged_env$count_RF_pre_veg5+rdnbr_shapes_merged_env$count_RF_pre_veg6+rdnbr_shapes_merged_env$count_RF_pre_veg7)
rdnbr_shapes_merged_env$perc_pre_veg_1 <- rdnbr_shapes_merged_env$count_RF_pre_veg1/(rdnbr_shapes_merged_env$count_RF_pre_veg1+rdnbr_shapes_merged_env$count_RF_pre_veg2+rdnbr_shapes_merged_env$count_RF_pre_veg3+rdnbr_shapes_merged_env$count_RF_pre_veg4+rdnbr_shapes_merged_env$count_RF_pre_veg5+rdnbr_shapes_merged_env$count_RF_pre_veg6+rdnbr_shapes_merged_env$count_RF_pre_veg7)

rdnbr_shapes_merged_env$rdnbr_shape <- as.factor(rdnbr_shapes_merged_env$rdnbr_shape)


# Select the relevant attributes for clustering
data <- rdnbr_shapes_merged_env[, c( "mean_tmax_1pre", "mean_elevation","mean_ppt","perc_pre_veg_7")] #,"years_since_last_fire"

# Scale the data
scaled_data <- scale(data)
colnames(scaled_data) <- c("tmax.pre", "mean.elevation",'mean.ppt','%conifer')


pca_result <- prcomp(scaled_data, scale. = TRUE)

# For example, using the elbow method
wss <- numeric(10)
for (i in 1:10) {
  km <- kmeans(scaled_data, centers = i)
  wss[i] <- sum(km$withinss)
}
plot(1:10, wss, type = "b", xlab = "Number of Clusters", ylab = "Within-cluster Sum of Squares")

num_clusters <- 4  # Adjust this based on the elbow method or other criteria
cluster_model <- kmeans(scaled_data, centers = num_clusters)

# Extract cluster assignments from the clustering model
cluster_assignments <- cluster_model$cluster


plot_34_1 <- fviz_pca_biplot(pca_result,col.var = 'black',repel = TRUE, label='var', habillage=rdnbr_shapes_merged_env$rdnbr_shape,palette = c("#648FFF", "#FE6100", "#FFB000", "#DC267F"),
                addEllipses=TRUE, ellipse.level=0.90)+theme_bw()

```

#PCA burn characteristics

```{r}
blue_colors <- c("#648FFF", "#FE6100", "#FFB000", "#DC267F")

# Data Prep
# Combine vectors into one dataframe
rdnbr_shapes <- data.frame(
  OBJECTID = c(bimodal, normal, right_skewed, left_skewed),
  rdnbr_shape = c(rep("bimodal", length(bimodal)),
                  rep("normal", length(normal)),
                  rep("right_skewed", length(right_skewed)),
                  rep("left_skewed", length(left_skewed)))
)


# Merge the dataframes by the value of OBJECTID
rdnbr_shapes_merged <- merge(rdnbr_shapes, fire_metrics_pixel_mega, by = "OBJECTID")

rdnbr_shapes_merged$rdnbr_shape <- as.factor(rdnbr_shapes_merged$rdnbr_shape)

rdnbr_shapes_merged$perc_pre_veg_7 <- rdnbr_shapes_merged$count_RF_pre_veg7/(rdnbr_shapes_merged$count_RF_pre_veg1+rdnbr_shapes_merged$count_RF_pre_veg2+rdnbr_shapes_merged$count_RF_pre_veg3+rdnbr_shapes_merged$count_RF_pre_veg4+rdnbr_shapes_merged$count_RF_pre_veg5+rdnbr_shapes_merged$count_RF_pre_veg6+rdnbr_shapes_merged$count_RF_pre_veg7)
rdnbr_shapes_merged$perc_pre_veg_1 <- rdnbr_shapes_merged$count_RF_pre_veg1/(rdnbr_shapes_merged$count_RF_pre_veg1+rdnbr_shapes_merged$count_RF_pre_veg2+rdnbr_shapes_merged$count_RF_pre_veg3+rdnbr_shapes_merged$count_RF_pre_veg4+rdnbr_shapes_merged$count_RF_pre_veg5+rdnbr_shapes_merged$count_RF_pre_veg6+rdnbr_shapes_merged$count_RF_pre_veg7)


# Select the relevant attributes for clustering
data <- rdnbr_shapes_merged[, c("perc_c3", "mn_patch_size_3", "mean_rdnbr","burn_completeness","perc_pre_veg_7","perc_pre_veg_1","mn_patch_size_0")]

# Scale the data
scaled_data <- scale(data)
colnames(scaled_data) <- c("percent.high.sev", "mean.high.sev.patch.size", "mean.fire.rdnbr",'burn.completeness','%.conifer','%.shrub','mean.unburned.patch.size')


pca_result <- prcomp(scaled_data, scale. = TRUE)

# For example, using the elbow method
wss <- numeric(10)
for (i in 1:10) {
  km <- kmeans(scaled_data, centers = i)
  wss[i] <- sum(km$withinss)
}
plot(1:10, wss, type = "b", xlab = "Number of Clusters", ylab = "Within-cluster Sum of Squares")

num_clusters <- 4  # Adjust this based on the elbow method or other criteria
cluster_model <- kmeans(scaled_data, centers = num_clusters)

# Extract cluster assignments from the clustering model
cluster_assignments <- cluster_model$cluster


# Visualize PCA results with cluster assignments colored by rdnbr_shape
p <- fviz_pca_ind(pca_result, geom.ind = "point", habillage = rdnbr_shapes_merged$rdnbr_shape, 
             addEllipses = TRUE, ellipse.type = "convex",ellipse.level=0.95)



plot_34 <- fviz_pca_biplot(pca_result,col.var = 'black',repel = TRUE, label='var', habillage=rdnbr_shapes_merged$rdnbr_shape,palette = c("#648FFF", "#FE6100", "#FFB000", "#DC267F"),
                addEllipses=TRUE, ellipse.level=0.90)+theme_bw()


plot_34
```

#Burn severity vs patch size/ recovery

```{r}

recov_tentative <- fread("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/SN_mega_recovery_fromPatch.csv")

blue_colors <- c("#648FFF", "#FE6100", "#FFB000", "#DC267F")
# Data Prep
# Combine vectors into one dataframe
rdnbr_shapes <- data.frame(
  OBJECTID = c(bimodal, normal, right_skewed, left_skewed),
  rdnbr_shape = c(rep("bimodal", length(bimodal)),
                  rep("normal", length(normal)),
                  rep("right_skewed", length(right_skewed)),
                  rep("left_skewed", length(left_skewed)))
)


# Merge the dataframes by the value of OBJECTID
rdnbr_shapes_merged <- merge(rdnbr_shapes, fire_metrics_mega, by = "OBJECTID")

rdnbr_shapes_merged$rdnbr_shape <- as.factor(rdnbr_shapes_merged$rdnbr_shape)

rdnbr_shapes_merged$perc_pre_veg_7 <- rdnbr_shapes_merged$count_RF_pre_veg7/(rdnbr_shapes_merged$count_RF_pre_veg1+rdnbr_shapes_merged$count_RF_pre_veg2+rdnbr_shapes_merged$count_RF_pre_veg3+rdnbr_shapes_merged$count_RF_pre_veg4+rdnbr_shapes_merged$count_RF_pre_veg5+rdnbr_shapes_merged$count_RF_pre_veg6+rdnbr_shapes_merged$count_RF_pre_veg7)
rdnbr_shapes_merged$perc_pre_veg_1 <- rdnbr_shapes_merged$count_RF_pre_veg1/(rdnbr_shapes_merged$count_RF_pre_veg1+rdnbr_shapes_merged$count_RF_pre_veg2+rdnbr_shapes_merged$count_RF_pre_veg3+rdnbr_shapes_merged$count_RF_pre_veg4+rdnbr_shapes_merged$count_RF_pre_veg5+rdnbr_shapes_merged$count_RF_pre_veg6+rdnbr_shapes_merged$count_RF_pre_veg7)

# Subset fire recovery metrics to only include high severity
#recov_metrics_mega_sev <- recovery_metrics_mega %>%
#  filter(rdnbr_class == 3)

recov_metrics_mega_sev <- recov_tentative %>%
  filter(rdnbr_class == 3)

recov_metrics_mega_sev$OBJECTID <- as.numeric(recov_metrics_mega_sev$OBJECTID)

rdnbr_shapes_merged <- merge(rdnbr_shapes_merged, recov_metrics_mega_sev, by = "OBJECTID")

plot_33_1_1 <- ggplot(rdnbr_shapes_merged, aes(x = burned_rdnbr_mean, y = mn_patch_size_3)) +
  geom_point(aes(color = rdnbr_shape, shape = rdnbr_shape), size = 3) +  
  scale_color_manual(values = blue_colors, name = "RdNBR shape",
                     labels = c("bimodal", "log normal", "normal", "right skewed")) +  # Set name for color scale
  scale_shape_manual(values = c(3, 8, 2, 0), name = "RdNBR shape",
                     labels = c("bimodal", "log normal", "normal", "right skewed")) +  # Set same name for shape scale
  xlab("Mean RdNBR") +
  ylab("Mean high severity patch size") +
  geom_quantile(quantiles = 0.25, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1)) +  # 25th percentile
  geom_quantile(quantiles = 0.5, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1)) +   # Median
  geom_quantile(quantiles = 0.75, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1))  # 75th percentile

# Print the plot
print(plot_33_1_1)

# Conifer recovery based on  - 10 years
plot_33_2_1 <- ggplot(rdnbr_shapes_merged, aes(x = mn_patch_size_3, y= percent_conifer_recov_10yr,  color = rdnbr_shape, shape = rdnbr_shape)) +
  geom_point(size = 3) +  # Increase size for better visibility
  scale_color_manual(values = blue_colors, name = "RdNBR shape",
                     labels = c("bimodal", "log normal", "normal", "right skewed")) +  # Add blue color scale
  scale_shape_manual(values = c(3, 8, 2, 0), name = "RdNBR shape",
                     labels = c("bimodal", "log normal", "normal", "right skewed")) +  # Define different shapes
  xlab("Mean high severity patch size") +
  ylim(0,1)+
  ylab("Proportion conifer recovered after 10 years") +
  geom_quantile(quantiles = 0.25, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1)) +  # Add quartile regression line (25th percentile)
  geom_quantile(quantiles = 0.5, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1)) +   # Add quartile regression line (50th percentile, median)
  geom_quantile(quantiles = 0.75, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1)) #+  # Add quartile regression line (75th percentile)
  #geom_smooth(method='lm')

# Print the plot
print(plot_33_2_1)


joined_df <- inner_join(patch_size_aw_mega, rdnbr_shapes_merged, by = c("rdnbr_class", "OBJECTID"))

joined_df <- joined_df[-6, ]

# Conifer recovery based on  - 10 years and awmps
plot_33_2_1_1 <- ggplot(joined_df, aes(x = AWMPS, y= percent_conifer_recov_10yr,  color = rdnbr_shape, shape = rdnbr_shape)) +
  geom_point(size = 3) +  # Increase size for better visibility
  scale_color_manual(values = blue_colors, name = "RdNBR shape",
                     labels = c("bimodal", "log normal", "normal", "right skewed")) +  # Add blue color scale
  scale_shape_manual(values = c(3, 8, 2, 0), name = "RdNBR shape",
                     labels = c("bimodal", "log normal", "normal", "right skewed")) +  # Define different shapes
  xlab("Area weighted mean high severity patch size") +
  scale_x_continuous(labels = scales::comma,
                     limits = c(0, 125000)) +
  ylim(0,1)+
  ylab("Proportion conifer recovered after 10 years") +
  geom_quantile(quantiles = 0.25, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1)) +  # Add quartile regression line (25th percentile)
  geom_quantile(quantiles = 0.5, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1)) +   # Add quartile regression line (50th percentile, median)
  geom_quantile(quantiles = 0.75, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1))   # Add quartile regression line (75th percentile)
  #geom_smooth(method='lm')+

# Print the plot
print(plot_33_2_1_1)

# AWMPS and percent burned at high severity
plot_33_2_1_2 <- ggplot(joined_df, aes(x = AWMPS, y= perc_c3,  color = rdnbr_shape, shape = rdnbr_shape)) +
  geom_point(size = 3) +  # Increase size for better visibility
  scale_color_manual(values = blue_colors, name = "RdNBR shape",
                     labels = c("bimodal", "log normal", "normal", "right skewed")) +  # Add blue color scale
  scale_shape_manual(values = c(3, 8, 2, 0), name = "RdNBR shape",
                     labels = c("bimodal", "log normal", "normal", "right skewed")) +  # Define different shapes
  xlab("Area weighted mean high severity patch size") +
  scale_x_continuous(labels = scales::comma,
                     limits = c(0, 125000)) +
  ylim(0,1)+
  ylab("Proportion of fire burned at high severity") +
  geom_quantile(quantiles = 0.25, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1)) +  # Add quartile regression line (25th percentile)
  geom_quantile(quantiles = 0.5, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1)) +   # Add quartile regression line (50th percentile, median)
  geom_quantile(quantiles = 0.75, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1))   # Add quartile regression line (75th percentile)
  #geom_smooth(method='lm')+

# Print the plot
print(plot_33_2_1_2)


# Conifer recovery based on shape- 5 years
plot_33_2_2 <- ggplot(rdnbr_shapes_merged, aes(x = mn_patch_size_3, y= percent_conifer_recov_5yr,  color = rdnbr_shape, shape = rdnbr_shape)) +
  geom_point(size = 3) +  # Increase size for better visibility
  scale_color_manual(values = blue_colors) +  # Add blue color scale
  scale_shape_manual(values = c(3, 8, 2, 0)) +  # Define different shapes
  xlab("mean high severity patch size") +
  ylim(0,1.5)+
  ylab("proportion conifer recovered after 5 years") +
  geom_quantile(quantiles = 0.25, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1)) +  # Add quartile regression line (25th percentile)
  geom_quantile(quantiles = 0.5, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1)) +   # Add quartile regression line (50th percentile, median)
  geom_quantile(quantiles = 0.75, method = "rq", formula = y ~ x, color = "black", linetype = "dotted", aes(group = 1)) +  # Add quartile regression line (75th percentile)
  #geom_smooth(method='lm')+
  theme_bw()

# Print the plot
print(plot_33_2_2)


# Boxplots

plot_33_2_1_1 <- ggplot(rdnbr_shapes_merged, aes(x = rdnbr_shape, y = mn_patch_size_3, fill = rdnbr_shape)) +
  geom_boxplot() +
  scale_fill_manual(values = blue_colors) +  # Assuming you have a predefined color scale named 'blue_colors'
  labs(
    title = "Boxplot of Mean Patch Size by rdnbr_shape",
    x = "rdnbr shape",
    y = "Mean High Severity Patch Size"
  ) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_33_2_1_2 <- ggplot(rdnbr_shapes_merged, aes(x = rdnbr_shape, y = percent_conifer_recov_10yr, fill = rdnbr_shape)) +
  geom_boxplot() +
  scale_fill_manual(values = blue_colors) +  # Assuming you have a predefined color scale named 'blue_colors'
  labs(
    title = "Boxplot of percent conifer recovery 10 years postfire",
    x = "rdnbr shape",
    y = "Percent conifer recovery 10 years postfire"
  ) +
  ylim(0,1)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


#Trouble shooting
frequency_table <- table(rdnbr_shapes_merged$percent_conifer_recov_10yr)

# Print the frequency table
print(frequency_table)



```

#AWMPS

```{r}
# Function to calculate AWMPS for a given set of patch areas

calculate_awmps <- function(patch_areas) {
  total_area <- sum(patch_areas)
  awmps <- sum(patch_areas^2) / total_area
  return(awmps)
}

# Create an empty dataframe with three columns
patch_size_aw_mega <- data.frame(
  rdnbr_class = integer(),
  AWMPS = numeric(),
  OBJECTID = integer()
)

for (i in megafire_IDs){
  
  patch_metrics_indiv <- patch_metrics_mega %>%
  filter(OBJECTID == i)

# Calculate AWMPS for each class
awmps_by_class <- patch_metrics_indiv %>%
  group_by(rdnbr_class) %>%
  summarise(AWMPS = calculate_awmps(n))

awmps_by_class$OBJECTID <- i

patch_size_aw_mega <- rbind(patch_size_aw_mega, awmps_by_class)
  
}

# Populate the shape column
patch_size_aw_mega <- patch_size_aw_mega %>%
  mutate(shape = case_when(
    OBJECTID %in% bimodal ~ "bimodal",
    OBJECTID %in% right_skewed ~ "right_skewed",
    OBJECTID %in% left_skewed ~ "left_skewed",
    OBJECTID %in% normal ~ "normal",
    TRUE ~ NA_character_  # Assign NA if OBJECTID is not found in any vector
  ))

patch_size_aw_mega <- patch_size_aw_mega %>%
  filter(rdnbr_class != -1)

# Recode the rdnbr_class values
patch_size_aw_mega <- patch_size_aw_mega %>%
  mutate(rdnbr_class = recode(rdnbr_class,
                              `0` = "unburned",
                              `1` = "low",
                              `2` = "moderate",
                              `3` = "severe"))

patch_size_aw_mega$awmps_ha <- patch_size_aw_mega$AWMPS*0.09

plot_42_1 <- ggplot(patch_size_aw_mega, 
                    aes(x = factor(rdnbr_class, levels = c('unburned', 'low', 'moderate', 'severe')), 
                        y = awmps_ha, 
                        fill = factor(shape, levels = c("bimodal", "left_skewed", "normal", "right_skewed")))) +
  geom_boxplot() +
  scale_fill_manual(values = c('bimodal' = "#648FFF", 'left_skewed' = "#FE6100", 
                               'normal' = "#FFB000", 'right_skewed' = "#DC267F"), 
                    name = "RdNBR shape", 
                    labels = c("bimodal", "log normal", "normal", "right skewed")) +
  scale_y_continuous(labels = scales::comma, limits = c(0, 15000)) +  # Set limits and add thousand separators
  ylab("Area weighted mean patch size (ha)") +
  xlab("RdNBR class") +
  labs(fill = "") +
  theme( legend.position = 'none')

plot_42_1
  
```

# LPI

```{r}
# Load necessary libraries
library(terra)
library(landscapemetrics)
library(dplyr)

# # Define folder paths
# input_folder <- "C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/3310_SN_rdnbr_classified_individual_mega"  # Replace with your folder path
# output_file <- "C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/largest_patch_index.csv"  # Output CSV file for LPI results
# 
# # Get a list of raster files
# raster_files <- list.files(input_folder, pattern = "\\.tif$", full.names = TRUE)
# 
# # Initialize an empty dataframe to store results
# all_patch_metrics_lpi <- data.frame(
#   OBJECTID = character(),
#   class = numeric(),
#   lpi = numeric(),
#   stringsAsFactors = FALSE
# )
# 
# # Loop through each raster (one per fire)
# for (raster_path in raster_files) {
#   # Load the raster
#   fire_raster <- rast(raster_path)
#   
#   patch_metrics <- calculate_lsm(fire_raster, what = "class", directions = 8)
#   
#   patch_metrics_lpi <- patch_metrics %>%
#     filter(metric=='lpi')
#   
#   patch_metrics_lpi$OBJECTID<- tools::file_path_sans_ext(basename(raster_path))
#   
#   patch_metrics_lpi <- patch_metrics_lpi %>%
#     dplyr::select(OBJECTID, class,value) %>%
#     rename(lpi = value)
#     
#   
#   # Combine results (assuming you have an existing dataframe `all_patch_metrics_lpi`)
#   all_patch_metrics_lpi <- bind_rows(all_patch_metrics_lpi, patch_metrics_lpi)
# }
# 
# 
# all_patch_metrics_lpi <- all_patch_metrics_lpi %>%
#   filter(class != -1)
# 
# # Save the results to a CSV file
# write.csv(all_patch_metrics_lpi, output_file, row.names = FALSE)

all_patch_metrics_lpi <- fread("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/largest_patch_index.csv")

# Merge LPI and rdnbr shapes
rdnbr_shapes_merged_lpi <- merge(rdnbr_shapes, all_patch_metrics_lpi, by = "OBJECTID")

# Recode the rdnbr_class values
rdnbr_shapes_merged_lpi <- rdnbr_shapes_merged_lpi %>%
  mutate(class = recode(class,
                              `0` = "unburned",
                              `1` = "low",
                              `2` = "moderate",
                              `3` = "severe"))

lpi_shapes <- ggplot(rdnbr_shapes_merged_lpi, 
                    aes(x = factor(class, levels = c('unburned', 'low', 'moderate', 'severe')), 
                        y = lpi, 
                        fill = factor(rdnbr_shape, levels = c("bimodal", "left_skewed", "normal", "right_skewed")))) +
  geom_boxplot() +
  scale_fill_manual(values = c('bimodal' = "#648FFF", 'left_skewed' = "#FE6100", 
                               'normal' = "#FFB000", 'right_skewed' = "#DC267F"), 
                    name = "RdNBR shape", 
                    labels = c("bimodal", "log normal", "normal", "right skewed")) +
  #scale_y_continuous(labels = scales::comma, limits = c(0, 15000)) +  # Set limits and add thousand separators
  ylab("Largest patch index (LPI)") +
  xlab("RdNBR class") +
  labs(fill = "") 


# Combine AWMPS and LPI plots
# Combine the plots side by side
combined_plot <- plot_grid(plot_42_1, lpi_shapes, labels = c("a", "b"), ncol = 2,rel_widths = c(0.85, 1))



# Create a new dataframe with OBJECTID and perc_c3
fire_metrics_mega_subset <- fire_metrics_mega %>%
  dplyr::select(OBJECTID, perc_c3)

fire_metrics_mega_subset$OBJECTID <- as.character(fire_metrics_mega_subset$OBJECTID)

# Perform a left join
all_patch_metrics_lpi <- all_patch_metrics_lpi %>%
  left_join(fire_metrics_mega_subset, by = "OBJECTID")



# Create a subset with OBJECTID and rdnbr_shape from lpi_shapes
lpi_shapes_subset <- rdnbr_shapes_merged_lpi %>%
  dplyr::select(OBJECTID, rdnbr_shape)

lpi_shapes_subset$OBJECTID <- as.character(lpi_shapes_subset$OBJECTID)

# Perform a left join
all_patch_metrics_lpi <- all_patch_metrics_lpi %>%
  left_join(lpi_shapes_subset, by = "OBJECTID")


df_unique <- all_patch_metrics_lpi %>%
  distinct()

ggplot(df_unique, aes(x = perc_c3, y = lpi, color = factor(rdnbr_shape))) +
  geom_point(size = 3, alpha = 0.7) +  # Points with some transparency
  labs(
    title = "",
    x = "Percent burned at high severity",
    y = "LPI for high severity class",
    color = "RDNBR Shape"  # Adjust legend title for clarity
  ) +
  scale_color_manual(values = c('bimodal' = "#648FFF", 'left_skewed' = "#FE6100", 'normal' = "#FFB000", 'right_skewed' = "#DC267F"))+
  theme_classic() +  # Clean theme
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels
  )

```

```{r}
patches_largest_LPI <- all_patch_metrics_lpi %>%
  filter(lpi>25)



```

#Patch shapes

```{r}

patch_metrics_mega_rand_sub <- patch_metrics_mega %>% sample_frac(1.0)

patch_metrics_mega_rand_sub$rdnbr_class <- as.factor(patch_metrics_mega_rand_sub$rdnbr_class)
patch_metrics_mega_rand_sub <- patch_metrics_mega_rand_sub %>%
  filter(rdnbr_class %in% c(1,2,3))

plot_28_5_1 <- ggplot(data = patch_metrics_mega_rand_sub, aes(x = n, y = core_area)) +
  geom_point(aes(color = rdnbr_class)) +
  labs(title = "", x = "patch size", y = "core area") +
  theme_bw() +
  geom_smooth(aes(group = rdnbr_class, color = rdnbr_class), method = "lm", se = TRUE) +
  scale_color_manual(values = c("1" = "#F6BE00", "2" = '#21918c', "3" = "#440154")) +
  coord_cartesian(xlim = c(0, 5000), ylim = c(0, 500))


# Print the plot
plot_28_5_1


# Calculate slopes and R squared
# Assuming 'patch_metrics_mega_rand_sub' is your dataframe
results <- list()  # to store results

# Unique rdnbr_class values
classes <- unique(patch_metrics_mega_rand_sub$rdnbr_class)

# Loop over each class to fit a model and extract stats
for (class in classes) {
  data_sub <- patch_metrics_mega_rand_sub %>% 
    filter(rdnbr_class == class)
  
  model <- lm(core_area ~ n, data = data_sub)
  
  # Extract coefficients and R-squared
  slope <- coef(model)["n"]  # slope of the regression line
  r_squared <- summary(model)$r.squared  # R-squared
  
  # Store results
  results[[as.character(class)]] <- list(slope = slope, R_squared = r_squared)
}

# Display the results
results

```

#Core area

```{r}

# Binning 'n' and preparing the dataset
patch_metrics_mega <- patch_metrics_mega %>%
  mutate(n_bins = cut(n,
                      breaks = c(1, 100, 1000,10000,1500000),
                      labels = c("small","medium","large","very large"),
                      include.lowest = TRUE))

patch_metrics_mega_con <- patch_metrics_mega %>%
  filter(mode_veg == 7)

patch_metrics_mega_highSev <- patch_metrics_mega_con %>%
  filter(rdnbr_class == 3)

patch_metrics_mega_highSev <- patch_metrics_mega_con %>%
  filter(n > 2)

patch_metrics_mega_core_highSev <- patch_metrics_mega_highSev %>%
  group_by(OBJECTID,n_bins)%>%
  summarize(core_area_sum = sum(core_area))

patch_metrics_mega_perc_core_highSev <- patch_metrics_mega_highSev 
patch_metrics_mega_perc_core_highSev$perc_core <- patch_metrics_mega_perc_core_highSev$core_area/patch_metrics_mega_perc_core_highSev$n

patch_metrics_mega_contiguity_highSev <- patch_metrics_mega_highSev %>%
  group_by(OBJECTID,n_bins)%>%
  summarize(contiguity_mean = mean(contiguity))

patch_metrics_mega_paratio_highSev <- patch_metrics_mega_highSev %>%
  group_by(OBJECTID,n_bins)%>%
  summarize(perimeter_area_mean = mean(perimeter_area))



patch_metrics_mega_core_burned <- patch_metrics_mega_core %>%
  filter(rdnbr_class %in% c(1,2,3))

# Recode rdnbr_class values
patch_metrics_mega_core_burned <- patch_metrics_mega_core_burned %>%
  mutate(rdnbr_class = recode(rdnbr_class,
                              "1" = "low",
                              "2" = "moderate",
                              "3" = "high"))

patch_metrics_mega_core_burned$rdnbr_class <- factor(patch_metrics_mega_core_burned$rdnbr_class, levels = c("low", "moderate", "high"))

# Create the plot with recoded rdnbr_class
plot_28_2 <- ggplot(patch_metrics_mega_core_burned, aes(x = rdnbr_class, y = core_area_sum, fill = rdnbr_class, alpha = 0.5)) +
  geom_violin() +
  stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "burn severity class [rdnbr]", y = "core area within fire") +
  scale_fill_manual(values = c("low" = "#F6BE00", "moderate" = '#21918c', "high" = "#440154")) +
  ylim(0, 30000) +
  theme_bw()

print(plot_28_2)

patch_size_colors <- c('#DC7735','#E48E4F','#ECA569','#F7C69F')

# Create the plot of high severity patches only, by patch size
plot_28_5 <- ggplot(patch_metrics_mega_core_highSev, aes(x = n_bins, y = core_area_sum, fill = n_bins, alpha = 0.5)) +
  geom_violin() +
  stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "patch size class", y = "core area within fire") +
  scale_fill_manual(values = c("small" = "#fff8e7", "medium" = '#88bdbc', "large" = "#254e58", "very large" = "#254e58")) +
  ylim(0, 30000) +
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(face = "bold"),        # Make axis text bold
          axis.title = element_text(face = "bold"),       # Make axis titles bold
          legend.position = "none")

print(plot_28_5)



# Create the plot of high severity patches only, by patch size- percent core area
plot_28_5_1 <- ggplot(patch_metrics_mega_perc_core_highSev, aes(x = n_bins, y = perc_core, fill = n_bins, alpha = 0.5)) +
  geom_violin() +
  stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "patch size class", y = "proportion core area within patch") +
  scale_fill_manual(values = c("small" = "#fff8e7", "medium" = '#88bdbc', "large" = "#254e58", "very large" = "#112d32")) +
  ylim(0, 0.1) +
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(face = "bold"),        # Make axis text bold
          axis.title = element_text(face = "bold"),       # Make axis titles bold
          legend.position = "none")

print(plot_28_5_1)


# Create the plot of high severity patches only, by patch size
plot_28_6 <- ggplot(patch_metrics_mega_contiguity_highSev, aes(x = n_bins, y = contiguity_mean, fill = n_bins, alpha = 0.5)) +
  geom_violin() +
  stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "patch size class", y = "contiguity within fire") +
  scale_fill_manual(values = c("small" = "#fff8e7", "medium" = '#88bdbc', "large" = "#254e58", "very large" = "#112d32")) +
  ylim(0, 1) +
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(face = "bold"),        # Make axis text bold
          axis.title = element_text(face = "bold"),       # Make axis titles bold
          legend.position = "none")

print(plot_28_6)

# Create the plot of high severity patches only, by patch size
plot_28_7 <- ggplot(patch_metrics_mega_paratio_highSev, aes(x = n_bins, y = perimeter_area_mean, fill = n_bins, alpha = 0.5)) +
  geom_violin() +
  stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "patch size class", y = "perimeter:area within fire") +
  scale_fill_manual(values = c("small" = "#fff8e7", "medium" = '#88bdbc', "large" = "#254e58", "very large" = "#112d32")) +
  ylim(0, 0.15) +
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(face = "bold"),        # Make axis text bold
          axis.title = element_text(face = "bold"),       # Make axis titles bold
          legend.position = "none")

print(plot_28_7)


grid.arrange(plot_28_5_1,plot_28_5, plot_28_6, plot_28_7, ncol = 2, padding = unit(3, "cm"))



patch_metrics_mega_core <- patch_metrics_mega %>%
  group_by(OBJECTID,rdnbr_class)%>%
  summarize(core_area_sum = sum(core_area))
```

```{r}
# Binning 'n' and preparing the dataset
patch_metrics_mega <- patch_metrics_mega %>%
  mutate(n_bins = cut(n,
                      breaks = c(1, 100, 1000,10000,1500000),
                      labels = c("small","medium","large","very large"),
                      include.lowest = TRUE))

patch_metrics_mega_con <- patch_metrics_mega %>%
  filter(mode_veg == 7)

patch_metrics_mega_con <- patch_metrics_mega_con %>%
  filter(n > 2)

patch_metrics_mega_core <- patch_metrics_mega_con %>%
  group_by(OBJECTID,n_bins,rdnbr_class)%>%
  summarize(core_area_sum = sum(core_area))

patch_metrics_mega_perc_core <- patch_metrics_mega_con
patch_metrics_mega_perc_core$perc_core <- patch_metrics_mega_perc_core$core_area/patch_metrics_mega_perc_core$n

patch_metrics_mega_contiguity <- patch_metrics_mega_con %>%
  group_by(OBJECTID,n_bins, rdnbr_class)%>%
  summarize(contiguity_mean = mean(contiguity))

patch_metrics_mega_paratio <- patch_metrics_mega_con %>%
  group_by(OBJECTID,n_bins,rdnbr_class)%>%
  summarize(perimeter_area_mean = mean(perimeter_area))



patch_metrics_mega_core_burned <- patch_metrics_mega_core %>%
  filter(rdnbr_class %in% c(1,2,3))

# Recode rdnbr_class values
patch_metrics_mega_core_burned <- patch_metrics_mega_core_burned %>%
  mutate(rdnbr_class = recode(rdnbr_class,
                              "1" = "low",
                              "2" = "moderate",
                              "3" = "high"))

patch_metrics_mega_core_burned$rdnbr_class <- factor(patch_metrics_mega_core_burned$rdnbr_class, levels = c("low", "moderate", "high"))

patch_metrics_mega_perc_core_burned <- patch_metrics_mega_perc_core %>%
  filter(rdnbr_class %in% c(1,2,3))

# Recode rdnbr_class values
patch_metrics_mega_perc_core_burned <- patch_metrics_mega_perc_core_burned %>%
  mutate(rdnbr_class = recode(rdnbr_class,
                              "1" = "low",
                              "2" = "moderate",
                              "3" = "high"))

patch_metrics_mega_perc_core_burned$rdnbr_class <- factor(patch_metrics_mega_perc_core_burned$rdnbr_class, levels = c("low", "moderate", "high"))

patch_metrics_mega_contiguity_burned <- patch_metrics_mega_contiguity %>%
  filter(rdnbr_class %in% c(1,2,3))

# Recode rdnbr_class values
patch_metrics_mega_contiguity_burned <- patch_metrics_mega_contiguity_burned %>%
  mutate(rdnbr_class = recode(rdnbr_class,
                              "1" = "low",
                              "2" = "moderate",
                              "3" = "high"))

patch_metrics_mega_contiguity_burned$rdnbr_class <- factor(patch_metrics_mega_contiguity_burned$rdnbr_class, levels = c("low", "moderate", "high"))

patch_metrics_mega_paratio_burned <- patch_metrics_mega_paratio %>%
  filter(rdnbr_class %in% c(1,2,3))

# Recode rdnbr_class values
patch_metrics_mega_paratio_burned <- patch_metrics_mega_paratio_burned %>%
  mutate(rdnbr_class = recode(rdnbr_class,
                              "1" = "low",
                              "2" = "moderate",
                              "3" = "high"))

patch_metrics_mega_paratio_burned$rdnbr_class <- factor(patch_metrics_mega_paratio_burned$rdnbr_class, levels = c("low", "moderate", "high"))

# core area burned by patch size and severity
plot_28_6_4 <- ggplot(patch_metrics_mega_core_burned, aes(x = n_bins, y = core_area_sum, fill = rdnbr_class, alpha = 0.5)) +
  geom_boxplot() +
  #stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "Patch size class", y = "Core area within fire (ha)") +
  scale_fill_manual(values = c("low" = "#F6BE00", "moderate" = '#21918c', "high" = "#440154")) +
  coord_cartesian(ylim = c(0, 7500)) +  # Set custom y-axis limits
  scale_y_continuous(labels = scales::comma)+ 
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(face = "bold"),        # Make axis text bold
          axis.title = element_text(face = "bold"),       # Make axis titles bold
          legend.position = "none")

print(plot_28_6_4)

# perc core area burned by patch size and severity
plot_28_6_1 <- ggplot(patch_metrics_mega_perc_core_burned, aes(x = n_bins, y = perc_core, fill = rdnbr_class, alpha = 0.5)) +
  geom_boxplot() +
  #stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "Patch size class", y = "Proportion of core area within fire") +
  scale_fill_manual(values = c("low" = "#F6BE00", "moderate" = '#21918c', "high" = "#440154"),scales::comma) +
  #ylim(0, 30000) +
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(face = "bold"),        # Make axis text bold
          axis.title = element_text(face = "bold"),       # Make axis titles bold
          legend.position = "none")

plot_28_6_1

# perimeter:area ratio within patches 

plot_28_6_2 <- ggplot(patch_metrics_mega_paratio_burned, aes(x = n_bins, y = perimeter_area_mean, fill = rdnbr_class, alpha = 0.5)) +
  geom_boxplot() +
  #stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "Patch size class", y = "Perimeter:area") +
  scale_fill_manual(values = c("low" = "#F6BE00", "moderate" = '#21918c', "high" = "#440154"),scales::comma) +
  #ylim(0, 30000) +
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(face = "bold"),        # Make axis text bold
          axis.title = element_text(face = "bold"),       # Make axis titles bold
          legend.position = "none")

plot_28_6_2

# perimeter:area ratio within patches 

plot_28_6_3 <- ggplot(patch_metrics_mega_contiguity_burned, aes(x = n_bins, y = contiguity_mean, fill = rdnbr_class, alpha = 0.5)) +
  geom_boxplot() +
  #stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "Patch size class", y = "Contiguity") +
  scale_fill_manual(values = c("low" = "#F6BE00", "moderate" = '#21918c', "high" = "#440154"),scales::comma) +
  #ylim(0, 30000) +
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(face = "bold"),        # Make axis text bold
          axis.title = element_text(face = "bold"),       # Make axis titles bold
          legend.position = "none")

plot_28_6_3


#grid.arrange(plot_28_5_1,plot_28_5, plot_28_6, plot_28_7, ncol = 2, padding = unit#(3, "cm"))

patch_metrics_mega_core_burned_summary <- patch_metrics_mega_core_burned %>%
  group_by(n_bins, rdnbr_class) %>%
  summarise(
    mean_core_area_sum = mean(core_area_sum, na.rm = TRUE),
    sd_core_area_sum = sd(core_area_sum, na.rm = TRUE)
  )

patch_metrics_mega_contiguity_burned_summary <- patch_metrics_mega_contiguity_burned %>%
  group_by(n_bins, rdnbr_class) %>%
  summarise(
    mean_contiguity = mean(contiguity_mean, na.rm = TRUE),
    sd_contiguity = sd(contiguity_mean, na.rm = TRUE)
  )
  
patch_metrics_mega_paratio_burned_summary <- patch_metrics_mega_paratio_burned %>%
  group_by(n_bins, rdnbr_class) %>%
  summarise(
    mean_paratio = mean(perimeter_area_mean, na.rm = TRUE),
    sd_paratio = sd(perimeter_area_mean, na.rm = TRUE)
  )

patch_metrics_mega_perc_core_burned_summary <- patch_metrics_mega_perc_core_burned %>%
  group_by(n_bins, rdnbr_class) %>%
  summarise(
    mean_perc_core = mean(perc_core, na.rm = TRUE),
    sd_perc_core = sd(perc_core, na.rm = TRUE)
  )
```

```{r}
# The same but including the unburned category

# Binning 'n' and preparing the dataset
patch_metrics_mega <- patch_metrics_mega %>%
  mutate(n_bins = cut(n,
                      breaks = c(1, 100, 1000,10000,1500000),
                      labels = c("small","medium","large","very large"),
                      include.lowest = TRUE))

patch_metrics_mega_con <- patch_metrics_mega %>%
  filter(mode_veg == 7)

patch_metrics_mega_con <- patch_metrics_mega_con %>%
  filter(n > 2)

patch_metrics_mega_core <- patch_metrics_mega_con %>%
  group_by(OBJECTID,n_bins,rdnbr_class)%>%
  summarize(core_area_sum = sum(core_area))

patch_metrics_mega_perc_core <- patch_metrics_mega_con
patch_metrics_mega_perc_core$perc_core <- patch_metrics_mega_perc_core$core_area/patch_metrics_mega_perc_core$n

patch_metrics_mega_contiguity <- patch_metrics_mega_con %>%
  group_by(OBJECTID,n_bins, rdnbr_class)%>%
  summarize(contiguity_mean = mean(contiguity))

patch_metrics_mega_paratio <- patch_metrics_mega_con %>%
  group_by(OBJECTID,n_bins,rdnbr_class)%>%
  summarize(perimeter_area_mean = mean(perimeter_area))



patch_metrics_mega_core_burned <- patch_metrics_mega_core %>%
  filter(rdnbr_class %in% c(0,1,2,3))

# Recode rdnbr_class values
patch_metrics_mega_core_burned <- patch_metrics_mega_core_burned %>%
  mutate(rdnbr_class = recode(rdnbr_class,
                              "0" = "unburned",
                              "1" = "low",
                              "2" = "moderate",
                              "3" = "high"))

patch_metrics_mega_core_burned$rdnbr_class <- factor(patch_metrics_mega_core_burned$rdnbr_class, levels = c("unburned","low", "moderate", "high"))

patch_metrics_mega_perc_core_burned <- patch_metrics_mega_perc_core %>%
  filter(rdnbr_class %in% c(0,1,2,3))

# Recode rdnbr_class values
patch_metrics_mega_perc_core_burned <- patch_metrics_mega_perc_core_burned %>%
  mutate(rdnbr_class = recode(rdnbr_class,
                              "0" = "unburned",
                              "1" = "low",
                              "2" = "moderate",
                              "3" = "high"))

patch_metrics_mega_perc_core_burned$rdnbr_class <- factor(patch_metrics_mega_perc_core_burned$rdnbr_class, levels = c("unburned","low", "moderate", "high"))

patch_metrics_mega_contiguity_burned <- patch_metrics_mega_contiguity %>%
  filter(rdnbr_class %in% c(0,1,2,3))

# Recode rdnbr_class values
patch_metrics_mega_contiguity_burned <- patch_metrics_mega_contiguity_burned %>%
  mutate(rdnbr_class = recode(rdnbr_class,
                              "0" = "unburned",
                              "1" = "low",
                              "2" = "moderate",
                              "3" = "high"))

patch_metrics_mega_contiguity_burned$rdnbr_class <- factor(patch_metrics_mega_contiguity_burned$rdnbr_class, levels = c("unburned","low", "moderate", "high"))

patch_metrics_mega_paratio_burned <- patch_metrics_mega_paratio %>%
  filter(rdnbr_class %in% c(0,1,2,3))

# Recode rdnbr_class values
patch_metrics_mega_paratio_burned <- patch_metrics_mega_paratio_burned %>%
  mutate(rdnbr_class = recode(rdnbr_class,
                              "0" = "unburned",
                              "1" = "low",
                              "2" = "moderate",
                              "3" = "high"))

patch_metrics_mega_paratio_burned$rdnbr_class <- factor(patch_metrics_mega_paratio_burned$rdnbr_class, levels = c("unburned","low", "moderate", "high"))

# core area burned by patch size and severity
plot_28_6_5 <- ggplot(patch_metrics_mega_core_burned, aes(x = n_bins, y = core_area_sum, fill = rdnbr_class, alpha = 0.5)) +
  geom_boxplot() +
  #stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "patch size class", y = "core area within fire") +
  scale_fill_manual(values = c("unburned"="grey","low" = "#F6BE00", "moderate" = '#21918c', "high" = "#440154")) +
  ylim(0, 10000) +
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(face = "bold"),        # Make axis text bold
          axis.title = element_text(face = "bold"),       # Make axis titles bold
          legend.position = "none")

print(plot_28_6_5)

# perc core area burned by patch size and severity
plot_28_6_6 <- ggplot(patch_metrics_mega_perc_core_burned, aes(x = n_bins, y = perc_core, fill = rdnbr_class, alpha = 0.5)) +
  geom_boxplot() +
  #stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "patch size class", y = "proportion of core area within fire") +
  scale_fill_manual(values = c("unburned"="grey","low" = "#F6BE00", "moderate" = '#21918c', "high" = "#440154")) +
  #ylim(0, 30000) +
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(face = "bold"),        # Make axis text bold
          axis.title = element_text(face = "bold"),       # Make axis titles bold
          legend.position = "none")

plot_28_6_6

# perimeter:area ratio within patches 

plot_28_6_7 <- ggplot(patch_metrics_mega_paratio_burned, aes(x = n_bins, y = perimeter_area_mean, fill = rdnbr_class, alpha = 0.5)) +
  geom_boxplot() +
  #stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "patch size class", y = "perimeter:area") +
  scale_fill_manual(values = c("unburned"="grey","low" = "#F6BE00", "moderate" = '#21918c', "high" = "#440154")) +
  #ylim(0, 30000) +
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(face = "bold"),        # Make axis text bold
          axis.title = element_text(face = "bold"),       # Make axis titles bold
          legend.position = "none")

plot_28_6_7

# perimeter:area ratio within patches 

plot_28_6_8 <- ggplot(patch_metrics_mega_contiguity_burned, aes(x = n_bins, y = contiguity_mean, fill = rdnbr_class, alpha = 0.5)) +
  geom_boxplot() +
  #stat_summary(fun = mean, geom = "point", color = "darkorange", shape = 16, size = 2) +  # Add mean points
  labs(title = "", x = "patch size class", y = "contiguity") +
  scale_fill_manual(values = c("unburned"="grey","low" = "#F6BE00", "moderate" = '#21918c', "high" = "#440154")) +
  #ylim(0, 30000) +
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), 
          strip.text = element_text(color = "black"),
          axis.text = element_text(face = "bold"),        # Make axis text bold
          axis.title = element_text(face = "bold"),       # Make axis titles bold
          legend.position = "none")

plot_28_6_8


grid.arrange(plot_28_5_1,plot_28_5, plot_28_6, plot_28_7, ncol = 2, padding = unit(3, "cm"))

```

# Recovery-distance analysis

```{r}
# Universal recovery analysis for one fire

# Declare the OBJECTID
num <- 37023
yr <- 2002

# File paths and other variables using the declared number

distance_highSev_toUnburned_path <- paste0('C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/GIS/Megafires/distance_to_unburned_conifer/',num,'_dist.tif')


veg_folder <- paste0("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/GIS/Recovery/", num, "/")

# Load the raster
distance_highSev_toUnburned <- raster(distance_highSev_toUnburned_path)

# List all TIF files in the folder
veg_files <- list.files(veg_folder, pattern = "\\.tif$", full.names = TRUE)

# Stack the TIF files
veg_stack <- stack(veg_files)

# Extract all veg values
raster_points <- rasterToPoints(distance_highSev_toUnburned)
raster_coordinates <- as.data.frame(raster_points[, 1:2])
stack_values <- extract(veg_stack, raster_coordinates)

value_df <- as.data.frame(cbind(raster_points, stack_values))

# Calculate if a pixel transitioned
value_df <- value_df %>%
  mutate(transitioned = ifelse(!!sym(paste0("X", yr - 1)) == !!sym(paste0("X", yr + 1)), 0, 1))

# Create new columns for each year
years <- (yr+2):2022
for (year in years) {
  column_name <- paste0("trans_returned_to_preFire_veg", year - yr)
  value_df <- value_df %>%
    mutate(!!column_name := ifelse(transitioned == 1 & !!sym(paste0("X", yr - 1)) == !!sym(paste0("X", year)), 1, 0))
}

#value_df$trans_returned_to_preFire_veg <- as.factor(value_df$trans_returned_to_preFire_veg)

value_df_trans <- value_df %>%
  filter(transitioned == 1)

value_df_trans_con <- value_df_trans %>%
  filter(!!sym(paste0("X", yr - 1)) == 7)

# Add distance_class column
value_df_trans_con <- value_df_trans_con %>%
  mutate(distance_class = case_when(
    !!sym(paste0("X", num, "_dist")) >= 0 & !!sym(paste0("X", num, "_dist")) < 150 ~ '<150',
    #!!sym(paste0("X", num, "_dist")) >= 150 & !!sym(paste0("X", num, "_dist")) < 200 ~ '100-200'
    #!!sym(paste0("X", num, "_dist")) >= 200 & !!sym(paste0("X", num, "_dist")) < 300 ~ '200-300',
    !!sym(paste0("X", num, "_dist")) >= 150 ~ '>150'
  ))

# Calculate the total counts for each distance_class
total_counts <- value_df_trans_con %>%
  group_by(distance_class) %>%
  summarize(total_count = n(), .groups = 'drop')

# Create an empty list to store the summary data frames
summary_list <- list()

# Loop over the range of columns from 3 to 30
for (i in 2:20) {
  column_name <- paste0("trans_returned_to_preFire_veg", i)
  summary_df <- value_df_trans_con %>%
    group_by(distance_class, !!sym(column_name)) %>%
    summarize(count = n(), .groups = 'drop') %>%
    left_join(total_counts, by = "distance_class") %>%
    mutate(proportion = count / total_count)
  
  summary_df <- summary_df %>%
    mutate(years = i)
  
  names(summary_df)[names(summary_df) == column_name] <- "trans_preFire"
  
  summary_list[[column_name]] <- summary_df
}

summary_df_combined <- do.call(rbind, summary_list)

# Plot

summary_df_combined <- summary_df_combined %>%
  filter(trans_preFire == 1)

colors <- c('blue','red')

plot_40_3 <- ggplot(summary_df_combined, aes(x = years, y = proportion, color = factor(distance_class), group = factor(distance_class))) +
  geom_line(linewidth=1.5) +
  geom_point(size=2) +
  labs(title = "Proportion of pixels returned to pre-fire vegetation class after X years",
       x = "years post-fire",
       y = "proportion recovered",
       color = "distance from unburned") +
  theme_bw() +
  scale_color_manual(values = colors)


plot_40_3

```

##Recovery by rdnbr shape

```{r}
# Recovery analysis for all fires of one rdnbr shape

bimodal <- c(38341, 37098, 39356, 39756, 39762, 40570, 42350, 21684, 21688, 33025)
# Use the match function to find the indices
indices <- match(bimodal, fire_metrics_mega$OBJECTID)
# Extract the corresponding year values
bimodal_years <- fire_metrics_mega$year[indices]

normal <- c(37928, 42387, 39327, 41747, 42745, 37989, 38018, 38923, 39335, 38120, 37023, 42055, 42380, 39683, 41219, 39674, 37959, 40882, 41627, 40705, 39763, 21679, 21786, 30032)
# Use the match function to find the indices
indices <- match(normal, fire_metrics_mega$OBJECTID)
# Extract the corresponding year values
normal_years <- fire_metrics_mega$year[indices]

right_skewed <- c(39424, 35874, 39430, 41262, 41925, 21678, 21683, 21791, 22057, 22060, 28976, 32384, 33252)
# Use the match function to find the indices
indices <- match(right_skewed, fire_metrics_mega$OBJECTID)
# Extract the corresponding year values
right_skewed_years <- fire_metrics_mega$year[indices]

left_skewed <- c(35032, 35312, 40325, 41837, 35322, 36404, 36180, 33113, 35053)
# Use the match function to find the indices
indices <- match(left_skewed, fire_metrics_mega$OBJECTID)
# Extract the corresponding year values
left_skewed_years <- fire_metrics_mega$year[indices]


# Change here and down at the bottom to summary_df_(left_skewed/right_skewed/normal/bimodal) depending on analysis needed

summary_df_normal <- data.frame()

for (i in seq_along(normal)) {
  num <- normal[i]
  yr <- normal_years[i]

  # File paths and other variables using the declared number

  distance_highSev_toUnburned_path <- paste0('C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/GIS/Megafires/distance_to_unburned_conifer/',num,'_dist.tif')


  veg_folder <- paste0("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/GIS/Recovery/", num, "/")

  # Load the raster
  distance_highSev_toUnburned <- raster(distance_highSev_toUnburned_path)

  # List all TIF files in the folder
  veg_files <- list.files(veg_folder, pattern = "\\.tif$", full.names = TRUE)

  # Stack the TIF files
  veg_stack <- stack(veg_files)

  # Extract all veg values
  raster_points <- rasterToPoints(distance_highSev_toUnburned)
  raster_coordinates <- as.data.frame(raster_points[, 1:2])
  stack_values <- extract(veg_stack, raster_coordinates)

  value_df <- as.data.frame(cbind(raster_points, stack_values))

  # Calculate if a pixel transitioned
  value_df <- value_df %>%
    mutate(transitioned = ifelse(!!sym(paste0("X", yr - 1)) == !!sym(paste0("X", yr + 1)), 0, 1))

  # Create new columns for each year
  years <- (yr+2):2022
  for (year in years) {
    column_name <- paste0("trans_returned_to_preFire_veg", year - yr)
    value_df <- value_df %>%
    mutate(!!column_name := ifelse(transitioned == 1 & !!sym(paste0("X", yr - 1)) == !!sym(paste0("X", year)), 1, 0))
  }

  #value_df$trans_returned_to_preFire_veg <- as.factor(value_df$trans_returned_to_preFire_veg)

  value_df_trans <- value_df %>%
    filter(transitioned == 1)

  value_df_trans_con <- value_df_trans %>%
    filter(!!sym(paste0("X", yr - 1)) == 7)

  # Add distance_class column
  value_df_trans_con <- value_df_trans_con %>%
    mutate(distance_class = case_when(
      !!sym(paste0("X", num, "_dist")) >= 0 & !!sym(paste0("X", num, "_dist")) < 150 ~ '<150',
      #!!sym(paste0("X", num, "_dist")) >= 150 & !!sym(paste0("X", num, "_dist")) < 200 ~ '100-200'
      #!!sym(paste0("X", num, "_dist")) >= 200 & !!sym(paste0("X", num, "_dist")) < 300 ~ '200-300',
      !!sym(paste0("X", num, "_dist")) >= 150 ~ '>150'
    ))

  # Calculate the total counts for each distance_class
  total_counts <- value_df_trans_con %>%
    group_by(distance_class) %>%
    summarize(total_count = n(), .groups = 'drop')

  # Create an empty list to store the summary data frames
  summary_list <- list()

  # Loop over the range of columns from 3 to 30
  for (i in 2:(2022-yr)) {
    column_name <- paste0("trans_returned_to_preFire_veg", i)
    summary_df <- value_df_trans_con %>%
      group_by(distance_class, !!sym(column_name)) %>%
      summarize(count = n(), .groups = 'drop') %>%
      left_join(total_counts, by = "distance_class") %>%
      mutate(proportion = count / total_count)
  
    summary_df <- summary_df %>%
      mutate(years = i)
  
    names(summary_df)[names(summary_df) == column_name] <- "trans_preFire"
  
    summary_list[[column_name]] <- summary_df
  }

  summary_df_combined <- do.call(rbind, summary_list)
  summary_df_combined$fire_year <- yr
  summary_df_combined$OBJECTID <- num
  
  summary_df_normal <- rbind(summary_df_normal, summary_df_combined)
}



# Further analysis

recov_bimodal <- summary_df_bimodal %>%
  filter(trans_preFire==1) %>%
  group_by(years) %>%
  summarize(
    mean_proportion_trans = mean(proportion, na.rm = TRUE),
    sd_proportion_trans = sd(proportion, na.rm= TRUE)
  )

recov_bimodal$rdnbr_shape <- 'bimodal'

recov_right_skewed <- summary_df_right_skewed %>%
  filter(trans_preFire==1) %>%
  group_by(years) %>%
  summarize(
    mean_proportion_trans = mean(proportion, na.rm = TRUE),
    sd_proportion_trans = sd(proportion, na.rm= TRUE)
  )

recov_right_skewed$rdnbr_shape <- 'right_skewed'

recov_left_skewed <- summary_df_left_skewed %>%
  filter(trans_preFire==1) %>%
  group_by(years) %>%
  summarize(
    mean_proportion_trans = mean(proportion, na.rm = TRUE),
    sd_proportion_trans = sd(proportion, na.rm= TRUE)
  )

recov_left_skewed$rdnbr_shape <- 'left_skewed'

recov_normal <- summary_df_normal %>%
  filter(trans_preFire==1) %>%
  group_by(years) %>%
  summarize(
    mean_proportion_trans = mean(proportion, na.rm = TRUE),
    sd_proportion_trans = sd(proportion, na.rm= TRUE)
  )

recov_normal$rdnbr_shape <- 'normal'

recov_allShapes <- rbind(recov_bimodal,recov_left_skewed,recov_right_skewed,recov_normal)

summary_df_bimodal_trans <- summary_df_bimodal %>%
  filter(trans_preFire == 1)

# Plot the line graphs with each unique OBJECTID being one series
ggplot(summary_df_bimodal_trans, aes(x = years, y = proportion, color = OBJECTID, group = OBJECTID)) +
  geom_line(size = 1) +
  labs(
    title = "Proportion Over Years by OBJECTID",
    x = "Years",
    y = "Proportion"
  ) +
  theme_bw()

summary_df_normal_trans <- summary_df_normal %>%
  filter(trans_preFire == 1)

# Plot the line graphs with each unique OBJECTID being one series
ggplot(summary_df_normal_trans, aes(x = years, y = proportion, color = OBJECTID, group = OBJECTID)) +
  geom_line(size = 1) +
  labs(
    title = "Proportion Over Years by OBJECTID",
    x = "Years",
    y = "Proportion"
  ) +
  theme_bw()

summary_df_right_skewed_trans <- summary_df_right_skewed %>%
  filter(trans_preFire == 1)

# Plot the line graphs with each unique OBJECTID being one series
ggplot(summary_df_right_skewed_trans, aes(x = years, y = proportion, color = OBJECTID, group = OBJECTID)) +
  geom_line(size = 1) +
  geom_smooth()+
  labs(
    title = "Proportion Over Years by OBJECTID",
    x = "Years",
    y = "Proportion"
  ) +
  theme_bw()

summary_df_left_skewed_trans <- summary_df_left_skewed %>%
  filter(trans_preFire == 1)

# Plot the line graphs with each unique OBJECTID being one series
ggplot(summary_df_left_skewed_trans, aes(x = years, y = proportion, color = OBJECTID, group = OBJECTID)) +
  geom_line(size = 1) +
  geom_smooth()+
  labs(
    title = "Proportion Over Years by OBJECTID",
    x = "Years",
    y = "Proportion"
  ) +
  theme_bw()
```

#NDVI Recovery

```{r}



```

```{r}
recovery_metrics_mega_highSev <- recovery_metrics_mega %>%
  filter(rdnbr_class == 3)

patch_size_aw_mega <- patch_size_aw_mega %>%
  mutate(rdnbr_class = recode(rdnbr_class,
                              "unburned" = 0,
                              "low" = 1,
                              "moderate" = 2,
                              "severe" = 3))

joined_df <- inner_join(patch_size_aw_mega, rdnbr_shapes_merged, by = c("rdnbr_class", "OBJECTID"))


patch_metrics_mega_very_large <- patch_metrics_mega %>%
  filter(n_bins == 'very large')

patch_metrics_mega_very_large_high_sev <- patch_metrics_mega_very_large %>%
  filter(rdnbr_class == 3)

patch_metrics_mega_very_large_mod_sev <- patch_metrics_mega_very_large %>%
  filter(rdnbr_class == 2)
```

# Veg histograms

```{r}


```

# Proportion veg/sev

# Individual

```{r}
library(raster)
library(rgdal)
library(ggplot2)
library(sp)
library(sf)
library(rgeos)
library(dplyr)
library(here)
library(stringr)
library(mgcv)
library(e1071)

pixel_df <- read.csv("C:/Users/jscho/Documents/pixel_dfs_megafires/42745.csv", header=TRUE)  

pixels_only_veg <- subset(pixel_df, RF_pre_veg %in% c("1", "4", "5","7")) 

pixels_only_veg$RF_pre_veg <- as.factor(pixels_only_veg$RF_pre_veg)

# Colors for cover types
colors_all <- c('1' = '#956733', '2' = '#a7b5a5', '3' = '#0940ca', '4' = '#d8bf58', '5' = '#6dcd2b', '6' = '#ffacc9', '7' = '#0e4f12')

# -------------------------------------------------------------------------------------------------


# Plot prop veg type by severity 

print(unique(pixel_df$RF_pre_veg))

# Calculate the proportions of RF_pre_veg within each rdnbr_class
pixel_df_summary <- pixel_df %>%
  group_by(rdnbr_class, RF_pre_veg) %>%
  summarise(count = n()) %>%
  mutate(proportion = count / sum(count)) %>%
  ungroup()

pixel_df_summary$RF_pre_veg <- as.factor(pixel_df_summary$RF_pre_veg)  

# Create the stacked bar chart with custom colors
stacked_bar_chart <- ggplot(pixel_df_summary, aes(x = rdnbr_class, y = proportion, fill = RF_pre_veg)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = colors_all) +
  labs(title = "Stacked Bar Chart of RF_pre_veg Proportions by rdnbr_class",
       x = "RDNBR Class",
       y = "Proportion",
       fill = "RF_pre_veg") +
  theme_minimal()
```

# Proportion veg/sev

# All megafires

```{r}
# Colors for cover types
colors_all <- c('1' = '#956733', '2' = '#a7b5a5', '3' = '#0940ca', '4' = '#d8bf58', '5' = '#6dcd2b', '6' = '#ffacc9', '7' = '#0e4f12')

# Create empty dataframe

veg_sev_counts_master <- data.frame(
  rdnbr_class = integer(),
  RF_pre_veg = factor(),
  count=integer(),
  proportion = numeric(),
  OBJECTID = integer()
)

# -------------------------------------------------------------------------------------------------

for (num in megafire_IDs){
  
pixel_filename <- paste0("C:/Users/jscho/Documents/pixel_dfs_megafires/",num,".csv")
pixel_df <- fread(pixel_filename, header=TRUE)  


# Calculate the proportions of RF_pre_veg within each rdnbr_class
pixel_df_summary <- pixel_df %>%
  group_by(rdnbr_class, RF_pre_veg) %>%
  summarise(count = n()) %>%
  mutate(proportion = count / sum(count)) %>%
  ungroup()

pixel_df_summary$RF_pre_veg <- as.factor(pixel_df_summary$RF_pre_veg)  
pixel_df_summary$OBJECTID <-num

veg_sev_counts_master <- rbind(veg_sev_counts_master, pixel_df_summary)}


# Calculate the proportions of RF_pre_veg within each rdnbr_class
veg_sev_counts_summary <- veg_sev_counts_master %>%
  group_by(rdnbr_class, RF_pre_veg) %>%
  summarize(total_count = sum(count, na.rm = TRUE))%>%
  mutate(proportion = total_count / sum(total_count)) %>%
  ungroup()

veg_sev_counts_summary <- veg_sev_counts_summary %>%
  filter(rdnbr_class != -1)

# Create the stacked bar chart with custom colors, proportions
plot_45 <- ggplot(veg_sev_counts_summary, aes(x = rdnbr_class, y = proportion, fill = RF_pre_veg)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_fill_manual(values = colors_all) +
  labs(title = "Stacked Bar Chart of RF_pre_veg Proportions by rdnbr_class",
       x = "RDNBR Class",
       y = "Proportion",
       fill = "RF_pre_veg") +
  theme_classic()

# Create the stacked bar chart with custom colors, absolute numbers
plot_45_1 <- ggplot(veg_sev_counts_summary, aes(x = rdnbr_class, y = total_count, fill = RF_pre_veg, alpha=0.5)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = colors_all) +
  labs(title = "",
       x = "RDNBR Class",
       y = "Area",
       fill = "RF_pre_veg") +
  theme_bw()

# Only vegetation

veg_sev_counts_summary_vegOnly <- veg_sev_counts_summary %>%
  filter(RF_pre_veg %in% c("1", "4", "5","7"))

veg_sev_counts_summary_vegOnly$total_area_ha <- veg_sev_counts_summary_vegOnly$total_count*0.09

plot_45_2 <- ggplot(veg_sev_counts_summary_vegOnly, aes(x = factor(rdnbr_class), y = total_area_ha, fill = RF_pre_veg)) +
  geom_bar(stat = "identity", position = "stack",alpha=0.6) +
scale_fill_manual(
    values = colors_all,
    name = "Pre-fire veg type",
    labels = c("shrub", "grassland","herbaceous","conifer")
  ) +
  labs(
    title = "",
    x = "RdNBR class",
    y = "Area burned (ha)"
  ) +
  scale_x_discrete(
    labels = c('0' = 'unburned', '1' = 'low', '2' = 'moderate', '3' = 'high')
  ) +
  scale_y_continuous(labels = scales::comma) +  # Add thousands separators
  theme_bw() +
  theme(
    axis.title.x = element_text(margin = margin(t = 10),size=12, face='bold'),  # Add space on top of x-axis label
    axis.title.y = element_text(margin = margin(r = 10),size= 12, face='bold'),  # Add space to the right of y-axis label
    axis.text.x = element_text(angle = 0, hjust = 1,size=12),
    axis.text.y = element_text(size=12),# Angle x-axis labels to 45 degrees
    legend.position = c(0.06, 0.95),  # Move the legend inside the plot, top left
    legend.justification = c(0, 1),  # Adjust the alignment of the legend
    legend.title = element_text(size = 12), #, face = "bold"
    legend.text = element_text(size = 10),
    panel.grid = element_blank()  # Remove all gridlines
  )

```

```{r}
# Burn severity map

library(ggspatial)

fire_outline <- st_read("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/3310_SN_megafires_shp_individual/2012/39327.shp")

mega_rast_class <- rast("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/3310_SN_rdnbr_classified_individual_mega/39327.tif")

# Convert raster to data frame for ggplot
raster_df <- as.data.frame(mega_rast_class, xy = TRUE)


# Rename the raster value column (assuming single-layer raster)
colnames(raster_df)[3] <- "value"  # Renaming the value column
# Replace all -1 with 0 in the 'value' column of raster_df
raster_df <- raster_df %>%
  mutate(value = ifelse(value == -1, 0, value))

# Plot the map with shapefile and raster
map_rdnbr <- ggplot() +
  # Add shapefile (Layer 1)
  geom_sf(data = fire_outline, aes(fill = "Layer 1"), color = "black", alpha = 0.5) +  
  scale_fill_manual(
    values = c("Layer 1" = "lightgrey"),
    name = "",  # Legend title
    labels = c("KNP Complex fire")  # Custom labels
  ) +
  # Add raster layer
  geom_raster(data = raster_df, aes(x = x, y = y, fill = as.factor(value))) +
  scale_fill_manual(
    values = c("0" = "lightgrey", "1" = "#F6BE00", "2" = '#21918c', "3" = "#440154"),
    name = "Burn severity (RdNBR)",  # Custom legend title
    labels = c("unburned", "low", "moderate", "high")  # Custom labels
  ) + 
  theme_bw() +
  labs(
    title = "",
    subtitle = ""
  ) +
  theme(
    legend.position = c(0.15, 0.17),  # Position the legend
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  )+
     annotation_north_arrow(location = "br", which_north = "true", 
                         pad_x = unit(0.4, "in"), pad_y = unit(0.19, "in"),
                         style = north_arrow_fancy_orienteering) + 
  annotation_scale(location = "bl", width_hint = 0.5, style = "bar") 



# Map ohne alles

# Plot the map with shapefile and raster
map_rdnbr <- ggplot() +
  # Add shapefile (Layer 1)
  geom_sf(data = fire_outline, aes(fill = "Layer 1"), color = "black", alpha = 0.5) +  
  scale_fill_manual(
    values = c("Layer 1" = "lightgrey"),
    name = "",  # Legend title
    labels = c("KNP Complex fire")  # Custom labels
  ) +
  # Add raster layer
  geom_raster(data = raster_df, aes(x = x, y = y, fill = as.factor(value))) +
  scale_fill_manual(
    values = c("0" = "lightgrey", "1" = "#F6BE00", "2" = '#21918c', "3" = "#440154"),
    name = "Burn severity (RdNBR)",  # Custom legend title
    labels = c("unburned", "low", "moderate", "high")  # Custom labels
  ) + 
  theme_classic() +
  labs(
    title = "",
    subtitle = ""
  )



```

```{r}
#Pre-/post-fire vegetation maps

veg_rast_1pre <- rast("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/veg_annual_individual/22057/2006_22057.tif")
veg_rast_1post <- rast("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/veg_annual_individual/22057/2008_22057.tif")

# Convert raster to data frame for ggplot
raster_df <- as.data.frame(veg_rast_1pre, xy = TRUE)

# Rename the raster value column (assuming single-layer raster)
colnames(raster_df)[3] <- "value"  # Renaming the value column

ggplot() + 
  geom_sf(data = fire_outline, aes(fill = "Layer 1"), color = "black", alpha = 0.5) +  
  scale_fill_manual(
    values = c("Layer 1" = "lightgrey"),
    name = "",  # Legend title
    labels = c("KNP Complex fire")  # Custom labels
  ) +
  geom_raster(data = raster_df, aes(x = x, y = y, fill = as.factor(value))) + 
  scale_fill_manual(
    values = c('1' = '#956733', '2' = '#a7b5a5', '3' = '#0940ca', '4' = '#d8bf58', '5' = '#6dcd2b', '6' = '#ffacc9', '7' = '#0e4f12'),
    name = "Vegetation type",  # Custom legend title
    labels = c("Shrub", "Rock", "Water", "Open/grassland", "Herbaceous","Barren soil","Coniferous")  # Custom labels
  ) + 
  coord_sf() +  # Use coord_sf() for spatial data
  theme_minimal() + 
  theme(
    panel.grid = element_blank(),  # Remove gridlines
    axis.title = element_blank(),  # Remove axis titles
    axis.text = element_blank(),   # Remove axis text
    axis.ticks = element_blank(),  # Remove axis ticks
    legend.position = "right",     # Place legend on the right
    legend.title = element_text(size = 12, face = "bold"),  # Customize legend title
    legend.text = element_text(size = 10),  # Customize legend text
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")  # Customize plot title
  ) +
  #ggtitle("KNP Complex Fire pre-fire vegetation types") +
  annotation_scale(location = "bl", width_hint = 0.5, style="bar")  # Add a scalebar at the bottom left




# Post-fire vegetation

# Convert raster to data frame for ggplot
raster_df <- as.data.frame(veg_rast_1post, xy = TRUE)

# Rename the raster value column (assuming single-layer raster)
colnames(raster_df)[3] <- "value"  # Renaming the value column


ggplot() + 
  geom_sf(data = fire_outline, aes(fill = "Layer 1"), color = "black", alpha = 0.5) +  
  scale_fill_manual(
    values = c("Layer 1" = "lightgrey"),
    name = "",  # Legend title
    labels = c("KNP Complex fire")  # Custom labels
  ) +
  geom_raster(data = raster_df, aes(x = x, y = y, fill = as.factor(value))) + 
  scale_fill_manual(
    values = c('1' = '#956733', '2' = '#a7b5a5', '3' = '#0940ca', '4' = '#d8bf58', '5' = '#6dcd2b', '6' = '#ffacc9', '7' = '#0e4f12'),
    name = "Vegetation type",  # Custom legend title
    labels = c("Shrub", "Rock", "Water", "Open/grassland", "Herbaceous","Barren soil","Coniferous")  # Custom labels
  ) + 
  coord_sf() +  # Use coord_sf() for spatial data
  theme_minimal() + 
  theme(
    panel.grid = element_blank(),  # Remove gridlines
    axis.title = element_blank(),  # Remove axis titles
    axis.text = element_blank(),   # Remove axis text
    axis.ticks = element_blank(),  # Remove axis ticks
    legend.position = "right",     # Place legend on the right
    legend.title = element_text(size = 12, face = "bold"),  # Customize legend title
    legend.text = element_text(size = 10),  # Customize legend text
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")  # Customize plot title
  ) +
  #ggtitle("KNP Complex Fire pre-fire vegetation types") +
  annotation_scale(location = "bl", width_hint = 0.5, style="bar")  # Add a scalebar at the bottom left




```

# Distance from seed source for all fires

```{r}
# Making sure to just include pixels burned at (1) high severity [distance values only available for high sev anyways] and (2) those pixels that were classified as coniferous pre-fire

# Function to select rows based on distance_class values
select_rows <- function(df) {
  # Check the number of rows
  num_rows <- nrow(df)
  
  # Initialize the result with the first row
  result <- df[1, , drop = FALSE]
  
  # Check if there are more rows to evaluate
  if (num_rows >= 2) {
    if (df[2, "distance_class"] != df[1, "distance_class"]) {
      result <- rbind(result, df[2, , drop = FALSE])
    }
  }
  
  return(result)
}

# Create empty dataframe to store sample sizes for each distance class within each fire

samp_size <- data.frame(
  distance_class = character(),
  sample_size = numeric(),
  OBJECTID = numeric(),
  stringsAsFactors = FALSE  # Ensure strings are not converted to factors
)

#i <- 5
for(i in seq_along(yrs)) {
  fire_year <- yrs[i]
  num <- OBJECTIDs[i]
  print(fire_year)
  print(num)
  pre_fire_year <- fire_year - 1
  print(fire_year)
  print(num)
  
#Distances from edge of interest
a <- 0
b <- 150

range_string1 <- paste(a,"-", b, sep = "")
range_string2 <- paste(">", b, sep = "")


# File paths and other variables using the declared number
distance_highSev_toUnburned_path <- paste0("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/GIS/Megafires/distance_to_unburned_conifer/", num, "_dist.tif")

# Load the raster
distance_highSev_toUnburned <- raster(distance_highSev_toUnburned_path)

pre_fire_veg <- stack(paste0("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/GIS/Recovery/",num,"/",pre_fire_year,".tif"))

# Extract all veg values
raster_points <- rasterToPoints(distance_highSev_toUnburned)
raster_coordinates <- as.data.frame(raster_points[, 1:2])
stack_values <- raster::extract(pre_fire_veg, raster_coordinates)

value_df <- as.data.frame(cbind(raster_points, stack_values))

# Ensure we're only looking at conifer pixels
value_df_conifer <- value_df %>%
  filter(!!sym(paste0("X",pre_fire_year))==7)

# Add distance_class column
value_df_conifer <- value_df_conifer %>%
  mutate(distance_class = case_when(
    !!sym(paste0("X", num, "_dist")) >= a & !!sym(paste0("X", num, "_dist")) < b ~ range_string1,
    !!sym(paste0("X", num, "_dist")) >= b ~ range_string2
  ))

value_df_conifer <- value_df_conifer %>%
  mutate(distance_class = factor(distance_class, levels = c(range_string1, range_string2)))


value_df_conifer_grouped <- value_df_conifer %>%
  group_by(distance_class) %>%
  summarize(sample_size = n())

# Separate dataframe for sample sizes
sample_sizes_df <- value_df_conifer_grouped %>%
  dplyr::select(distance_class, sample_size)

sample_sizes_df <- select_rows(sample_sizes_df)
sample_sizes_df$OBJECTID <- num
sample_sizes_df$year <- fire_year

samp_size <- rbind(samp_size,sample_sizes_df)

}

samp_size_grouped <- samp_size %>%
  group_by(OBJECTID) %>%
  summarize(total_sample_size = sum(sample_size, na.rm = TRUE))

joined_df <- left_join(samp_size, samp_size_grouped, by = "OBJECTID")

options(scipen=999)

joined_df$perc <- (joined_df$sample_size/joined_df$total_sample_size)*100

write.csv(joined_df, file = "C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/GIS/Recovery/area_distance_to_unburned.csv", row.names = FALSE)
```

#Distance from seed source over time

```{r}
# Read in distance file 

distance_mega <- read.csv("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/GIS/Recovery/area_distance_to_unburned.csv", header=TRUE)

# What proportion is further than 150m from seed source?

distance_mega_sum <- distance_mega %>%
  group_by(distance_class)%>%
  summarise(total_area_px = sum(sample_size))

# Sum up and calculate proportion --> 7.366% of conifer burned at high severity >150m from live seed source

# Group by year and distance_class, and sum the sample_size
distance_mega_summary <- distance_mega %>%
  group_by(year, distance_class) %>%
  summarise(sample_size_sum = sum(sample_size, na.rm = TRUE))

# Create the stacked bar plot
ggplot(distance_mega_summary, aes(x = year, y = sample_size_sum, fill = distance_class)) +
  geom_bar(stat = "identity") +
  labs(title = "Sample Size Sum by Year and Distance Class",
       x = "Year",
       y = "Sample Size Sum",
       fill = "Distance Class") +
  theme_minimal()

distance_mega_summary_far <- distance_mega_summary %>%
  filter(distance_class == '>150')

# Add all years, even 0 ones

# Create a dataframe with all combinations of years and distance classes
years <- 1985:2020
distance_classes <- c(">150", "<150")

# Expand grid to create all combinations
all_combinations <- expand.grid(year = years, distance_class = distance_classes)

# Ensure the existing dataframe has the correct column types
distance_mega_summary_far <- distance_mega_summary_far %>%
  mutate(year = as.integer(year), distance_class = as.character(distance_class))

# Join all combinations with the existing dataframe, adding missing rows
distance_mega_summary_far_complete <- all_combinations %>%
  left_join(distance_mega_summary_far, by = c("year", "distance_class")) %>%
  mutate(sample_size_sum = ifelse(is.na(sample_size_sum), 0, sample_size_sum))



# Create the stacked bar plot for just far pixels
plot_61 <- ggplot(distance_mega_summary_far_complete, aes(x = year, y = sample_size_sum)) +
  geom_bar(stat = "identity") +
  labs(title = "",
       x = "Year",
       y = "high severity area >150m from live conifer") +
  theme_bw()+
  geom_smooth(data = distance_mega_summary_far, aes(x = year, y = sample_size_sum),method = "glm", method.args = list(family = "poisson"), se = TRUE, color="black")

```

# Spatial characteristics over time

```{r}
# How are spatial characteristics of fires/ patches changing over time? --> awmps, core area, contiguity, edge:area

```

# Burned area by vegetation type

```{r}


```

# RdNBR histograms by fire

```{r}
library(raster)
library(rgdal)
library(ggplot2)
library(sp)
library(sf)
library(rgeos)
library(dplyr)
library(here)
library(stringr)
library(mgcv)
library(e1071)



# Histograms by veg type

pixel_df <- fread("C:/Users/jscho/Documents/pixeld_dfs_megafires/.csv", header=TRUE)  
 
 # Histograms by burn severity
pixel_df$rdnbr_class <- as.factor(pixel_df$rdnbr_class) 
 
plot <- ggplot(pixel_df, aes(x = rdnbr, fill = rdnbr_class, alpha=0.4)) +
  geom_histogram(position = "identity", bins = 100) +
  xlim(-1000,2000)+
  xlab("mean burn severity [rdnbr]") +
  scale_fill_manual(values = c('-1'= '#808080', '0' = '#808080', '1'="#fde725",'2'="#21918c",'3'="#440154"))+
  theme_bw()+
  theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), strip.text = element_text(color = "black")) +
  theme(legend.position = "none")



# Define the input and output directories
input_dir <- "C:/Users/jscho/Documents/pixeld_dfs_megafires/"
output_dir <- "C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Outputs/Megafires/rdnbr_histograms_new/"

# List all CSV files in the input directory
csv_files <- list.files(input_dir, pattern = "\\.csv$", full.names = TRUE)

# Loop through each file, create the histogram, and save it
for (file in csv_files) {
  
  # Extract the file name without extension to use in plot filename
  file_name <- tools::file_path_sans_ext(basename(file))
  
  # Read the CSV file
  pixel_df <- fread(file, header = TRUE)

  
  # Convert 'rdnbr_class' to a factor
  pixel_df$rdnbr_class <- as.factor(pixel_df$rdnbr_class)
  
  # Create the histogram
  plot <- ggplot(pixel_df, aes(x = rdnbr, fill = rdnbr_class, alpha=0.4)) +
    geom_histogram(position = "identity", bins = 100) +
    xlim(-1000, 2000) +
    xlab("Mean burn severity [rdnbr]") +
    scale_fill_manual(values = c('-1'= '#808080', '0' = '#808080', '1' = "#fde725", '2' = "#21918c", '3' = "#440154")) +
    theme_bw() +
    theme(strip.background = element_rect(fill = "lightgrey", color = "grey"),
          strip.text = element_text(color = "black"),
          legend.position = "none")
  
  # Save the plot as a PNG file
  output_path <- file.path(output_dir, paste0(file_name, "_histogram.png"))
  ggsave(output_path, plot, width = 8, height = 6, dpi = 300)
  
  # Print a message confirming save
  print(paste("Saved histogram for", file_name, "to", output_path))
}




pixels_only_veg <- subset(pixel_df, RF_pre_veg %in% c("1", "4", "5","7")) 
pixels_only_veg$RF_pre_veg <- as.factor(pixels_only_veg$RF_pre_veg)

 plot <- ggplot(pixels_only_veg, aes(x = rdnbr, fill = RF_pre_veg)) +
    geom_histogram(position = "identity", bins = 100, alpha = 0.4) +
    xlim(c(-1000, 2000)) +
    xlab("mean burn severity [rdnbr]") +
    scale_fill_manual(values = c('7' = '#0e4f12','1' = '#956733', '4' = '#d8bf58', '5' = '#6dcd2b')) +
    theme_bw() +
    theme(strip.background = element_rect(fill = "lightgrey", color = "grey"), strip.text = element_text(color = "black")) +
    theme(legend.position = "none")
 
```

```{r}
# Vegetation histogram for all pixels
#input_dir <- "C:/Users/jscho/Documents/pixel_dfs_megafires/"

# List all CSV files in the input directory
#csv_files <- list.files(input_dir, pattern = "\\.csv$", full.names = TRUE)

# Initialize an empty master dataframe
#master_df <- data.frame()

# Loop through each file, create the histogram, and save it
#for (file in csv_files) {
  
  # Extract the file name without extension to use in plot filename
#  file_name <- tools::file_path_sans_ext(basename(file))
  
  # Read the CSV file
#  pixel_df <- fread(file, header = TRUE)

 # pixel_df <- pixel_df %>%
 #   filter(RF_pre_veg %in% c(1,4,5,7))
  
#  pixel_df <- pixel_df %>%
#    dplyr::select(RF_pre_veg,OBJECTID,rdnbr,id)
  
  # Append the current pixel_df to the master dataframe
#  master_df <- rbind(master_df, pixel_df)
  
#}

#write.csv(master_df,"C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/megafires_pixel_df_veg_only_rdnbr_patchSize.csv",row.names=FALSE)

master_df <- fread("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Dataframes/megafires_pixel_df_veg_only_rdnbr_patchSize.csv")

master_df$RF_pre_veg <- as.factor(master_df$RF_pre_veg)
master_df$RF_pre_veg <- factor(master_df$RF_pre_veg, levels = c(7, 1, 4, 5))

plot_45_3 <- ggplot(master_df, aes(x = rdnbr, fill = RF_pre_veg)) +
  geom_histogram(position = "identity", bins = 100, alpha = 0.6) +
  xlim(c(-1000, 2000)) +
  scale_fill_manual(values = c('1' = '#956733', '4' = '#d8bf58', '5' = '#6dcd2b', '7' = '#0e4f12')) +
  labs(
    title = "",
    y = "Count",
    x = "Burn severity (RdNBR)"
  ) +
  scale_y_continuous(labels = scales::comma) +  # Add thousands separators
  theme_bw() +
  theme(
    axis.title.x = element_text(margin = margin(t = 10), size=12,face= 'bold'),  # Add space on top of x-axis label
    axis.title.y = element_text(margin = margin(r = 10), size=12, face='bold'),  # Add space to the right of y-axis label
    axis.text.x = element_text(angle = 0, hjust = 1, size=12),
    axis.text.y = element_text(size=12),# Angle x-axis labels
    legend.position = "none",  # Hide legend
    panel.grid = element_blank()  # Remove all gridlines
  )
```

```{r}
library(raster)
library(rasterVis)

# Define the directory containing the raster files
input_dir <- "C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/veg_annual_individual/22057"

# List all the raster files in the directory
raster_files <- list.files(input_dir, pattern = "\\.tif$", full.names = TRUE)

# Stack all the raster files
raster_stack <- stack(raster_files)

# Define custom color mapping for values
custom_colors <- c('1' = '#956733', 
                   '2' = '#a7b5a5', 
                   '3' = '#0940ca', 
                   '4' = '#d8bf58', 
                   '5' = '#6dcd2b', 
                   '6' = '#ffacc9', 
                   '7' = '#0e4f12')

# Plot the raster stack using the custom colors
levelplot(raster_stack, col.regions = custom_colors, at = 1:7)

```

```{r}
# Faceted burn severity histograms of four example fires 

# Read the CSV file
#21683, 21688, 39327, 40882
  pixel_df <- fread("C:/Users/jscho/OneDrive - University of Cambridge/PhD/Analyses/Data/raster_df_mega/39327.csv", header = TRUE)
  
  pixeld_df <- pixel_df %>%
    dplyr::select(OBJECTID, rdnbr,RF_pre_veg,fire_year,rdnbr_class )
  
  pixeld_df$name <- 'Rush'

  master_pixel <- rbind(master_pixel,pixeld_df)
  # Convert 'rdnbr_class' to a factor
  master_pixel$rdnbr_class <- as.factor(master_pixel$rdnbr_class)
  
  # Create the histogram
  plot_70 <- ggplot(master_pixel, aes(x = rdnbr, fill = rdnbr_class, alpha = 0.4)) +
    geom_histogram(position = "identity", bins = 100) +
    xlim(-1000, 2000) +
    xlab("Burn severity [RdNBR]") +
    ylab("Count")+
    scale_y_continuous(labels = scales::comma)+ 
    scale_fill_manual(values = c('-1' = '#808080', '0' = '#808080', '1' = "#fde725", '2' = "#21918c", '3' = "#440154")) +
    #theme_bw() +
     theme(
    panel.grid = element_blank(),  # Remove all gridlines
    strip.background = element_rect(fill = "lightgrey", color = "black"),  # Add black border around facet headers
    strip.text = element_text(color = "black"),  # Set text color in facet headers
    legend.position = "none"  # Remove the legend
  ) +
    facet_wrap(~ name)  # Facet by 'name'
```
