# -------------------------------------------------------------------
# Patch sizes and area by patch size class, all patches
# -------------------------------------------------------------------
# Bin 'n' and prepare dataset
patch_metrics_mega <- patch_metrics_mega %>%
mutate(
n_bins = cut(
n,
breaks = c(1, 100, 1000, 10000, 1500000),
labels = c("small", "medium", "large", "very large"),
include.lowest = TRUE
)
)
patch_metrics_mega$area_ha       <- patch_metrics_mega$n * 0.09
patch_metrics_mega$outer_area_ha <- patch_metrics_mega$area_ha - patch_metrics_mega$core_area
# Step 1: Pivot to long format for stacked bars
patch_long <- patch_metrics_mega %>%
pivot_longer(
cols      = c(core_area, outer_area_ha),
names_to  = "area_type",
values_to = "area_val"
)
# Step 2: Summarise total area per bin and type
patch_summary <- patch_long %>%
group_by(n_bins, area_type) %>%
summarise(total_area = sum(area_val, na.rm = TRUE), .groups = "drop")
# Step 3: Totals, counts, and cumulative areas per bin
patch_counts <- patch_metrics_mega %>%
group_by(n_bins) %>%
summarise(count = n(), .groups = "drop")
patch_totals <- patch_summary %>%
group_by(n_bins) %>%
summarise(total_area_sum = sum(total_area), .groups = "drop") %>%
left_join(patch_counts, by = "n_bins") %>%
arrange(as.numeric(n_bins)) %>%
mutate(cumulative_area = cumsum(total_area_sum))
patch_core_cumulative <- patch_summary %>%
filter(area_type == "core_area") %>%
arrange(as.numeric(n_bins)) %>%
group_by(n_bins) %>%
summarise(core_area_total = sum(total_area, na.rm = TRUE), .groups = "drop") %>%
mutate(cumulative_core_area = cumsum(core_area_total))
patch_outer_cumulative <- patch_summary %>%
filter(area_type == "outer_area_ha") %>%
arrange(as.numeric(n_bins)) %>%
group_by(n_bins) %>%
summarise(outer_area_total = sum(total_area, na.rm = TRUE), .groups = "drop") %>%
mutate(cumulative_outer_area = cumsum(outer_area_total))
# Step 4: Plot
cum_1 <- ggplot(patch_summary, aes(x = as.factor(n_bins), y = total_area, fill = area_type)) +
geom_bar(stat = "identity") +
# Count labels
geom_text(
data = patch_totals,
aes(x = as.factor(n_bins), y = total_area_sum, label = scales::comma(count)),
vjust = -0.5, size = 3.5, inherit.aes = FALSE
) +
# Cumulative total area line
geom_line(
data = patch_totals,
aes(x = as.factor(n_bins), y = cumulative_area, group = 1),
color = "darkred", size = 1, inherit.aes = FALSE
) +
geom_point(
data = patch_totals,
aes(x = as.factor(n_bins), y = cumulative_area),
color = "darkred", size = 2, inherit.aes = FALSE
) +
# Fill & labels
scale_fill_manual(
values = c("core_area" = "orange", "outer_area_ha" = "lightgrey"),
labels = c("core_area" = "core area", "outer_area_ha" = "outer area"),
name   = NULL
) +
scale_y_continuous(labels = scales::comma) +
labs(
title = "",
x = "Patch size",
y = "Total area (ha)",
fill = "Area type"
) +
theme_classic() +
theme(
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x      = element_text(angle = 0, hjust = 1),
axis.title       = element_text(face = "bold"),
axis.text        = element_text(face = "bold")
) +
# Cumulative core area (dashed)
geom_line(
data = patch_core_cumulative,
aes(x = as.factor(n_bins), y = cumulative_core_area, group = 1),
color = "darkorange", size = 1, linetype = "dashed", inherit.aes = FALSE
) +
geom_point(
data = patch_core_cumulative,
aes(x = as.factor(n_bins), y = cumulative_core_area),
color = "darkorange", size = 2, inherit.aes = FALSE
) +
# Cumulative outer area (dashed)
geom_line(
data = patch_outer_cumulative,
aes(x = as.factor(n_bins), y = cumulative_outer_area, group = 1),
color = "grey40", size = 1, linetype = "dashed", inherit.aes = FALSE
) +
geom_point(
data = patch_outer_cumulative,
aes(x = as.factor(n_bins), y = cumulative_outer_area),
color = "grey40", size = 2, inherit.aes = FALSE
) +
# Annotations
annotate(
"text",
x = Inf, y = max(patch_totals$cumulative_area, na.rm = TRUE),
label = "cumulative total area", color = "darkred",
hjust = 1.1, vjust = -0.5, size = 3.5
) +
annotate(
"text",
x = Inf, y = max(patch_core_cumulative$cumulative_core_area, na.rm = TRUE),
label = "cumulative core area", color = "darkorange",
hjust = 1.1, vjust = -0.5, size = 3.5
) +
annotate(
"text",
x = Inf, y = max(patch_outer_cumulative$cumulative_outer_area, na.rm = TRUE),
label = "cumulative outer area", color = "grey40",
hjust = 1.1, vjust = -0.5, size = 3.5
)
# -------------------------------------------------------------------
# Only high severity
# Patch sizes
# -------------------------------------------------------------------
# Binning 'n' and preparing the dataset
patch_metrics_mega <- patch_metrics_mega %>%
mutate(
n_bins = cut(
n,
breaks = c(1, 100, 1000, 10000, 1500000),
labels = c("small", "medium", "large", "very large"),
include.lowest = TRUE
)
)
patch_metrics_mega$area_ha       <- patch_metrics_mega$n * 0.09
patch_metrics_mega$outer_area_ha <- patch_metrics_mega$area_ha - patch_metrics_mega$core_area
patch_metrics_mega_sev <- patch_metrics_mega %>%
filter(rdnbr_class == 3)
# Step 1: Pivot to long format for stacked bars
patch_long <- patch_metrics_mega_sev %>%
pivot_longer(
cols      = c(core_area, outer_area_ha),
names_to  = "area_type",
values_to = "area_val"      # ← renamed from area_ha
)
# Step 2: Summarise total area and patch count per n_bins
patch_summary <- patch_long %>%
group_by(n_bins, area_type) %>%
summarise(total_area = sum(area_val, na.rm = TRUE), .groups = "drop")
# Step 3: Calculate cumulative total area and counts per bin (regardless of type)
patch_counts <- patch_metrics_mega_sev %>%
group_by(n_bins) %>%
summarise(count = n(), .groups = "drop")
patch_totals <- patch_summary %>%
group_by(n_bins) %>%
summarise(total_area_sum = sum(total_area), .groups = "drop") %>%
left_join(patch_counts, by = "n_bins") %>%
arrange(as.numeric(n_bins)) %>%
mutate(cumulative_area = cumsum(total_area_sum))
patch_core_cumulative <- patch_summary %>%
filter(area_type == "core_area") %>%
arrange(as.numeric(n_bins)) %>%
group_by(n_bins) %>%
summarise(core_area_total = sum(total_area, na.rm = TRUE), .groups = "drop") %>%
mutate(cumulative_core_area = cumsum(core_area_total))
patch_outer_cumulative <- patch_summary %>%
filter(area_type == "outer_area_ha") %>%
arrange(as.numeric(n_bins)) %>%
group_by(n_bins) %>%
summarise(outer_area_total = sum(total_area, na.rm = TRUE), .groups = "drop") %>%
mutate(cumulative_outer_area = cumsum(outer_area_total))
# Step 4: Plot
cum_2 <- ggplot(patch_summary, aes(x = as.factor(n_bins), y = total_area, fill = area_type)) +
geom_bar(stat = "identity") +
# Add count labels (from patch_totals)
geom_text(
data = patch_totals,
aes(x = as.factor(n_bins), y = total_area_sum, label = comma(count)),
vjust = -0.5, size = 3.5, inherit.aes = FALSE
) +
# Add cumulative area line (also from patch_totals)
geom_line(
data = patch_totals,
aes(x = as.factor(n_bins), y = cumulative_area, group = 1),  # ← only aesthetics in patch_totals
color = "darkred", size = 1, inherit.aes = FALSE
) +
geom_point(
data = patch_totals,
aes(x = as.factor(n_bins), y = cumulative_area),
color = "darkred", size = 2, inherit.aes = FALSE
) +
scale_fill_manual(
values = c("core_area" = "orange", "outer_area_ha" = "lightgrey"),
labels = c("core_area" = "core area", "outer_area_ha" = "outer area"),
name   = NULL  # This removes the title
) +
scale_y_continuous(labels = comma) +
labs(
title = "",
x     = "Patch size",
y     = "Total area (ha)",
fill  = "Area type"
) +
theme_classic() +
theme(
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
axis.text.x      = element_text(angle = 0, hjust = 1)
) +
# Add second cumulative line for core area
geom_line(
data = patch_core_cumulative,
aes(x = as.factor(n_bins), y = cumulative_core_area, group = 1),
color = "darkorange", size = 1, inherit.aes = FALSE, linetype = "dashed"
) +
geom_point(
data = patch_core_cumulative,
aes(x = as.factor(n_bins), y = cumulative_core_area),
color = "darkorange", size = 2, inherit.aes = FALSE
) +
# Add cumulative line for outer area
geom_line(
data = patch_outer_cumulative,
aes(x = as.factor(n_bins), y = cumulative_outer_area, group = 1),
color = "grey40", size = 1, inherit.aes = FALSE, linetype = "dashed"
) +
geom_point(
data = patch_outer_cumulative,
aes(x = as.factor(n_bins), y = cumulative_outer_area),
color = "grey40", size = 2, inherit.aes = FALSE
) +
annotate(
"text",
x = Inf, y = max(patch_totals$cumulative_area, na.rm = TRUE),
label = "cumulative total area", color = "darkred",
hjust = 1.1, vjust = -0.5, size = 3.5
) +
annotate(
"text",
x = Inf, y = max(patch_core_cumulative$cumulative_core_area, na.rm = TRUE),
label = "cumulative core area", color = "darkorange",
hjust = 1.1, vjust = -0.5, size = 3.5
) +
annotate(
"text",
x = Inf, y = max(patch_outer_cumulative$cumulative_outer_area, na.rm = TRUE),
label = "cumulative outer area", color = "grey40",
hjust = 1.1, vjust = -0.5, size = 3.5
)
cum_2
# Function to calculate AWMPS for a given set of patch areas
calculate_awmps <- function(patch_areas) {
total_area <- sum(patch_areas)
awmps <- sum(patch_areas^2) / total_area
return(awmps)
}
# Create an empty dataframe with three columns
patch_size_aw_mega <- data.frame(
rdnbr_class = integer(),
AWMPS = numeric(),
OBJECTID = integer()
)
for (i in megafire_IDs){
patch_metrics_indiv <- patch_metrics_mega %>%
filter(OBJECTID == i)
# Calculate AWMPS for each class
awmps_by_class <- patch_metrics_indiv %>%
group_by(rdnbr_class) %>%
summarise(AWMPS = calculate_awmps(n))
awmps_by_class$OBJECTID <- i
patch_size_aw_mega <- rbind(patch_size_aw_mega, awmps_by_class)
}
patch_size_aw_mega <- patch_size_aw_mega %>%
filter(rdnbr_class != -1)
patch_size_aw_mega$rdnbr_class <- as.character(patch_size_aw_mega$rdnbr_class)
# Recode the rdnbr_class values
patch_size_aw_mega <- patch_size_aw_mega %>%
dplyr::mutate(rdnbr_class = dplyr::recode(rdnbr_class,
"1" = "low",
"2" = "moderate",
"3" = "severe"))
patch_size_aw_mega$awmps_ha <- patch_size_aw_mega$AWMPS*0.09
# -------------------------------------------------------------------
# Function to calculate AWMPS for a given set of patch areas
# -------------------------------------------------------------------
calculate_awmps <- function(patch_areas) {
total_area <- sum(patch_areas)
awmps <- sum(patch_areas^2) / total_area
return(awmps)
}
# -------------------------------------------------------------------
# Create empty dataframe to store results
# -------------------------------------------------------------------
patch_size_aw_mega <- data.frame(
rdnbr_class = integer(),
AWMPS       = numeric(),
OBJECTID    = integer()
)
# -------------------------------------------------------------------
# Loop through each megafire ID and calculate AWMPS
# -------------------------------------------------------------------
for (i in megafire_IDs) {
patch_metrics_indiv <- patch_metrics_mega %>%
filter(OBJECTID == i)
# Calculate AWMPS for each severity class
awmps_by_class <- patch_metrics_indiv %>%
group_by(rdnbr_class) %>%
summarise(AWMPS = calculate_awmps(n), .groups = "drop")
awmps_by_class$OBJECTID <- i
patch_size_aw_mega <- rbind(patch_size_aw_mega, awmps_by_class)
}
# -------------------------------------------------------------------
# Clean and recode severity classes
# -------------------------------------------------------------------
patch_size_aw_mega <- patch_size_aw_mega %>%
filter(rdnbr_class != -1) %>%
mutate(
rdnbr_class = as.character(rdnbr_class),
rdnbr_class = recode(
rdnbr_class,
"1" = "low",
"2" = "moderate",
"3" = "severe"
),
awmps_ha = AWMPS * 0.09
)
# -------------------------------------------------------------------
# Clean and recode severity classes
# -------------------------------------------------------------------
patch_size_aw_mega <- patch_size_aw_mega %>%
filter(rdnbr_class != -1) %>%
dplyr::mutate(
rdnbr_class = as.character(rdnbr_class),
rdnbr_class = recode(
rdnbr_class,
"1" = "low",
"2" = "moderate",
"3" = "severe"
),
awmps_ha = AWMPS * 0.09
)
# Function to calculate AWMPS for a given set of patch areas
calculate_awmps <- function(patch_areas) {
total_area <- sum(patch_areas)
awmps <- sum(patch_areas^2) / total_area
return(awmps)
}
# Create an empty dataframe with three columns
patch_size_aw_mega <- data.frame(
rdnbr_class = integer(),
AWMPS = numeric(),
OBJECTID = integer()
)
for (i in megafire_IDs){
patch_metrics_indiv <- patch_metrics_mega %>%
filter(OBJECTID == i)
# Calculate AWMPS for each class
awmps_by_class <- patch_metrics_indiv %>%
group_by(rdnbr_class) %>%
summarise(AWMPS = calculate_awmps(n))
awmps_by_class$OBJECTID <- i
patch_size_aw_mega <- rbind(patch_size_aw_mega, awmps_by_class)
}
patch_size_aw_mega <- patch_size_aw_mega %>%
filter(rdnbr_class != -1)
patch_size_aw_mega$rdnbr_class <- as.character(patch_size_aw_mega$rdnbr_class)
# Recode the rdnbr_class values
patch_size_aw_mega <- patch_size_aw_mega %>%
dplyr::mutate(rdnbr_class = dplyr::recode(rdnbr_class,
"1" = "low",
"2" = "moderate",
"3" = "severe"))
patch_size_aw_mega$awmps_ha <- patch_size_aw_mega$AWMPS*0.09
calculate_awmps <- function(patch_areas) {
total_area <- sum(patch_areas)
awmps <- sum(patch_areas^2) / total_area
return(awmps)
}
# -------------------------------------------------------------------
# Create empty dataframe to store results
# -------------------------------------------------------------------
patch_size_aw_mega <- data.frame(
rdnbr_class = integer(),
AWMPS       = numeric(),
OBJECTID    = integer()
)
# -------------------------------------------------------------------
# Loop through each megafire ID and calculate AWMPS
# -------------------------------------------------------------------
for (i in megafire_IDs) {
patch_metrics_indiv <- patch_metrics_mega %>%
filter(OBJECTID == i)
# Calculate AWMPS for each severity class
awmps_by_class <- patch_metrics_indiv %>%
group_by(rdnbr_class) %>%
summarise(AWMPS = calculate_awmps(n), .groups = "drop")
awmps_by_class$OBJECTID <- i
patch_size_aw_mega <- rbind(patch_size_aw_mega, awmps_by_class)
}
# -------------------------------------------------------------------
# Clean and recode severity classes
# -------------------------------------------------------------------
patch_size_aw_mega <- patch_size_aw_mega %>%
filter(rdnbr_class != -1) %>%
mutate(
rdnbr_class = as.character(rdnbr_class),
rdnbr_class = recode(
rdnbr_class,
"1" = "low",
"2" = "moderate",
"3" = "severe"
),
awmps_ha = AWMPS * 0.09
)
# -------------------------------------------------------------------
# Clean and recode severity classes
# -------------------------------------------------------------------
patch_size_aw_mega <- patch_size_aw_mega %>%
filter(rdnbr_class != -1) %>%
mutate(
rdnbr_class = as.character(rdnbr_class),
rdnbr_class = dplyr::recode(
rdnbr_class,
"1" = "low",
"2" = "moderate",
"3" = "severe"
),
awmps_ha = AWMPS * 0.09
)
here()
# -------------------------------------------------------------------
# Calculate the LPI for every class in every megafire
# -------------------------------------------------------------------
# Path to classified RdNBR rasters
raster_dir <- paste0(here(),"Data/Rasters/RdNBR_classified")
# List all .tif raster files in the folder
raster_files <- fs::dir_ls(raster_dir, regexp = "\\.tif$")
# Path to classified RdNBR rasters
raster_dir <- paste0(here(),"Data/Rasters/RdNBR_classified")
raster_dir
# Path to classified RdNBR rasters
raster_dir <- paste0(here(),"/Data/Rasters/RdNBR_classified")
# List all .tif raster files in the folder
raster_files <- fs::dir_ls(raster_dir, regexp = "\\.tif$")
# Function to calculate LPI per class for a raster
calculate_lpi <- function(file_path) {
# Load raster
rast_obj <- terra::rast(file_path)
# Convert to RasterLayer (landscapemetrics prefers Raster*)
rast_r <- raster::raster(rast_obj)
# Calculate LPI for each class
lpi_result <- landscapemetrics::lsm_c_lpi(rast_r)
# Add raster name to identify the source
lpi_result$raster_name <- basename(file_path)
lpi_result
}
# Apply to all rasters and combine
lpi_list <- lapply(raster_files, calculate_lpi)
# Apply to all rasters and combine
lpi_list <- lapply(raster_files, calculate_lpi)
lpi_df   <- dplyr::bind_rows(lpi_list)
# Step 1: Extract fire ID from raster_name and join fire names
lpi_df <- lpi_df %>%
dplyr::mutate(
OBJECTID = as.numeric(stringr::str_remove(raster_name, "\\.tif$"))
) %>%
dplyr::left_join(
fire_metrics_mega %>% dplyr::select(OBJECTID, FIRE_NAME),
by = "OBJECTID"
)
# Step 2: Recode class into labels
lpi_df <- lpi_df %>%
dplyr::mutate(
class_label = dplyr::case_when(
class == 0 ~ "Unchanged",
class == 1 ~ "Low",
class == 2 ~ "Moderate",
class == 3 ~ "High",
TRUE       ~ as.character(class)
)
)
# Step 3: Summarise to one row per fire with total value per class
lpi_summary <- lpi_df %>%
dplyr::group_by(FIRE_NAME, class_label) %>%
dplyr::summarise(total_value = sum(value, na.rm = TRUE), .groups = "drop") %>%
tidyr::pivot_wider(
names_from  = class_label,
values_from = total_value
) %>%
dplyr::rename(`Fire name` = FIRE_NAME) %>%
dplyr::select(`Fire name`, Unchanged, Low, Moderate, High) %>%
dplyr::left_join(
fire_metrics_mega %>% dplyr::select(FIRE_NAME, YEAR_),
by = c("Fire name" = "FIRE_NAME")
) %>%
dplyr::rename(`Fire year` = YEAR_) %>%
dplyr::select(`Fire name`, `Fire year`, Unchanged, Low, Moderate, High)
lpi_summary
# Write CSV
data.table::fwrite(
lpi_summary, paste0(here(),"/Outputs/LPI_all_megafires.csv")
)
